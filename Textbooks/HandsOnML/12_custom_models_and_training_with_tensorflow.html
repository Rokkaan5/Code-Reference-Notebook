<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.542">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Chapter 12 – Custom Models and Training with TensorFlow</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="12_custom_models_and_training_with_tensorflow_files/libs/clipboard/clipboard.min.js"></script>
<script src="12_custom_models_and_training_with_tensorflow_files/libs/quarto-html/quarto.js"></script>
<script src="12_custom_models_and_training_with_tensorflow_files/libs/quarto-html/popper.min.js"></script>
<script src="12_custom_models_and_training_with_tensorflow_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="12_custom_models_and_training_with_tensorflow_files/libs/quarto-html/anchor.min.js"></script>
<link href="12_custom_models_and_training_with_tensorflow_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="12_custom_models_and_training_with_tensorflow_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="12_custom_models_and_training_with_tensorflow_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="12_custom_models_and_training_with_tensorflow_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="12_custom_models_and_training_with_tensorflow_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>
<script src="https://unpkg.com/@jupyter-widgets/html-manager@*/dist/embed-amd.js" crossorigin="anonymous"></script>


</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#setup" id="toc-setup" class="nav-link active" data-scroll-target="#setup">Setup</a>
  <ul class="collapse">
  <li><a href="#tensors-and-operations" id="toc-tensors-and-operations" class="nav-link" data-scroll-target="#tensors-and-operations">Tensors and operations</a>
  <ul class="collapse">
  <li><a href="#tensors" id="toc-tensors" class="nav-link" data-scroll-target="#tensors">Tensors</a></li>
  <li><a href="#indexing" id="toc-indexing" class="nav-link" data-scroll-target="#indexing">Indexing</a></li>
  <li><a href="#ops" id="toc-ops" class="nav-link" data-scroll-target="#ops">Ops</a></li>
  <li><a href="#using-keras.backend" id="toc-using-keras.backend" class="nav-link" data-scroll-target="#using-keras.backend">Using <code>keras.backend</code></a></li>
  <li><a href="#fromto-numpy" id="toc-fromto-numpy" class="nav-link" data-scroll-target="#fromto-numpy">From/To NumPy</a></li>
  <li><a href="#conflicting-types" id="toc-conflicting-types" class="nav-link" data-scroll-target="#conflicting-types">Conflicting Types</a></li>
  <li><a href="#strings" id="toc-strings" class="nav-link" data-scroll-target="#strings">Strings</a></li>
  <li><a href="#string-arrays" id="toc-string-arrays" class="nav-link" data-scroll-target="#string-arrays">String arrays</a></li>
  <li><a href="#ragged-tensors" id="toc-ragged-tensors" class="nav-link" data-scroll-target="#ragged-tensors">Ragged tensors</a></li>
  <li><a href="#sparse-tensors" id="toc-sparse-tensors" class="nav-link" data-scroll-target="#sparse-tensors">Sparse tensors</a></li>
  <li><a href="#sets" id="toc-sets" class="nav-link" data-scroll-target="#sets">Sets</a></li>
  <li><a href="#variables" id="toc-variables" class="nav-link" data-scroll-target="#variables">Variables</a></li>
  <li><a href="#tensor-arrays" id="toc-tensor-arrays" class="nav-link" data-scroll-target="#tensor-arrays">Tensor Arrays</a></li>
  </ul></li>
  <li><a href="#custom-loss-function" id="toc-custom-loss-function" class="nav-link" data-scroll-target="#custom-loss-function">Custom loss function</a></li>
  <li><a href="#savingloading-models-with-custom-objects" id="toc-savingloading-models-with-custom-objects" class="nav-link" data-scroll-target="#savingloading-models-with-custom-objects">Saving/Loading Models with Custom Objects</a></li>
  <li><a href="#other-custom-functions" id="toc-other-custom-functions" class="nav-link" data-scroll-target="#other-custom-functions">Other Custom Functions</a></li>
  <li><a href="#custom-metrics" id="toc-custom-metrics" class="nav-link" data-scroll-target="#custom-metrics">Custom Metrics</a>
  <ul class="collapse">
  <li><a href="#streaming-metrics" id="toc-streaming-metrics" class="nav-link" data-scroll-target="#streaming-metrics">Streaming metrics</a></li>
  </ul></li>
  <li><a href="#custom-layers" id="toc-custom-layers" class="nav-link" data-scroll-target="#custom-layers">Custom Layers</a></li>
  <li><a href="#custom-models" id="toc-custom-models" class="nav-link" data-scroll-target="#custom-models">Custom Models</a></li>
  <li><a href="#losses-and-metrics-based-on-model-internals" id="toc-losses-and-metrics-based-on-model-internals" class="nav-link" data-scroll-target="#losses-and-metrics-based-on-model-internals">Losses and Metrics Based on Model Internals</a></li>
  <li><a href="#computing-gradients-with-autodiff" id="toc-computing-gradients-with-autodiff" class="nav-link" data-scroll-target="#computing-gradients-with-autodiff">Computing Gradients with Autodiff</a></li>
  </ul></li>
  <li><a href="#custom-training-loops" id="toc-custom-training-loops" class="nav-link" data-scroll-target="#custom-training-loops">Custom Training Loops</a>
  <ul class="collapse">
  <li><a href="#tensorflow-functions" id="toc-tensorflow-functions" class="nav-link" data-scroll-target="#tensorflow-functions">TensorFlow Functions</a>
  <ul class="collapse">
  <li><a href="#tf-functions-and-concrete-functions" id="toc-tf-functions-and-concrete-functions" class="nav-link" data-scroll-target="#tf-functions-and-concrete-functions">TF Functions and Concrete Functions</a></li>
  <li><a href="#exploring-function-definitions-and-graphs" id="toc-exploring-function-definitions-and-graphs" class="nav-link" data-scroll-target="#exploring-function-definitions-and-graphs">Exploring Function Definitions and Graphs</a></li>
  <li><a href="#how-tf-functions-trace-python-functions-to-extract-their-computation-graphs" id="toc-how-tf-functions-trace-python-functions-to-extract-their-computation-graphs" class="nav-link" data-scroll-target="#how-tf-functions-trace-python-functions-to-extract-their-computation-graphs">How TF Functions Trace Python Functions to Extract Their Computation Graphs</a></li>
  <li><a href="#using-autograph-to-capture-control-flow" id="toc-using-autograph-to-capture-control-flow" class="nav-link" data-scroll-target="#using-autograph-to-capture-control-flow">Using Autograph To Capture Control Flow</a></li>
  <li><a href="#handling-variables-and-other-resources-in-tf-functions" id="toc-handling-variables-and-other-resources-in-tf-functions" class="nav-link" data-scroll-target="#handling-variables-and-other-resources-in-tf-functions">Handling Variables and Other Resources in TF Functions</a></li>
  </ul></li>
  <li><a href="#using-tf-functions-with-tf.keras-or-not" id="toc-using-tf-functions-with-tf.keras-or-not" class="nav-link" data-scroll-target="#using-tf-functions-with-tf.keras-or-not">Using TF Functions with tf.keras (or Not)</a></li>
  <li><a href="#custom-optimizers" id="toc-custom-optimizers" class="nav-link" data-scroll-target="#custom-optimizers">Custom Optimizers</a></li>
  </ul></li>
  <li><a href="#exercises" id="toc-exercises" class="nav-link" data-scroll-target="#exercises">Exercises</a>
  <ul class="collapse">
  <li><a href="#to-11." id="toc-to-11." class="nav-link" data-scroll-target="#to-11.">1. to 11.</a></li>
  <li><a href="#implement-a-custom-layer-that-performs-layer-normalization" id="toc-implement-a-custom-layer-that-performs-layer-normalization" class="nav-link" data-scroll-target="#implement-a-custom-layer-that-performs-layer-normalization">12. Implement a custom layer that performs <em>Layer Normalization</em></a>
  <ul class="collapse">
  <li><a href="#a." id="toc-a." class="nav-link" data-scroll-target="#a.">a.</a></li>
  <li><a href="#b." id="toc-b." class="nav-link" data-scroll-target="#b.">b.</a></li>
  <li><a href="#c." id="toc-c." class="nav-link" data-scroll-target="#c.">c.</a></li>
  </ul></li>
  <li><a href="#train-a-model-using-a-custom-training-loop-to-tackle-the-fashion-mnist-dataset" id="toc-train-a-model-using-a-custom-training-loop-to-tackle-the-fashion-mnist-dataset" class="nav-link" data-scroll-target="#train-a-model-using-a-custom-training-loop-to-tackle-the-fashion-mnist-dataset">13. Train a model using a custom training loop to tackle the Fashion MNIST dataset</a>
  <ul class="collapse">
  <li><a href="#a.-1" id="toc-a.-1" class="nav-link" data-scroll-target="#a.-1">a.</a></li>
  <li><a href="#b.-1" id="toc-b.-1" class="nav-link" data-scroll-target="#b.-1">b.</a></li>
  </ul></li>
  </ul></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Chapter 12 – Custom Models and Training with TensorFlow</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p><em>This notebook contains all the sample code in chapter 12.</em></p>
<section id="setup" class="level1">
<h1>Setup</h1>
<p>First, let’s import a few common modules, ensure MatplotLib plots figures inline and prepare a function to save the figures. We also check that Python 3.5 or later is installed (although Python 2.x may work, it is deprecated so we strongly recommend you use Python 3 instead), as well as Scikit-Learn ≥0.20 and TensorFlow ≥2.0.</p>
<div id="cell-4" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Python ≥3.5 is required</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> sys.version_info <span class="op">&gt;=</span> (<span class="dv">3</span>, <span class="dv">5</span>)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Scikit-Learn ≥0.20 is required</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sklearn</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> sklearn.__version__ <span class="op">&gt;=</span> <span class="st">"0.20"</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># %tensorflow_version only exists in Colab.</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">%</span>tensorflow_version <span class="fl">2.</span><span class="er">x</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">pass</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="co"># TensorFlow ≥2.4 is required in this notebook</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Earlier 2.x versions will mostly work the same, but with a few bugs</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> tensorflow <span class="im">as</span> tf</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow <span class="im">import</span> keras</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> tf.__version__ <span class="op">&gt;=</span> <span class="st">"2.4"</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Common imports</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="co"># to make this notebook's output stable across runs</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">42</span>)</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>tf.random.set_seed(<span class="dv">42</span>)</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a><span class="co"># To plot pretty figures</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>matplotlib inline</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib <span class="im">as</span> mpl</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>mpl.rc(<span class="st">'axes'</span>, labelsize<span class="op">=</span><span class="dv">14</span>)</span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>mpl.rc(<span class="st">'xtick'</span>, labelsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>mpl.rc(<span class="st">'ytick'</span>, labelsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Where to save the figures</span></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>PROJECT_ROOT_DIR <span class="op">=</span> <span class="st">"."</span></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>CHAPTER_ID <span class="op">=</span> <span class="st">"deep"</span></span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>IMAGES_PATH <span class="op">=</span> os.path.join(PROJECT_ROOT_DIR, <span class="st">"images"</span>, CHAPTER_ID)</span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>os.makedirs(IMAGES_PATH, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> save_fig(fig_id, tight_layout<span class="op">=</span><span class="va">True</span>, fig_extension<span class="op">=</span><span class="st">"png"</span>, resolution<span class="op">=</span><span class="dv">300</span>):</span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>    path <span class="op">=</span> os.path.join(IMAGES_PATH, fig_id <span class="op">+</span> <span class="st">"."</span> <span class="op">+</span> fig_extension)</span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Saving figure"</span>, fig_id)</span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> tight_layout:</span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a>        plt.tight_layout()</span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>    plt.savefig(path, <span class="bu">format</span><span class="op">=</span>fig_extension, dpi<span class="op">=</span>resolution)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="tensors-and-operations" class="level2">
<h2 class="anchored" data-anchor-id="tensors-and-operations">Tensors and operations</h2>
<section id="tensors" class="level3">
<h3 class="anchored" data-anchor-id="tensors">Tensors</h3>
<div id="cell-7" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>tf.constant([[<span class="fl">1.</span>, <span class="fl">2.</span>, <span class="fl">3.</span>], [<span class="fl">4.</span>, <span class="fl">5.</span>, <span class="fl">6.</span>]]) <span class="co"># matrix</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="2">
<pre><code>&lt;tf.Tensor: shape=(2, 3), dtype=float32, numpy=
array([[1., 2., 3.],
       [4., 5., 6.]], dtype=float32)&gt;</code></pre>
</div>
</div>
<div id="cell-8" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>tf.constant(<span class="dv">42</span>) <span class="co"># scalar</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<pre><code>&lt;tf.Tensor: shape=(), dtype=int32, numpy=42&gt;</code></pre>
</div>
</div>
<div id="cell-9" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>t <span class="op">=</span> tf.constant([[<span class="fl">1.</span>, <span class="fl">2.</span>, <span class="fl">3.</span>], [<span class="fl">4.</span>, <span class="fl">5.</span>, <span class="fl">6.</span>]])</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>t</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="4">
<pre><code>&lt;tf.Tensor: shape=(2, 3), dtype=float32, numpy=
array([[1., 2., 3.],
       [4., 5., 6.]], dtype=float32)&gt;</code></pre>
</div>
</div>
<div id="cell-10" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>t.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="5">
<pre><code>TensorShape([2, 3])</code></pre>
</div>
</div>
<div id="cell-11" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>t.dtype</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="6">
<pre><code>tf.float32</code></pre>
</div>
</div>
</section>
<section id="indexing" class="level3">
<h3 class="anchored" data-anchor-id="indexing">Indexing</h3>
<div id="cell-13" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>t[:, <span class="dv">1</span>:]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="7">
<pre><code>&lt;tf.Tensor: shape=(2, 2), dtype=float32, numpy=
array([[2., 3.],
       [5., 6.]], dtype=float32)&gt;</code></pre>
</div>
</div>
<div id="cell-14" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>t[..., <span class="dv">1</span>, tf.newaxis]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="8">
<pre><code>&lt;tf.Tensor: shape=(2, 1), dtype=float32, numpy=
array([[2.],
       [5.]], dtype=float32)&gt;</code></pre>
</div>
</div>
</section>
<section id="ops" class="level3">
<h3 class="anchored" data-anchor-id="ops">Ops</h3>
<div id="cell-16" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>t <span class="op">+</span> <span class="dv">10</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="9">
<pre><code>&lt;tf.Tensor: shape=(2, 3), dtype=float32, numpy=
array([[11., 12., 13.],
       [14., 15., 16.]], dtype=float32)&gt;</code></pre>
</div>
</div>
<div id="cell-17" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>tf.square(t)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="10">
<pre><code>&lt;tf.Tensor: shape=(2, 3), dtype=float32, numpy=
array([[ 1.,  4.,  9.],
       [16., 25., 36.]], dtype=float32)&gt;</code></pre>
</div>
</div>
<div id="cell-18" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>t <span class="op">@</span> tf.transpose(t)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="11">
<pre><code>&lt;tf.Tensor: shape=(2, 2), dtype=float32, numpy=
array([[14., 32.],
       [32., 77.]], dtype=float32)&gt;</code></pre>
</div>
</div>
</section>
<section id="using-keras.backend" class="level3">
<h3 class="anchored" data-anchor-id="using-keras.backend">Using <code>keras.backend</code></h3>
<div id="cell-20" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow <span class="im">import</span> keras</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>K <span class="op">=</span> keras.backend</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>K.square(K.transpose(t)) <span class="op">+</span> <span class="dv">10</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="12">
<pre><code>&lt;tf.Tensor: shape=(3, 2), dtype=float32, numpy=
array([[11., 26.],
       [14., 35.],
       [19., 46.]], dtype=float32)&gt;</code></pre>
</div>
</div>
</section>
<section id="fromto-numpy" class="level3">
<h3 class="anchored" data-anchor-id="fromto-numpy">From/To NumPy</h3>
<div id="cell-22" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>a <span class="op">=</span> np.array([<span class="fl">2.</span>, <span class="fl">4.</span>, <span class="fl">5.</span>])</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>tf.constant(a)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="13">
<pre><code>&lt;tf.Tensor: shape=(3,), dtype=float64, numpy=array([2., 4., 5.])&gt;</code></pre>
</div>
</div>
<div id="cell-23" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>t.numpy()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="14">
<pre><code>array([[1., 2., 3.],
       [4., 5., 6.]], dtype=float32)</code></pre>
</div>
</div>
<div id="cell-24" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>np.array(t)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="15">
<pre><code>array([[1., 2., 3.],
       [4., 5., 6.]], dtype=float32)</code></pre>
</div>
</div>
<div id="cell-25" class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>tf.square(a)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="16">
<pre><code>&lt;tf.Tensor: shape=(3,), dtype=float64, numpy=array([ 4., 16., 25.])&gt;</code></pre>
</div>
</div>
<div id="cell-26" class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>np.square(t)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="17">
<pre><code>array([[ 1.,  4.,  9.],
       [16., 25., 36.]], dtype=float32)</code></pre>
</div>
</div>
</section>
<section id="conflicting-types" class="level3">
<h3 class="anchored" data-anchor-id="conflicting-types">Conflicting Types</h3>
<div id="cell-28" class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>    tf.constant(<span class="fl">2.0</span>) <span class="op">+</span> tf.constant(<span class="dv">40</span>)</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> tf.errors.InvalidArgumentError <span class="im">as</span> ex:</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(ex)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>cannot compute AddV2 as input #1(zero-based) was expected to be a float tensor but is a int32 tensor [Op:AddV2]</code></pre>
</div>
</div>
<div id="cell-29" class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>    tf.constant(<span class="fl">2.0</span>) <span class="op">+</span> tf.constant(<span class="fl">40.</span>, dtype<span class="op">=</span>tf.float64)</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> tf.errors.InvalidArgumentError <span class="im">as</span> ex:</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(ex)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>cannot compute AddV2 as input #1(zero-based) was expected to be a float tensor but is a double tensor [Op:AddV2]</code></pre>
</div>
</div>
<div id="cell-30" class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>t2 <span class="op">=</span> tf.constant(<span class="fl">40.</span>, dtype<span class="op">=</span>tf.float64)</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>tf.constant(<span class="fl">2.0</span>) <span class="op">+</span> tf.cast(t2, tf.float32)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="20">
<pre><code>&lt;tf.Tensor: shape=(), dtype=float32, numpy=42.0&gt;</code></pre>
</div>
</div>
</section>
<section id="strings" class="level3">
<h3 class="anchored" data-anchor-id="strings">Strings</h3>
<div id="cell-32" class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>tf.constant(<span class="st">b"hello world"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="21">
<pre><code>&lt;tf.Tensor: shape=(), dtype=string, numpy=b'hello world'&gt;</code></pre>
</div>
</div>
<div id="cell-33" class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>tf.constant(<span class="st">"café"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="22">
<pre><code>&lt;tf.Tensor: shape=(), dtype=string, numpy=b'caf\xc3\xa9'&gt;</code></pre>
</div>
</div>
<div id="cell-34" class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>u <span class="op">=</span> tf.constant([<span class="bu">ord</span>(c) <span class="cf">for</span> c <span class="kw">in</span> <span class="st">"café"</span>])</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>u</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="23">
<pre><code>&lt;tf.Tensor: shape=(4,), dtype=int32, numpy=array([ 99,  97, 102, 233], dtype=int32)&gt;</code></pre>
</div>
</div>
<div id="cell-35" class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>b <span class="op">=</span> tf.strings.unicode_encode(u, <span class="st">"UTF-8"</span>)</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>tf.strings.length(b, unit<span class="op">=</span><span class="st">"UTF8_CHAR"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="24">
<pre><code>&lt;tf.Tensor: shape=(), dtype=int32, numpy=4&gt;</code></pre>
</div>
</div>
<div id="cell-36" class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>tf.strings.unicode_decode(b, <span class="st">"UTF-8"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="25">
<pre><code>&lt;tf.Tensor: shape=(4,), dtype=int32, numpy=array([ 99,  97, 102, 233], dtype=int32)&gt;</code></pre>
</div>
</div>
</section>
<section id="string-arrays" class="level3">
<h3 class="anchored" data-anchor-id="string-arrays">String arrays</h3>
<div id="cell-38" class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>p <span class="op">=</span> tf.constant([<span class="st">"Café"</span>, <span class="st">"Coffee"</span>, <span class="st">"caffè"</span>, <span class="st">"咖啡"</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-39" class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>tf.strings.length(p, unit<span class="op">=</span><span class="st">"UTF8_CHAR"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="27">
<pre><code>&lt;tf.Tensor: shape=(4,), dtype=int32, numpy=array([4, 6, 5, 2], dtype=int32)&gt;</code></pre>
</div>
</div>
<div id="cell-40" class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> tf.strings.unicode_decode(p, <span class="st">"UTF8"</span>)</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>r</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="28">
<pre><code>&lt;tf.RaggedTensor [[67, 97, 102, 233], [67, 111, 102, 102, 101, 101], [99, 97, 102, 102, 232], [21654, 21857]]&gt;</code></pre>
</div>
</div>
<div id="cell-41" class="cell" data-execution_count="29">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(r)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;tf.RaggedTensor [[67, 97, 102, 233], [67, 111, 102, 102, 101, 101], [99, 97, 102, 102, 232], [21654, 21857]]&gt;</code></pre>
</div>
</div>
</section>
<section id="ragged-tensors" class="level3">
<h3 class="anchored" data-anchor-id="ragged-tensors">Ragged tensors</h3>
<div id="cell-43" class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(r[<span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>tf.Tensor([ 67 111 102 102 101 101], shape=(6,), dtype=int32)</code></pre>
</div>
</div>
<div id="cell-44" class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(r[<span class="dv">1</span>:<span class="dv">3</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;tf.RaggedTensor [[67, 111, 102, 102, 101, 101], [99, 97, 102, 102, 232]]&gt;</code></pre>
</div>
</div>
<div id="cell-45" class="cell" data-execution_count="32">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>r2 <span class="op">=</span> tf.ragged.constant([[<span class="dv">65</span>, <span class="dv">66</span>], [], [<span class="dv">67</span>]])</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(tf.concat([r, r2], axis<span class="op">=</span><span class="dv">0</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;tf.RaggedTensor [[67, 97, 102, 233], [67, 111, 102, 102, 101, 101], [99, 97, 102, 102, 232], [21654, 21857], [65, 66], [], [67]]&gt;</code></pre>
</div>
</div>
<div id="cell-46" class="cell" data-execution_count="33">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>r3 <span class="op">=</span> tf.ragged.constant([[<span class="dv">68</span>, <span class="dv">69</span>, <span class="dv">70</span>], [<span class="dv">71</span>], [], [<span class="dv">72</span>, <span class="dv">73</span>]])</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(tf.concat([r, r3], axis<span class="op">=</span><span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;tf.RaggedTensor [[67, 97, 102, 233, 68, 69, 70], [67, 111, 102, 102, 101, 101, 71], [99, 97, 102, 102, 232], [21654, 21857, 72, 73]]&gt;</code></pre>
</div>
</div>
<div id="cell-47" class="cell" data-execution_count="34">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>tf.strings.unicode_encode(r3, <span class="st">"UTF-8"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="34">
<pre><code>&lt;tf.Tensor: shape=(4,), dtype=string, numpy=array([b'DEF', b'G', b'', b'HI'], dtype=object)&gt;</code></pre>
</div>
</div>
<div id="cell-48" class="cell" data-execution_count="35">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>r.to_tensor()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="35">
<pre><code>&lt;tf.Tensor: shape=(4, 6), dtype=int32, numpy=
array([[   67,    97,   102,   233,     0,     0],
       [   67,   111,   102,   102,   101,   101],
       [   99,    97,   102,   102,   232,     0],
       [21654, 21857,     0,     0,     0,     0]], dtype=int32)&gt;</code></pre>
</div>
</div>
</section>
<section id="sparse-tensors" class="level3">
<h3 class="anchored" data-anchor-id="sparse-tensors">Sparse tensors</h3>
<div id="cell-50" class="cell" data-execution_count="36">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>s <span class="op">=</span> tf.SparseTensor(indices<span class="op">=</span>[[<span class="dv">0</span>, <span class="dv">1</span>], [<span class="dv">1</span>, <span class="dv">0</span>], [<span class="dv">2</span>, <span class="dv">3</span>]],</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>                    values<span class="op">=</span>[<span class="fl">1.</span>, <span class="fl">2.</span>, <span class="fl">3.</span>],</span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>                    dense_shape<span class="op">=</span>[<span class="dv">3</span>, <span class="dv">4</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-51" class="cell" data-execution_count="37">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(s)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>SparseTensor(indices=tf.Tensor(
[[0 1]
 [1 0]
 [2 3]], shape=(3, 2), dtype=int64), values=tf.Tensor([1. 2. 3.], shape=(3,), dtype=float32), dense_shape=tf.Tensor([3 4], shape=(2,), dtype=int64))</code></pre>
</div>
</div>
<div id="cell-52" class="cell" data-execution_count="38">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>tf.sparse.to_dense(s)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="38">
<pre><code>&lt;tf.Tensor: shape=(3, 4), dtype=float32, numpy=
array([[0., 1., 0., 0.],
       [2., 0., 0., 0.],
       [0., 0., 0., 3.]], dtype=float32)&gt;</code></pre>
</div>
</div>
<div id="cell-53" class="cell" data-execution_count="39">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>s2 <span class="op">=</span> s <span class="op">*</span> <span class="fl">2.0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-54" class="cell" data-execution_count="40">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>    s3 <span class="op">=</span> s <span class="op">+</span> <span class="fl">1.</span></span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">TypeError</span> <span class="im">as</span> ex:</span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(ex)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>unsupported operand type(s) for +: 'SparseTensor' and 'float'</code></pre>
</div>
</div>
<div id="cell-55" class="cell" data-execution_count="41">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>s4 <span class="op">=</span> tf.constant([[<span class="fl">10.</span>, <span class="fl">20.</span>], [<span class="fl">30.</span>, <span class="fl">40.</span>], [<span class="fl">50.</span>, <span class="fl">60.</span>], [<span class="fl">70.</span>, <span class="fl">80.</span>]])</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>tf.sparse.sparse_dense_matmul(s, s4)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="41">
<pre><code>&lt;tf.Tensor: shape=(3, 2), dtype=float32, numpy=
array([[ 30.,  40.],
       [ 20.,  40.],
       [210., 240.]], dtype=float32)&gt;</code></pre>
</div>
</div>
<div id="cell-56" class="cell" data-execution_count="42">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>s5 <span class="op">=</span> tf.SparseTensor(indices<span class="op">=</span>[[<span class="dv">0</span>, <span class="dv">2</span>], [<span class="dv">0</span>, <span class="dv">1</span>]],</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>                     values<span class="op">=</span>[<span class="fl">1.</span>, <span class="fl">2.</span>],</span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>                     dense_shape<span class="op">=</span>[<span class="dv">3</span>, <span class="dv">4</span>])</span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(s5)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>SparseTensor(indices=tf.Tensor(
[[0 2]
 [0 1]], shape=(2, 2), dtype=int64), values=tf.Tensor([1. 2.], shape=(2,), dtype=float32), dense_shape=tf.Tensor([3 4], shape=(2,), dtype=int64))</code></pre>
</div>
</div>
<div id="cell-57" class="cell" data-execution_count="43">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>    tf.sparse.to_dense(s5)</span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> tf.errors.InvalidArgumentError <span class="im">as</span> ex:</span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(ex)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>indices[1] = [0,1] is out of order. Many sparse ops require sorted indices.
    Use `tf.sparse.reorder` to create a correctly ordered copy.

 [Op:SparseToDense]</code></pre>
</div>
</div>
<div id="cell-58" class="cell" data-execution_count="44">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>s6 <span class="op">=</span> tf.sparse.reorder(s5)</span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>tf.sparse.to_dense(s6)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="44">
<pre><code>&lt;tf.Tensor: shape=(3, 4), dtype=float32, numpy=
array([[0., 2., 1., 0.],
       [0., 0., 0., 0.],
       [0., 0., 0., 0.]], dtype=float32)&gt;</code></pre>
</div>
</div>
</section>
<section id="sets" class="level3">
<h3 class="anchored" data-anchor-id="sets">Sets</h3>
<div id="cell-60" class="cell" data-execution_count="45">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>set1 <span class="op">=</span> tf.constant([[<span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">5</span>, <span class="dv">7</span>], [<span class="dv">7</span>, <span class="dv">9</span>, <span class="dv">0</span>, <span class="dv">0</span>]])</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>set2 <span class="op">=</span> tf.constant([[<span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">6</span>], [<span class="dv">9</span>, <span class="dv">10</span>, <span class="dv">0</span>]])</span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>tf.sparse.to_dense(tf.sets.union(set1, set2))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="45">
<pre><code>&lt;tf.Tensor: shape=(2, 6), dtype=int32, numpy=
array([[ 2,  3,  4,  5,  6,  7],
       [ 0,  7,  9, 10,  0,  0]], dtype=int32)&gt;</code></pre>
</div>
</div>
<div id="cell-61" class="cell" data-execution_count="46">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>tf.sparse.to_dense(tf.sets.difference(set1, set2))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="46">
<pre><code>&lt;tf.Tensor: shape=(2, 3), dtype=int32, numpy=
array([[2, 3, 7],
       [7, 0, 0]], dtype=int32)&gt;</code></pre>
</div>
</div>
<div id="cell-62" class="cell" data-execution_count="47">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>tf.sparse.to_dense(tf.sets.intersection(set1, set2))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="47">
<pre><code>&lt;tf.Tensor: shape=(2, 2), dtype=int32, numpy=
array([[5, 0],
       [0, 9]], dtype=int32)&gt;</code></pre>
</div>
</div>
</section>
<section id="variables" class="level3">
<h3 class="anchored" data-anchor-id="variables">Variables</h3>
<div id="cell-64" class="cell" data-execution_count="48">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a>v <span class="op">=</span> tf.Variable([[<span class="fl">1.</span>, <span class="fl">2.</span>, <span class="fl">3.</span>], [<span class="fl">4.</span>, <span class="fl">5.</span>, <span class="fl">6.</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-65" class="cell" data-execution_count="49">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>v.assign(<span class="dv">2</span> <span class="op">*</span> v)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="49">
<pre><code>&lt;tf.Variable 'UnreadVariable' shape=(2, 3) dtype=float32, numpy=
array([[ 2.,  4.,  6.],
       [ 8., 10., 12.]], dtype=float32)&gt;</code></pre>
</div>
</div>
<div id="cell-66" class="cell" data-execution_count="50">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>v[<span class="dv">0</span>, <span class="dv">1</span>].assign(<span class="dv">42</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="50">
<pre><code>&lt;tf.Variable 'UnreadVariable' shape=(2, 3) dtype=float32, numpy=
array([[ 2., 42.,  6.],
       [ 8., 10., 12.]], dtype=float32)&gt;</code></pre>
</div>
</div>
<div id="cell-67" class="cell" data-execution_count="51">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a>v[:, <span class="dv">2</span>].assign([<span class="fl">0.</span>, <span class="fl">1.</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="51">
<pre><code>&lt;tf.Variable 'UnreadVariable' shape=(2, 3) dtype=float32, numpy=
array([[ 2., 42.,  0.],
       [ 8., 10.,  1.]], dtype=float32)&gt;</code></pre>
</div>
</div>
<div id="cell-68" class="cell" data-execution_count="52">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a>    v[<span class="dv">1</span>] <span class="op">=</span> [<span class="fl">7.</span>, <span class="fl">8.</span>, <span class="fl">9.</span>]</span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">TypeError</span> <span class="im">as</span> ex:</span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(ex)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>'ResourceVariable' object does not support item assignment</code></pre>
</div>
</div>
<div id="cell-69" class="cell" data-execution_count="53">
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a>v.scatter_nd_update(indices<span class="op">=</span>[[<span class="dv">0</span>, <span class="dv">0</span>], [<span class="dv">1</span>, <span class="dv">2</span>]],</span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a>                    updates<span class="op">=</span>[<span class="fl">100.</span>, <span class="fl">200.</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="53">
<pre><code>&lt;tf.Variable 'UnreadVariable' shape=(2, 3) dtype=float32, numpy=
array([[100.,  42.,   0.],
       [  8.,  10., 200.]], dtype=float32)&gt;</code></pre>
</div>
</div>
<div id="cell-70" class="cell" data-execution_count="54">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a>sparse_delta <span class="op">=</span> tf.IndexedSlices(values<span class="op">=</span>[[<span class="fl">1.</span>, <span class="fl">2.</span>, <span class="fl">3.</span>], [<span class="fl">4.</span>, <span class="fl">5.</span>, <span class="fl">6.</span>]],</span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>                                indices<span class="op">=</span>[<span class="dv">1</span>, <span class="dv">0</span>])</span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a>v.scatter_update(sparse_delta)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="54">
<pre><code>&lt;tf.Variable 'UnreadVariable' shape=(2, 3) dtype=float32, numpy=
array([[4., 5., 6.],
       [1., 2., 3.]], dtype=float32)&gt;</code></pre>
</div>
</div>
</section>
<section id="tensor-arrays" class="level3">
<h3 class="anchored" data-anchor-id="tensor-arrays">Tensor Arrays</h3>
<div id="cell-72" class="cell" data-execution_count="55">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a>array <span class="op">=</span> tf.TensorArray(dtype<span class="op">=</span>tf.float32, size<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a>array <span class="op">=</span> array.write(<span class="dv">0</span>, tf.constant([<span class="fl">1.</span>, <span class="fl">2.</span>]))</span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a>array <span class="op">=</span> array.write(<span class="dv">1</span>, tf.constant([<span class="fl">3.</span>, <span class="fl">10.</span>]))</span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a>array <span class="op">=</span> array.write(<span class="dv">2</span>, tf.constant([<span class="fl">5.</span>, <span class="fl">7.</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-73" class="cell" data-execution_count="56">
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a>array.read(<span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="56">
<pre><code>&lt;tf.Tensor: shape=(2,), dtype=float32, numpy=array([ 3., 10.], dtype=float32)&gt;</code></pre>
</div>
</div>
<div id="cell-74" class="cell" data-execution_count="57">
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a>array.stack()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="57">
<pre><code>&lt;tf.Tensor: shape=(3, 2), dtype=float32, numpy=
array([[1., 2.],
       [0., 0.],
       [5., 7.]], dtype=float32)&gt;</code></pre>
</div>
</div>
<div id="cell-75" class="cell" data-execution_count="58">
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a>mean, variance <span class="op">=</span> tf.nn.moments(array.stack(), axes<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a>mean</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="58">
<pre><code>&lt;tf.Tensor: shape=(2,), dtype=float32, numpy=array([2., 3.], dtype=float32)&gt;</code></pre>
</div>
</div>
<div id="cell-76" class="cell" data-execution_count="59">
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a>variance</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="59">
<pre><code>&lt;tf.Tensor: shape=(2,), dtype=float32, numpy=array([4.6666665, 8.666667 ], dtype=float32)&gt;</code></pre>
</div>
</div>
</section>
</section>
<section id="custom-loss-function" class="level2">
<h2 class="anchored" data-anchor-id="custom-loss-function">Custom loss function</h2>
<p>Let’s start by loading and preparing the California housing dataset. We first load it, then split it into a training set, a validation set and a test set, and finally we scale it:</p>
<div id="cell-79" class="cell" data-execution_count="60">
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.datasets <span class="im">import</span> fetch_california_housing</span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split</span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> StandardScaler</span>
<span id="cb113-4"><a href="#cb113-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-5"><a href="#cb113-5" aria-hidden="true" tabindex="-1"></a>housing <span class="op">=</span> fetch_california_housing()</span>
<span id="cb113-6"><a href="#cb113-6" aria-hidden="true" tabindex="-1"></a>X_train_full, X_test, y_train_full, y_test <span class="op">=</span> train_test_split(</span>
<span id="cb113-7"><a href="#cb113-7" aria-hidden="true" tabindex="-1"></a>    housing.data, housing.target.reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>), random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb113-8"><a href="#cb113-8" aria-hidden="true" tabindex="-1"></a>X_train, X_valid, y_train, y_valid <span class="op">=</span> train_test_split(</span>
<span id="cb113-9"><a href="#cb113-9" aria-hidden="true" tabindex="-1"></a>    X_train_full, y_train_full, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb113-10"><a href="#cb113-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-11"><a href="#cb113-11" aria-hidden="true" tabindex="-1"></a>scaler <span class="op">=</span> StandardScaler()</span>
<span id="cb113-12"><a href="#cb113-12" aria-hidden="true" tabindex="-1"></a>X_train_scaled <span class="op">=</span> scaler.fit_transform(X_train)</span>
<span id="cb113-13"><a href="#cb113-13" aria-hidden="true" tabindex="-1"></a>X_valid_scaled <span class="op">=</span> scaler.transform(X_valid)</span>
<span id="cb113-14"><a href="#cb113-14" aria-hidden="true" tabindex="-1"></a>X_test_scaled <span class="op">=</span> scaler.transform(X_test)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-80" class="cell" data-execution_count="61">
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> huber_fn(y_true, y_pred):</span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a>    error <span class="op">=</span> y_true <span class="op">-</span> y_pred</span>
<span id="cb114-3"><a href="#cb114-3" aria-hidden="true" tabindex="-1"></a>    is_small_error <span class="op">=</span> tf.<span class="bu">abs</span>(error) <span class="op">&lt;</span> <span class="dv">1</span></span>
<span id="cb114-4"><a href="#cb114-4" aria-hidden="true" tabindex="-1"></a>    squared_loss <span class="op">=</span> tf.square(error) <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb114-5"><a href="#cb114-5" aria-hidden="true" tabindex="-1"></a>    linear_loss  <span class="op">=</span> tf.<span class="bu">abs</span>(error) <span class="op">-</span> <span class="fl">0.5</span></span>
<span id="cb114-6"><a href="#cb114-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> tf.where(is_small_error, squared_loss, linear_loss)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-81" class="cell" data-execution_count="62">
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="fl">3.5</span>))</span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a>z <span class="op">=</span> np.linspace(<span class="op">-</span><span class="dv">4</span>, <span class="dv">4</span>, <span class="dv">200</span>)</span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a>plt.plot(z, huber_fn(<span class="dv">0</span>, z), <span class="st">"b-"</span>, linewidth<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span><span class="st">"huber($z$)"</span>)</span>
<span id="cb115-4"><a href="#cb115-4" aria-hidden="true" tabindex="-1"></a>plt.plot(z, z<span class="op">**</span><span class="dv">2</span> <span class="op">/</span> <span class="dv">2</span>, <span class="st">"b:"</span>, linewidth<span class="op">=</span><span class="dv">1</span>, label<span class="op">=</span><span class="vs">r"$\frac</span><span class="sc">{1}{2}</span><span class="vs">z^2$"</span>)</span>
<span id="cb115-5"><a href="#cb115-5" aria-hidden="true" tabindex="-1"></a>plt.plot([<span class="op">-</span><span class="dv">1</span>, <span class="op">-</span><span class="dv">1</span>], [<span class="dv">0</span>, huber_fn(<span class="fl">0.</span>, <span class="op">-</span><span class="fl">1.</span>)], <span class="st">"r--"</span>)</span>
<span id="cb115-6"><a href="#cb115-6" aria-hidden="true" tabindex="-1"></a>plt.plot([<span class="dv">1</span>, <span class="dv">1</span>], [<span class="dv">0</span>, huber_fn(<span class="fl">0.</span>, <span class="fl">1.</span>)], <span class="st">"r--"</span>)</span>
<span id="cb115-7"><a href="#cb115-7" aria-hidden="true" tabindex="-1"></a>plt.gca().axhline(y<span class="op">=</span><span class="dv">0</span>, color<span class="op">=</span><span class="st">'k'</span>)</span>
<span id="cb115-8"><a href="#cb115-8" aria-hidden="true" tabindex="-1"></a>plt.gca().axvline(x<span class="op">=</span><span class="dv">0</span>, color<span class="op">=</span><span class="st">'k'</span>)</span>
<span id="cb115-9"><a href="#cb115-9" aria-hidden="true" tabindex="-1"></a>plt.axis([<span class="op">-</span><span class="dv">4</span>, <span class="dv">4</span>, <span class="dv">0</span>, <span class="dv">4</span>])</span>
<span id="cb115-10"><a href="#cb115-10" aria-hidden="true" tabindex="-1"></a>plt.grid(<span class="va">True</span>)</span>
<span id="cb115-11"><a href="#cb115-11" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"$z$"</span>)</span>
<span id="cb115-12"><a href="#cb115-12" aria-hidden="true" tabindex="-1"></a>plt.legend(fontsize<span class="op">=</span><span class="dv">14</span>)</span>
<span id="cb115-13"><a href="#cb115-13" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Huber loss"</span>, fontsize<span class="op">=</span><span class="dv">14</span>)</span>
<span id="cb115-14"><a href="#cb115-14" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="12_custom_models_and_training_with_tensorflow_files/figure-html/cell-63-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-82" class="cell" data-execution_count="63">
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a>input_shape <span class="op">=</span> X_train.shape[<span class="dv">1</span>:]</span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-3"><a href="#cb116-3" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> keras.models.Sequential([</span>
<span id="cb116-4"><a href="#cb116-4" aria-hidden="true" tabindex="-1"></a>    keras.layers.Dense(<span class="dv">30</span>, activation<span class="op">=</span><span class="st">"selu"</span>, kernel_initializer<span class="op">=</span><span class="st">"lecun_normal"</span>,</span>
<span id="cb116-5"><a href="#cb116-5" aria-hidden="true" tabindex="-1"></a>                       input_shape<span class="op">=</span>input_shape),</span>
<span id="cb116-6"><a href="#cb116-6" aria-hidden="true" tabindex="-1"></a>    keras.layers.Dense(<span class="dv">1</span>),</span>
<span id="cb116-7"><a href="#cb116-7" aria-hidden="true" tabindex="-1"></a>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-83" class="cell" data-execution_count="64">
<div class="sourceCode cell-code" id="cb117"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a>model.<span class="bu">compile</span>(loss<span class="op">=</span>huber_fn, optimizer<span class="op">=</span><span class="st">"nadam"</span>, metrics<span class="op">=</span>[<span class="st">"mae"</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-84" class="cell" data-scrolled="true" data-execution_count="65">
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a>model.fit(X_train_scaled, y_train, epochs<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a>          validation_data<span class="op">=</span>(X_valid_scaled, y_valid))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch 1/2
363/363 [==============================] - 1s 2ms/step - loss: 1.0443 - mae: 1.4660 - val_loss: 0.2862 - val_mae: 0.5866
Epoch 2/2
363/363 [==============================] - 0s 737us/step - loss: 0.2379 - mae: 0.5407 - val_loss: 0.2382 - val_mae: 0.5281</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="65">
<pre><code>&lt;tensorflow.python.keras.callbacks.History at 0x7fc000dcc850&gt;</code></pre>
</div>
</div>
</section>
<section id="savingloading-models-with-custom-objects" class="level2">
<h2 class="anchored" data-anchor-id="savingloading-models-with-custom-objects">Saving/Loading Models with Custom Objects</h2>
<div id="cell-86" class="cell" data-execution_count="66">
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a>model.save(<span class="st">"my_model_with_a_custom_loss.h5"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-87" class="cell" data-execution_count="67">
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> keras.models.load_model(<span class="st">"my_model_with_a_custom_loss.h5"</span>,</span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a>                                custom_objects<span class="op">=</span>{<span class="st">"huber_fn"</span>: huber_fn})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-88" class="cell" data-execution_count="68">
<div class="sourceCode cell-code" id="cb123"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a>model.fit(X_train_scaled, y_train, epochs<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb123-2"><a href="#cb123-2" aria-hidden="true" tabindex="-1"></a>          validation_data<span class="op">=</span>(X_valid_scaled, y_valid))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch 1/2
363/363 [==============================] - 1s 970us/step - loss: 0.2054 - mae: 0.4982 - val_loss: 0.2209 - val_mae: 0.5050
Epoch 2/2
363/363 [==============================] - 0s 769us/step - loss: 0.1999 - mae: 0.4900 - val_loss: 0.2127 - val_mae: 0.4986</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="68">
<pre><code>&lt;tensorflow.python.keras.callbacks.History at 0x7fbfd8c09090&gt;</code></pre>
</div>
</div>
<div id="cell-89" class="cell" data-execution_count="69">
<div class="sourceCode cell-code" id="cb126"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_huber(threshold<span class="op">=</span><span class="fl">1.0</span>):</span>
<span id="cb126-2"><a href="#cb126-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> huber_fn(y_true, y_pred):</span>
<span id="cb126-3"><a href="#cb126-3" aria-hidden="true" tabindex="-1"></a>        error <span class="op">=</span> y_true <span class="op">-</span> y_pred</span>
<span id="cb126-4"><a href="#cb126-4" aria-hidden="true" tabindex="-1"></a>        is_small_error <span class="op">=</span> tf.<span class="bu">abs</span>(error) <span class="op">&lt;</span> threshold</span>
<span id="cb126-5"><a href="#cb126-5" aria-hidden="true" tabindex="-1"></a>        squared_loss <span class="op">=</span> tf.square(error) <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb126-6"><a href="#cb126-6" aria-hidden="true" tabindex="-1"></a>        linear_loss  <span class="op">=</span> threshold <span class="op">*</span> tf.<span class="bu">abs</span>(error) <span class="op">-</span> threshold<span class="op">**</span><span class="dv">2</span> <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb126-7"><a href="#cb126-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> tf.where(is_small_error, squared_loss, linear_loss)</span>
<span id="cb126-8"><a href="#cb126-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> huber_fn</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-90" class="cell" data-execution_count="70">
<div class="sourceCode cell-code" id="cb127"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a>model.<span class="bu">compile</span>(loss<span class="op">=</span>create_huber(<span class="fl">2.0</span>), optimizer<span class="op">=</span><span class="st">"nadam"</span>, metrics<span class="op">=</span>[<span class="st">"mae"</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-91" class="cell" data-scrolled="true" data-execution_count="71">
<div class="sourceCode cell-code" id="cb128"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a>model.fit(X_train_scaled, y_train, epochs<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a>          validation_data<span class="op">=</span>(X_valid_scaled, y_valid))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch 1/2
363/363 [==============================] - 1s 1ms/step - loss: 0.2318 - mae: 0.4979 - val_loss: 0.2540 - val_mae: 0.4907
Epoch 2/2
363/363 [==============================] - 0s 749us/step - loss: 0.2309 - mae: 0.4960 - val_loss: 0.2372 - val_mae: 0.4879</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="71">
<pre><code>&lt;tensorflow.python.keras.callbacks.History at 0x7fbfd8c969d0&gt;</code></pre>
</div>
</div>
<div id="cell-92" class="cell" data-execution_count="72">
<div class="sourceCode cell-code" id="cb131"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a>model.save(<span class="st">"my_model_with_a_custom_loss_threshold_2.h5"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-93" class="cell" data-execution_count="73">
<div class="sourceCode cell-code" id="cb132"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> keras.models.load_model(<span class="st">"my_model_with_a_custom_loss_threshold_2.h5"</span>,</span>
<span id="cb132-2"><a href="#cb132-2" aria-hidden="true" tabindex="-1"></a>                                custom_objects<span class="op">=</span>{<span class="st">"huber_fn"</span>: create_huber(<span class="fl">2.0</span>)})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-94" class="cell" data-execution_count="74">
<div class="sourceCode cell-code" id="cb133"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a>model.fit(X_train_scaled, y_train, epochs<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb133-2"><a href="#cb133-2" aria-hidden="true" tabindex="-1"></a>          validation_data<span class="op">=</span>(X_valid_scaled, y_valid))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch 1/2
363/363 [==============================] - 1s 1ms/step - loss: 0.2147 - mae: 0.4800 - val_loss: 0.2133 - val_mae: 0.4654
Epoch 2/2
363/363 [==============================] - 0s 763us/step - loss: 0.2119 - mae: 0.4762 - val_loss: 0.1992 - val_mae: 0.4643</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="74">
<pre><code>&lt;tensorflow.python.keras.callbacks.History at 0x7fbff7a0a590&gt;</code></pre>
</div>
</div>
<div id="cell-95" class="cell" data-execution_count="75">
<div class="sourceCode cell-code" id="cb136"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> HuberLoss(keras.losses.Loss):</span>
<span id="cb136-2"><a href="#cb136-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, threshold<span class="op">=</span><span class="fl">1.0</span>, <span class="op">**</span>kwargs):</span>
<span id="cb136-3"><a href="#cb136-3" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.threshold <span class="op">=</span> threshold</span>
<span id="cb136-4"><a href="#cb136-4" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>(<span class="op">**</span>kwargs)</span>
<span id="cb136-5"><a href="#cb136-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> call(<span class="va">self</span>, y_true, y_pred):</span>
<span id="cb136-6"><a href="#cb136-6" aria-hidden="true" tabindex="-1"></a>        error <span class="op">=</span> y_true <span class="op">-</span> y_pred</span>
<span id="cb136-7"><a href="#cb136-7" aria-hidden="true" tabindex="-1"></a>        is_small_error <span class="op">=</span> tf.<span class="bu">abs</span>(error) <span class="op">&lt;</span> <span class="va">self</span>.threshold</span>
<span id="cb136-8"><a href="#cb136-8" aria-hidden="true" tabindex="-1"></a>        squared_loss <span class="op">=</span> tf.square(error) <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb136-9"><a href="#cb136-9" aria-hidden="true" tabindex="-1"></a>        linear_loss  <span class="op">=</span> <span class="va">self</span>.threshold <span class="op">*</span> tf.<span class="bu">abs</span>(error) <span class="op">-</span> <span class="va">self</span>.threshold<span class="op">**</span><span class="dv">2</span> <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb136-10"><a href="#cb136-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> tf.where(is_small_error, squared_loss, linear_loss)</span>
<span id="cb136-11"><a href="#cb136-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get_config(<span class="va">self</span>):</span>
<span id="cb136-12"><a href="#cb136-12" aria-hidden="true" tabindex="-1"></a>        base_config <span class="op">=</span> <span class="bu">super</span>().get_config()</span>
<span id="cb136-13"><a href="#cb136-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {<span class="op">**</span>base_config, <span class="st">"threshold"</span>: <span class="va">self</span>.threshold}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-96" class="cell" data-execution_count="76">
<div class="sourceCode cell-code" id="cb137"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> keras.models.Sequential([</span>
<span id="cb137-2"><a href="#cb137-2" aria-hidden="true" tabindex="-1"></a>    keras.layers.Dense(<span class="dv">30</span>, activation<span class="op">=</span><span class="st">"selu"</span>, kernel_initializer<span class="op">=</span><span class="st">"lecun_normal"</span>,</span>
<span id="cb137-3"><a href="#cb137-3" aria-hidden="true" tabindex="-1"></a>                       input_shape<span class="op">=</span>input_shape),</span>
<span id="cb137-4"><a href="#cb137-4" aria-hidden="true" tabindex="-1"></a>    keras.layers.Dense(<span class="dv">1</span>),</span>
<span id="cb137-5"><a href="#cb137-5" aria-hidden="true" tabindex="-1"></a>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-97" class="cell" data-execution_count="77">
<div class="sourceCode cell-code" id="cb138"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a>model.<span class="bu">compile</span>(loss<span class="op">=</span>HuberLoss(<span class="fl">2.</span>), optimizer<span class="op">=</span><span class="st">"nadam"</span>, metrics<span class="op">=</span>[<span class="st">"mae"</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-98" class="cell" data-execution_count="78">
<div class="sourceCode cell-code" id="cb139"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a>model.fit(X_train_scaled, y_train, epochs<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb139-2"><a href="#cb139-2" aria-hidden="true" tabindex="-1"></a>          validation_data<span class="op">=</span>(X_valid_scaled, y_valid))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch 1/2
363/363 [==============================] - 1s 1ms/step - loss: 1.3123 - mae: 1.3345 - val_loss: 0.3378 - val_mae: 0.5485
Epoch 2/2
363/363 [==============================] - 0s 760us/step - loss: 0.2659 - mae: 0.5270 - val_loss: 0.2660 - val_mae: 0.5089</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="78">
<pre><code>&lt;tensorflow.python.keras.callbacks.History at 0x7fbfe06dad50&gt;</code></pre>
</div>
</div>
<div id="cell-99" class="cell" data-execution_count="79">
<div class="sourceCode cell-code" id="cb142"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a>model.save(<span class="st">"my_model_with_a_custom_loss_class.h5"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-100" class="cell" data-execution_count="80">
<div class="sourceCode cell-code" id="cb143"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> keras.models.load_model(<span class="st">"my_model_with_a_custom_loss_class.h5"</span>,</span>
<span id="cb143-2"><a href="#cb143-2" aria-hidden="true" tabindex="-1"></a>                                custom_objects<span class="op">=</span>{<span class="st">"HuberLoss"</span>: HuberLoss})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-101" class="cell" data-execution_count="81">
<div class="sourceCode cell-code" id="cb144"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a>model.fit(X_train_scaled, y_train, epochs<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb144-2"><a href="#cb144-2" aria-hidden="true" tabindex="-1"></a>          validation_data<span class="op">=</span>(X_valid_scaled, y_valid))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch 1/2
363/363 [==============================] - 1s 966us/step - loss: 0.2286 - mae: 0.4970 - val_loss: 0.2120 - val_mae: 0.4723
Epoch 2/2
363/363 [==============================] - 0s 757us/step - loss: 0.2216 - mae: 0.4904 - val_loss: 0.2045 - val_mae: 0.4725</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="81">
<pre><code>&lt;tensorflow.python.keras.callbacks.History at 0x7fbfb0630d50&gt;</code></pre>
</div>
</div>
<div id="cell-102" class="cell" data-execution_count="82">
<div class="sourceCode cell-code" id="cb147"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb147-1"><a href="#cb147-1" aria-hidden="true" tabindex="-1"></a>model.loss.threshold</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="82">
<pre><code>2.0</code></pre>
</div>
</div>
</section>
<section id="other-custom-functions" class="level2">
<h2 class="anchored" data-anchor-id="other-custom-functions">Other Custom Functions</h2>
<div id="cell-104" class="cell" data-execution_count="83">
<div class="sourceCode cell-code" id="cb149"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb149-1"><a href="#cb149-1" aria-hidden="true" tabindex="-1"></a>keras.backend.clear_session()</span>
<span id="cb149-2"><a href="#cb149-2" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">42</span>)</span>
<span id="cb149-3"><a href="#cb149-3" aria-hidden="true" tabindex="-1"></a>tf.random.set_seed(<span class="dv">42</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-105" class="cell" data-execution_count="84">
<div class="sourceCode cell-code" id="cb150"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb150-1"><a href="#cb150-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> my_softplus(z): <span class="co"># return value is just tf.nn.softplus(z)</span></span>
<span id="cb150-2"><a href="#cb150-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> tf.math.log(tf.exp(z) <span class="op">+</span> <span class="fl">1.0</span>)</span>
<span id="cb150-3"><a href="#cb150-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-4"><a href="#cb150-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> my_glorot_initializer(shape, dtype<span class="op">=</span>tf.float32):</span>
<span id="cb150-5"><a href="#cb150-5" aria-hidden="true" tabindex="-1"></a>    stddev <span class="op">=</span> tf.sqrt(<span class="fl">2.</span> <span class="op">/</span> (shape[<span class="dv">0</span>] <span class="op">+</span> shape[<span class="dv">1</span>]))</span>
<span id="cb150-6"><a href="#cb150-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> tf.random.normal(shape, stddev<span class="op">=</span>stddev, dtype<span class="op">=</span>dtype)</span>
<span id="cb150-7"><a href="#cb150-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-8"><a href="#cb150-8" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> my_l1_regularizer(weights):</span>
<span id="cb150-9"><a href="#cb150-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> tf.reduce_sum(tf.<span class="bu">abs</span>(<span class="fl">0.01</span> <span class="op">*</span> weights))</span>
<span id="cb150-10"><a href="#cb150-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-11"><a href="#cb150-11" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> my_positive_weights(weights): <span class="co"># return value is just tf.nn.relu(weights)</span></span>
<span id="cb150-12"><a href="#cb150-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> tf.where(weights <span class="op">&lt;</span> <span class="fl">0.</span>, tf.zeros_like(weights), weights)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-106" class="cell" data-execution_count="85">
<div class="sourceCode cell-code" id="cb151"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb151-1"><a href="#cb151-1" aria-hidden="true" tabindex="-1"></a>layer <span class="op">=</span> keras.layers.Dense(<span class="dv">1</span>, activation<span class="op">=</span>my_softplus,</span>
<span id="cb151-2"><a href="#cb151-2" aria-hidden="true" tabindex="-1"></a>                           kernel_initializer<span class="op">=</span>my_glorot_initializer,</span>
<span id="cb151-3"><a href="#cb151-3" aria-hidden="true" tabindex="-1"></a>                           kernel_regularizer<span class="op">=</span>my_l1_regularizer,</span>
<span id="cb151-4"><a href="#cb151-4" aria-hidden="true" tabindex="-1"></a>                           kernel_constraint<span class="op">=</span>my_positive_weights)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-107" class="cell" data-execution_count="86">
<div class="sourceCode cell-code" id="cb152"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb152-1"><a href="#cb152-1" aria-hidden="true" tabindex="-1"></a>keras.backend.clear_session()</span>
<span id="cb152-2"><a href="#cb152-2" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">42</span>)</span>
<span id="cb152-3"><a href="#cb152-3" aria-hidden="true" tabindex="-1"></a>tf.random.set_seed(<span class="dv">42</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-108" class="cell" data-execution_count="87">
<div class="sourceCode cell-code" id="cb153"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb153-1"><a href="#cb153-1" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> keras.models.Sequential([</span>
<span id="cb153-2"><a href="#cb153-2" aria-hidden="true" tabindex="-1"></a>    keras.layers.Dense(<span class="dv">30</span>, activation<span class="op">=</span><span class="st">"selu"</span>, kernel_initializer<span class="op">=</span><span class="st">"lecun_normal"</span>,</span>
<span id="cb153-3"><a href="#cb153-3" aria-hidden="true" tabindex="-1"></a>                       input_shape<span class="op">=</span>input_shape),</span>
<span id="cb153-4"><a href="#cb153-4" aria-hidden="true" tabindex="-1"></a>    keras.layers.Dense(<span class="dv">1</span>, activation<span class="op">=</span>my_softplus,</span>
<span id="cb153-5"><a href="#cb153-5" aria-hidden="true" tabindex="-1"></a>                       kernel_regularizer<span class="op">=</span>my_l1_regularizer,</span>
<span id="cb153-6"><a href="#cb153-6" aria-hidden="true" tabindex="-1"></a>                       kernel_constraint<span class="op">=</span>my_positive_weights,</span>
<span id="cb153-7"><a href="#cb153-7" aria-hidden="true" tabindex="-1"></a>                       kernel_initializer<span class="op">=</span>my_glorot_initializer),</span>
<span id="cb153-8"><a href="#cb153-8" aria-hidden="true" tabindex="-1"></a>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-109" class="cell" data-execution_count="88">
<div class="sourceCode cell-code" id="cb154"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb154-1"><a href="#cb154-1" aria-hidden="true" tabindex="-1"></a>model.<span class="bu">compile</span>(loss<span class="op">=</span><span class="st">"mse"</span>, optimizer<span class="op">=</span><span class="st">"nadam"</span>, metrics<span class="op">=</span>[<span class="st">"mae"</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-110" class="cell" data-execution_count="89">
<div class="sourceCode cell-code" id="cb155"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb155-1"><a href="#cb155-1" aria-hidden="true" tabindex="-1"></a>model.fit(X_train_scaled, y_train, epochs<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb155-2"><a href="#cb155-2" aria-hidden="true" tabindex="-1"></a>          validation_data<span class="op">=</span>(X_valid_scaled, y_valid))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch 1/2
363/363 [==============================] - 1s 1ms/step - loss: 2.3829 - mae: 1.1635 - val_loss: 1.4154 - val_mae: 0.5607
Epoch 2/2
363/363 [==============================] - 0s 757us/step - loss: 0.6299 - mae: 0.5410 - val_loss: 1.4399 - val_mae: 0.5137</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="89">
<pre><code>&lt;tensorflow.python.keras.callbacks.History at 0x7fbfd8e49690&gt;</code></pre>
</div>
</div>
<div id="cell-111" class="cell" data-execution_count="90">
<div class="sourceCode cell-code" id="cb158"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb158-1"><a href="#cb158-1" aria-hidden="true" tabindex="-1"></a>model.save(<span class="st">"my_model_with_many_custom_parts.h5"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-112" class="cell" data-execution_count="91">
<div class="sourceCode cell-code" id="cb159"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb159-1"><a href="#cb159-1" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> keras.models.load_model(</span>
<span id="cb159-2"><a href="#cb159-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"my_model_with_many_custom_parts.h5"</span>,</span>
<span id="cb159-3"><a href="#cb159-3" aria-hidden="true" tabindex="-1"></a>    custom_objects<span class="op">=</span>{</span>
<span id="cb159-4"><a href="#cb159-4" aria-hidden="true" tabindex="-1"></a>       <span class="st">"my_l1_regularizer"</span>: my_l1_regularizer,</span>
<span id="cb159-5"><a href="#cb159-5" aria-hidden="true" tabindex="-1"></a>       <span class="st">"my_positive_weights"</span>: my_positive_weights,</span>
<span id="cb159-6"><a href="#cb159-6" aria-hidden="true" tabindex="-1"></a>       <span class="st">"my_glorot_initializer"</span>: my_glorot_initializer,</span>
<span id="cb159-7"><a href="#cb159-7" aria-hidden="true" tabindex="-1"></a>       <span class="st">"my_softplus"</span>: my_softplus,</span>
<span id="cb159-8"><a href="#cb159-8" aria-hidden="true" tabindex="-1"></a>    })</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-113" class="cell" data-execution_count="92">
<div class="sourceCode cell-code" id="cb160"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb160-1"><a href="#cb160-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MyL1Regularizer(keras.regularizers.Regularizer):</span>
<span id="cb160-2"><a href="#cb160-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, factor):</span>
<span id="cb160-3"><a href="#cb160-3" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.factor <span class="op">=</span> factor</span>
<span id="cb160-4"><a href="#cb160-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>, weights):</span>
<span id="cb160-5"><a href="#cb160-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> tf.reduce_sum(tf.<span class="bu">abs</span>(<span class="va">self</span>.factor <span class="op">*</span> weights))</span>
<span id="cb160-6"><a href="#cb160-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get_config(<span class="va">self</span>):</span>
<span id="cb160-7"><a href="#cb160-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {<span class="st">"factor"</span>: <span class="va">self</span>.factor}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-114" class="cell" data-execution_count="93">
<div class="sourceCode cell-code" id="cb161"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb161-1"><a href="#cb161-1" aria-hidden="true" tabindex="-1"></a>keras.backend.clear_session()</span>
<span id="cb161-2"><a href="#cb161-2" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">42</span>)</span>
<span id="cb161-3"><a href="#cb161-3" aria-hidden="true" tabindex="-1"></a>tf.random.set_seed(<span class="dv">42</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-115" class="cell" data-execution_count="94">
<div class="sourceCode cell-code" id="cb162"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb162-1"><a href="#cb162-1" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> keras.models.Sequential([</span>
<span id="cb162-2"><a href="#cb162-2" aria-hidden="true" tabindex="-1"></a>    keras.layers.Dense(<span class="dv">30</span>, activation<span class="op">=</span><span class="st">"selu"</span>, kernel_initializer<span class="op">=</span><span class="st">"lecun_normal"</span>,</span>
<span id="cb162-3"><a href="#cb162-3" aria-hidden="true" tabindex="-1"></a>                       input_shape<span class="op">=</span>input_shape),</span>
<span id="cb162-4"><a href="#cb162-4" aria-hidden="true" tabindex="-1"></a>    keras.layers.Dense(<span class="dv">1</span>, activation<span class="op">=</span>my_softplus,</span>
<span id="cb162-5"><a href="#cb162-5" aria-hidden="true" tabindex="-1"></a>                       kernel_regularizer<span class="op">=</span>MyL1Regularizer(<span class="fl">0.01</span>),</span>
<span id="cb162-6"><a href="#cb162-6" aria-hidden="true" tabindex="-1"></a>                       kernel_constraint<span class="op">=</span>my_positive_weights,</span>
<span id="cb162-7"><a href="#cb162-7" aria-hidden="true" tabindex="-1"></a>                       kernel_initializer<span class="op">=</span>my_glorot_initializer),</span>
<span id="cb162-8"><a href="#cb162-8" aria-hidden="true" tabindex="-1"></a>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-116" class="cell" data-execution_count="95">
<div class="sourceCode cell-code" id="cb163"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb163-1"><a href="#cb163-1" aria-hidden="true" tabindex="-1"></a>model.<span class="bu">compile</span>(loss<span class="op">=</span><span class="st">"mse"</span>, optimizer<span class="op">=</span><span class="st">"nadam"</span>, metrics<span class="op">=</span>[<span class="st">"mae"</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-117" class="cell" data-execution_count="96">
<div class="sourceCode cell-code" id="cb164"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb164-1"><a href="#cb164-1" aria-hidden="true" tabindex="-1"></a>model.fit(X_train_scaled, y_train, epochs<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb164-2"><a href="#cb164-2" aria-hidden="true" tabindex="-1"></a>          validation_data<span class="op">=</span>(X_valid_scaled, y_valid))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch 1/2
363/363 [==============================] - 1s 1ms/step - loss: 2.3829 - mae: 1.1635 - val_loss: 1.4154 - val_mae: 0.5607
Epoch 2/2
363/363 [==============================] - 0s 757us/step - loss: 0.6299 - mae: 0.5410 - val_loss: 1.4399 - val_mae: 0.5137</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="96">
<pre><code>&lt;tensorflow.python.keras.callbacks.History at 0x7fbfd90141d0&gt;</code></pre>
</div>
</div>
<div id="cell-118" class="cell" data-execution_count="97">
<div class="sourceCode cell-code" id="cb167"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb167-1"><a href="#cb167-1" aria-hidden="true" tabindex="-1"></a>model.save(<span class="st">"my_model_with_many_custom_parts.h5"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-119" class="cell" data-execution_count="98">
<div class="sourceCode cell-code" id="cb168"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb168-1"><a href="#cb168-1" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> keras.models.load_model(</span>
<span id="cb168-2"><a href="#cb168-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"my_model_with_many_custom_parts.h5"</span>,</span>
<span id="cb168-3"><a href="#cb168-3" aria-hidden="true" tabindex="-1"></a>    custom_objects<span class="op">=</span>{</span>
<span id="cb168-4"><a href="#cb168-4" aria-hidden="true" tabindex="-1"></a>       <span class="st">"MyL1Regularizer"</span>: MyL1Regularizer,</span>
<span id="cb168-5"><a href="#cb168-5" aria-hidden="true" tabindex="-1"></a>       <span class="st">"my_positive_weights"</span>: my_positive_weights,</span>
<span id="cb168-6"><a href="#cb168-6" aria-hidden="true" tabindex="-1"></a>       <span class="st">"my_glorot_initializer"</span>: my_glorot_initializer,</span>
<span id="cb168-7"><a href="#cb168-7" aria-hidden="true" tabindex="-1"></a>       <span class="st">"my_softplus"</span>: my_softplus,</span>
<span id="cb168-8"><a href="#cb168-8" aria-hidden="true" tabindex="-1"></a>    })</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="custom-metrics" class="level2">
<h2 class="anchored" data-anchor-id="custom-metrics">Custom Metrics</h2>
<div id="cell-121" class="cell" data-execution_count="99">
<div class="sourceCode cell-code" id="cb169"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb169-1"><a href="#cb169-1" aria-hidden="true" tabindex="-1"></a>keras.backend.clear_session()</span>
<span id="cb169-2"><a href="#cb169-2" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">42</span>)</span>
<span id="cb169-3"><a href="#cb169-3" aria-hidden="true" tabindex="-1"></a>tf.random.set_seed(<span class="dv">42</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-122" class="cell" data-execution_count="100">
<div class="sourceCode cell-code" id="cb170"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb170-1"><a href="#cb170-1" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> keras.models.Sequential([</span>
<span id="cb170-2"><a href="#cb170-2" aria-hidden="true" tabindex="-1"></a>    keras.layers.Dense(<span class="dv">30</span>, activation<span class="op">=</span><span class="st">"selu"</span>, kernel_initializer<span class="op">=</span><span class="st">"lecun_normal"</span>,</span>
<span id="cb170-3"><a href="#cb170-3" aria-hidden="true" tabindex="-1"></a>                       input_shape<span class="op">=</span>input_shape),</span>
<span id="cb170-4"><a href="#cb170-4" aria-hidden="true" tabindex="-1"></a>    keras.layers.Dense(<span class="dv">1</span>),</span>
<span id="cb170-5"><a href="#cb170-5" aria-hidden="true" tabindex="-1"></a>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-123" class="cell" data-execution_count="101">
<div class="sourceCode cell-code" id="cb171"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb171-1"><a href="#cb171-1" aria-hidden="true" tabindex="-1"></a>model.<span class="bu">compile</span>(loss<span class="op">=</span><span class="st">"mse"</span>, optimizer<span class="op">=</span><span class="st">"nadam"</span>, metrics<span class="op">=</span>[create_huber(<span class="fl">2.0</span>)])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-124" class="cell" data-execution_count="102">
<div class="sourceCode cell-code" id="cb172"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb172-1"><a href="#cb172-1" aria-hidden="true" tabindex="-1"></a>model.fit(X_train_scaled, y_train, epochs<span class="op">=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch 1/2
363/363 [==============================] - 1s 572us/step - loss: 3.5903 - huber_fn: 1.5558
Epoch 2/2
363/363 [==============================] - 0s 552us/step - loss: 0.8054 - huber_fn: 0.3095</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="102">
<pre><code>&lt;tensorflow.python.keras.callbacks.History at 0x7fbff7cbe850&gt;</code></pre>
</div>
</div>
<p><strong>Note</strong>: if you use the same function as the loss and a metric, you may be surprised to see different results. This is generally just due to floating point precision errors: even though the mathematical equations are equivalent, the operations are not run in the same order, which can lead to small differences. Moreover, when using sample weights, there’s more than just precision errors: * the loss since the start of the epoch is the mean of all batch losses seen so far. Each batch loss is the sum of the weighted instance losses divided by the <em>batch size</em> (not the sum of weights, so the batch loss is <em>not</em> the weighted mean of the losses). * the metric since the start of the epoch is equal to the sum of weighted instance losses divided by sum of all weights seen so far. In other words, it is the weighted mean of all the instance losses. Not the same thing.</p>
<p>If you do the math, you will find that loss = metric * mean of sample weights (plus some floating point precision error).</p>
<div id="cell-126" class="cell" data-execution_count="103">
<div class="sourceCode cell-code" id="cb175"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb175-1"><a href="#cb175-1" aria-hidden="true" tabindex="-1"></a>model.<span class="bu">compile</span>(loss<span class="op">=</span>create_huber(<span class="fl">2.0</span>), optimizer<span class="op">=</span><span class="st">"nadam"</span>, metrics<span class="op">=</span>[create_huber(<span class="fl">2.0</span>)])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-127" class="cell" data-execution_count="104">
<div class="sourceCode cell-code" id="cb176"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb176-1"><a href="#cb176-1" aria-hidden="true" tabindex="-1"></a>sample_weight <span class="op">=</span> np.random.rand(<span class="bu">len</span>(y_train))</span>
<span id="cb176-2"><a href="#cb176-2" aria-hidden="true" tabindex="-1"></a>history <span class="op">=</span> model.fit(X_train_scaled, y_train, epochs<span class="op">=</span><span class="dv">2</span>, sample_weight<span class="op">=</span>sample_weight)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch 1/2
363/363 [==============================] - 1s 598us/step - loss: 0.1245 - huber_fn: 0.2515
Epoch 2/2
363/363 [==============================] - 0s 558us/step - loss: 0.1216 - huber_fn: 0.2473</code></pre>
</div>
</div>
<div id="cell-128" class="cell" data-execution_count="105">
<div class="sourceCode cell-code" id="cb178"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb178-1"><a href="#cb178-1" aria-hidden="true" tabindex="-1"></a>history.history[<span class="st">"loss"</span>][<span class="dv">0</span>], history.history[<span class="st">"huber_fn"</span>][<span class="dv">0</span>] <span class="op">*</span> sample_weight.mean()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="105">
<pre><code>(0.11749906837940216, 0.11906625573138947)</code></pre>
</div>
</div>
<section id="streaming-metrics" class="level3">
<h3 class="anchored" data-anchor-id="streaming-metrics">Streaming metrics</h3>
<div id="cell-130" class="cell" data-execution_count="106">
<div class="sourceCode cell-code" id="cb180"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb180-1"><a href="#cb180-1" aria-hidden="true" tabindex="-1"></a>precision <span class="op">=</span> keras.metrics.Precision()</span>
<span id="cb180-2"><a href="#cb180-2" aria-hidden="true" tabindex="-1"></a>precision([<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>], [<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="106">
<pre><code>&lt;tf.Tensor: shape=(), dtype=float32, numpy=0.8&gt;</code></pre>
</div>
</div>
<div id="cell-131" class="cell" data-execution_count="107">
<div class="sourceCode cell-code" id="cb182"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb182-1"><a href="#cb182-1" aria-hidden="true" tabindex="-1"></a>precision([<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>], [<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="107">
<pre><code>&lt;tf.Tensor: shape=(), dtype=float32, numpy=0.5&gt;</code></pre>
</div>
</div>
<div id="cell-132" class="cell" data-execution_count="108">
<div class="sourceCode cell-code" id="cb184"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb184-1"><a href="#cb184-1" aria-hidden="true" tabindex="-1"></a>precision.result()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="108">
<pre><code>&lt;tf.Tensor: shape=(), dtype=float32, numpy=0.5&gt;</code></pre>
</div>
</div>
<div id="cell-133" class="cell" data-execution_count="109">
<div class="sourceCode cell-code" id="cb186"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb186-1"><a href="#cb186-1" aria-hidden="true" tabindex="-1"></a>precision.variables</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="109">
<pre><code>[&lt;tf.Variable 'true_positives:0' shape=(1,) dtype=float32, numpy=array([4.], dtype=float32)&gt;,
 &lt;tf.Variable 'false_positives:0' shape=(1,) dtype=float32, numpy=array([4.], dtype=float32)&gt;]</code></pre>
</div>
</div>
<div id="cell-134" class="cell" data-execution_count="110">
<div class="sourceCode cell-code" id="cb188"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb188-1"><a href="#cb188-1" aria-hidden="true" tabindex="-1"></a>precision.reset_states()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Creating a streaming metric:</p>
<div id="cell-136" class="cell" data-execution_count="111">
<div class="sourceCode cell-code" id="cb189"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb189-1"><a href="#cb189-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> HuberMetric(keras.metrics.Metric):</span>
<span id="cb189-2"><a href="#cb189-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, threshold<span class="op">=</span><span class="fl">1.0</span>, <span class="op">**</span>kwargs):</span>
<span id="cb189-3"><a href="#cb189-3" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>(<span class="op">**</span>kwargs) <span class="co"># handles base args (e.g., dtype)</span></span>
<span id="cb189-4"><a href="#cb189-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.threshold <span class="op">=</span> threshold</span>
<span id="cb189-5"><a href="#cb189-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.huber_fn <span class="op">=</span> create_huber(threshold)</span>
<span id="cb189-6"><a href="#cb189-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.total <span class="op">=</span> <span class="va">self</span>.add_weight(<span class="st">"total"</span>, initializer<span class="op">=</span><span class="st">"zeros"</span>)</span>
<span id="cb189-7"><a href="#cb189-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.count <span class="op">=</span> <span class="va">self</span>.add_weight(<span class="st">"count"</span>, initializer<span class="op">=</span><span class="st">"zeros"</span>)</span>
<span id="cb189-8"><a href="#cb189-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> update_state(<span class="va">self</span>, y_true, y_pred, sample_weight<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb189-9"><a href="#cb189-9" aria-hidden="true" tabindex="-1"></a>        metric <span class="op">=</span> <span class="va">self</span>.huber_fn(y_true, y_pred)</span>
<span id="cb189-10"><a href="#cb189-10" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.total.assign_add(tf.reduce_sum(metric))</span>
<span id="cb189-11"><a href="#cb189-11" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.count.assign_add(tf.cast(tf.size(y_true), tf.float32))</span>
<span id="cb189-12"><a href="#cb189-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> result(<span class="va">self</span>):</span>
<span id="cb189-13"><a href="#cb189-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.total <span class="op">/</span> <span class="va">self</span>.count</span>
<span id="cb189-14"><a href="#cb189-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get_config(<span class="va">self</span>):</span>
<span id="cb189-15"><a href="#cb189-15" aria-hidden="true" tabindex="-1"></a>        base_config <span class="op">=</span> <span class="bu">super</span>().get_config()</span>
<span id="cb189-16"><a href="#cb189-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {<span class="op">**</span>base_config, <span class="st">"threshold"</span>: <span class="va">self</span>.threshold}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-137" class="cell" data-execution_count="112">
<div class="sourceCode cell-code" id="cb190"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb190-1"><a href="#cb190-1" aria-hidden="true" tabindex="-1"></a>m <span class="op">=</span> HuberMetric(<span class="fl">2.</span>)</span>
<span id="cb190-2"><a href="#cb190-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-3"><a href="#cb190-3" aria-hidden="true" tabindex="-1"></a><span class="co"># total = 2 * |10 - 2| - 2²/2 = 14</span></span>
<span id="cb190-4"><a href="#cb190-4" aria-hidden="true" tabindex="-1"></a><span class="co"># count = 1</span></span>
<span id="cb190-5"><a href="#cb190-5" aria-hidden="true" tabindex="-1"></a><span class="co"># result = 14 / 1 = 14</span></span>
<span id="cb190-6"><a href="#cb190-6" aria-hidden="true" tabindex="-1"></a>m(tf.constant([[<span class="fl">2.</span>]]), tf.constant([[<span class="fl">10.</span>]])) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="112">
<pre><code>&lt;tf.Tensor: shape=(), dtype=float32, numpy=14.0&gt;</code></pre>
</div>
</div>
<div id="cell-138" class="cell" data-execution_count="113">
<div class="sourceCode cell-code" id="cb192"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb192-1"><a href="#cb192-1" aria-hidden="true" tabindex="-1"></a><span class="co"># total = total + (|1 - 0|² / 2) + (2 * |9.25 - 5| - 2² / 2) = 14 + 7 = 21</span></span>
<span id="cb192-2"><a href="#cb192-2" aria-hidden="true" tabindex="-1"></a><span class="co"># count = count + 2 = 3</span></span>
<span id="cb192-3"><a href="#cb192-3" aria-hidden="true" tabindex="-1"></a><span class="co"># result = total / count = 21 / 3 = 7</span></span>
<span id="cb192-4"><a href="#cb192-4" aria-hidden="true" tabindex="-1"></a>m(tf.constant([[<span class="fl">0.</span>], [<span class="fl">5.</span>]]), tf.constant([[<span class="fl">1.</span>], [<span class="fl">9.25</span>]]))</span>
<span id="cb192-5"><a href="#cb192-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb192-6"><a href="#cb192-6" aria-hidden="true" tabindex="-1"></a>m.result()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="113">
<pre><code>&lt;tf.Tensor: shape=(), dtype=float32, numpy=7.0&gt;</code></pre>
</div>
</div>
<div id="cell-139" class="cell" data-execution_count="114">
<div class="sourceCode cell-code" id="cb194"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb194-1"><a href="#cb194-1" aria-hidden="true" tabindex="-1"></a>m.variables</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="114">
<pre><code>[&lt;tf.Variable 'total:0' shape=() dtype=float32, numpy=21.0&gt;,
 &lt;tf.Variable 'count:0' shape=() dtype=float32, numpy=3.0&gt;]</code></pre>
</div>
</div>
<div id="cell-140" class="cell" data-execution_count="115">
<div class="sourceCode cell-code" id="cb196"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb196-1"><a href="#cb196-1" aria-hidden="true" tabindex="-1"></a>m.reset_states()</span>
<span id="cb196-2"><a href="#cb196-2" aria-hidden="true" tabindex="-1"></a>m.variables</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="115">
<pre><code>[&lt;tf.Variable 'total:0' shape=() dtype=float32, numpy=0.0&gt;,
 &lt;tf.Variable 'count:0' shape=() dtype=float32, numpy=0.0&gt;]</code></pre>
</div>
</div>
<p>Let’s check that the <code>HuberMetric</code> class works well:</p>
<div id="cell-142" class="cell" data-execution_count="116">
<div class="sourceCode cell-code" id="cb198"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb198-1"><a href="#cb198-1" aria-hidden="true" tabindex="-1"></a>keras.backend.clear_session()</span>
<span id="cb198-2"><a href="#cb198-2" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">42</span>)</span>
<span id="cb198-3"><a href="#cb198-3" aria-hidden="true" tabindex="-1"></a>tf.random.set_seed(<span class="dv">42</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-143" class="cell" data-execution_count="117">
<div class="sourceCode cell-code" id="cb199"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb199-1"><a href="#cb199-1" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> keras.models.Sequential([</span>
<span id="cb199-2"><a href="#cb199-2" aria-hidden="true" tabindex="-1"></a>    keras.layers.Dense(<span class="dv">30</span>, activation<span class="op">=</span><span class="st">"selu"</span>, kernel_initializer<span class="op">=</span><span class="st">"lecun_normal"</span>,</span>
<span id="cb199-3"><a href="#cb199-3" aria-hidden="true" tabindex="-1"></a>                       input_shape<span class="op">=</span>input_shape),</span>
<span id="cb199-4"><a href="#cb199-4" aria-hidden="true" tabindex="-1"></a>    keras.layers.Dense(<span class="dv">1</span>),</span>
<span id="cb199-5"><a href="#cb199-5" aria-hidden="true" tabindex="-1"></a>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-144" class="cell" data-execution_count="118">
<div class="sourceCode cell-code" id="cb200"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb200-1"><a href="#cb200-1" aria-hidden="true" tabindex="-1"></a>model.<span class="bu">compile</span>(loss<span class="op">=</span>create_huber(<span class="fl">2.0</span>), optimizer<span class="op">=</span><span class="st">"nadam"</span>, metrics<span class="op">=</span>[HuberMetric(<span class="fl">2.0</span>)])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-145" class="cell" data-execution_count="119">
<div class="sourceCode cell-code" id="cb201"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb201-1"><a href="#cb201-1" aria-hidden="true" tabindex="-1"></a>model.fit(X_train_scaled.astype(np.float32), y_train.astype(np.float32), epochs<span class="op">=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch 1/2
363/363 [==============================] - 1s 592us/step - loss: 1.5182 - huber_metric: 1.5182
Epoch 2/2
363/363 [==============================] - 0s 538us/step - loss: 0.2909 - huber_metric: 0.2909</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="119">
<pre><code>&lt;tensorflow.python.keras.callbacks.History at 0x7fc000fdfbd0&gt;</code></pre>
</div>
</div>
<div id="cell-146" class="cell" data-execution_count="120">
<div class="sourceCode cell-code" id="cb204"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb204-1"><a href="#cb204-1" aria-hidden="true" tabindex="-1"></a>model.save(<span class="st">"my_model_with_a_custom_metric.h5"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-147" class="cell" data-execution_count="121">
<div class="sourceCode cell-code" id="cb205"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb205-1"><a href="#cb205-1" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> keras.models.load_model(<span class="st">"my_model_with_a_custom_metric.h5"</span>,</span>
<span id="cb205-2"><a href="#cb205-2" aria-hidden="true" tabindex="-1"></a>                                custom_objects<span class="op">=</span>{<span class="st">"huber_fn"</span>: create_huber(<span class="fl">2.0</span>),</span>
<span id="cb205-3"><a href="#cb205-3" aria-hidden="true" tabindex="-1"></a>                                                <span class="st">"HuberMetric"</span>: HuberMetric})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-148" class="cell" data-execution_count="122">
<div class="sourceCode cell-code" id="cb206"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb206-1"><a href="#cb206-1" aria-hidden="true" tabindex="-1"></a>model.fit(X_train_scaled.astype(np.float32), y_train.astype(np.float32), epochs<span class="op">=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch 1/2
363/363 [==============================] - 0s 545us/step - loss: 0.2350 - huber_metric: 0.2350
Epoch 2/2
363/363 [==============================] - 0s 524us/step - loss: 0.2278 - huber_metric: 0.2278</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="122">
<pre><code>&lt;tensorflow.python.keras.callbacks.History at 0x7fc0011c1a50&gt;</code></pre>
</div>
</div>
<p><strong>Warning</strong>: In TF 2.2, tf.keras adds an extra first metric in <code>model.metrics</code> at position 0 (see <a href="https://github.com/tensorflow/tensorflow/issues/38150">TF issue #38150</a>). This forces us to use <code>model.metrics[-1]</code> rather than <code>model.metrics[0]</code> to access the <code>HuberMetric</code>.</p>
<div id="cell-150" class="cell" data-execution_count="123">
<div class="sourceCode cell-code" id="cb209"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb209-1"><a href="#cb209-1" aria-hidden="true" tabindex="-1"></a>model.metrics[<span class="op">-</span><span class="dv">1</span>].threshold</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="123">
<pre><code>2.0</code></pre>
</div>
</div>
<p>Looks like it works fine! More simply, we could have created the class like this:</p>
<div id="cell-152" class="cell" data-execution_count="124">
<div class="sourceCode cell-code" id="cb211"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb211-1"><a href="#cb211-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> HuberMetric(keras.metrics.Mean):</span>
<span id="cb211-2"><a href="#cb211-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, threshold<span class="op">=</span><span class="fl">1.0</span>, name<span class="op">=</span><span class="st">'HuberMetric'</span>, dtype<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb211-3"><a href="#cb211-3" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.threshold <span class="op">=</span> threshold</span>
<span id="cb211-4"><a href="#cb211-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.huber_fn <span class="op">=</span> create_huber(threshold)</span>
<span id="cb211-5"><a href="#cb211-5" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>(name<span class="op">=</span>name, dtype<span class="op">=</span>dtype)</span>
<span id="cb211-6"><a href="#cb211-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> update_state(<span class="va">self</span>, y_true, y_pred, sample_weight<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb211-7"><a href="#cb211-7" aria-hidden="true" tabindex="-1"></a>        metric <span class="op">=</span> <span class="va">self</span>.huber_fn(y_true, y_pred)</span>
<span id="cb211-8"><a href="#cb211-8" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>(HuberMetric, <span class="va">self</span>).update_state(metric, sample_weight)</span>
<span id="cb211-9"><a href="#cb211-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get_config(<span class="va">self</span>):</span>
<span id="cb211-10"><a href="#cb211-10" aria-hidden="true" tabindex="-1"></a>        base_config <span class="op">=</span> <span class="bu">super</span>().get_config()</span>
<span id="cb211-11"><a href="#cb211-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {<span class="op">**</span>base_config, <span class="st">"threshold"</span>: <span class="va">self</span>.threshold}        </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This class handles shapes better, and it also supports sample weights.</p>
<div id="cell-154" class="cell" data-execution_count="125">
<div class="sourceCode cell-code" id="cb212"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb212-1"><a href="#cb212-1" aria-hidden="true" tabindex="-1"></a>keras.backend.clear_session()</span>
<span id="cb212-2"><a href="#cb212-2" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">42</span>)</span>
<span id="cb212-3"><a href="#cb212-3" aria-hidden="true" tabindex="-1"></a>tf.random.set_seed(<span class="dv">42</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-155" class="cell" data-execution_count="126">
<div class="sourceCode cell-code" id="cb213"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb213-1"><a href="#cb213-1" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> keras.models.Sequential([</span>
<span id="cb213-2"><a href="#cb213-2" aria-hidden="true" tabindex="-1"></a>    keras.layers.Dense(<span class="dv">30</span>, activation<span class="op">=</span><span class="st">"selu"</span>, kernel_initializer<span class="op">=</span><span class="st">"lecun_normal"</span>,</span>
<span id="cb213-3"><a href="#cb213-3" aria-hidden="true" tabindex="-1"></a>                       input_shape<span class="op">=</span>input_shape),</span>
<span id="cb213-4"><a href="#cb213-4" aria-hidden="true" tabindex="-1"></a>    keras.layers.Dense(<span class="dv">1</span>),</span>
<span id="cb213-5"><a href="#cb213-5" aria-hidden="true" tabindex="-1"></a>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-156" class="cell" data-execution_count="127">
<div class="sourceCode cell-code" id="cb214"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb214-1"><a href="#cb214-1" aria-hidden="true" tabindex="-1"></a>model.<span class="bu">compile</span>(loss<span class="op">=</span>keras.losses.Huber(<span class="fl">2.0</span>), optimizer<span class="op">=</span><span class="st">"nadam"</span>, weighted_metrics<span class="op">=</span>[HuberMetric(<span class="fl">2.0</span>)])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-157" class="cell" data-scrolled="true" data-execution_count="128">
<div class="sourceCode cell-code" id="cb215"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb215-1"><a href="#cb215-1" aria-hidden="true" tabindex="-1"></a>sample_weight <span class="op">=</span> np.random.rand(<span class="bu">len</span>(y_train))</span>
<span id="cb215-2"><a href="#cb215-2" aria-hidden="true" tabindex="-1"></a>history <span class="op">=</span> model.fit(X_train_scaled.astype(np.float32), y_train.astype(np.float32),</span>
<span id="cb215-3"><a href="#cb215-3" aria-hidden="true" tabindex="-1"></a>                    epochs<span class="op">=</span><span class="dv">2</span>, sample_weight<span class="op">=</span>sample_weight)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch 1/2
363/363 [==============================] - 1s 627us/step - loss: 0.7800 - HuberMetric: 1.5672
Epoch 2/2
363/363 [==============================] - 0s 607us/step - loss: 0.1462 - HuberMetric: 0.2939</code></pre>
</div>
</div>
<div id="cell-158" class="cell" data-execution_count="129">
<div class="sourceCode cell-code" id="cb217"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb217-1"><a href="#cb217-1" aria-hidden="true" tabindex="-1"></a>history.history[<span class="st">"loss"</span>][<span class="dv">0</span>], history.history[<span class="st">"HuberMetric"</span>][<span class="dv">0</span>] <span class="op">*</span> sample_weight.mean()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="129">
<pre><code>(0.44554394483566284, 0.44554404180100277)</code></pre>
</div>
</div>
<div id="cell-159" class="cell" data-execution_count="130">
<div class="sourceCode cell-code" id="cb219"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb219-1"><a href="#cb219-1" aria-hidden="true" tabindex="-1"></a>model.save(<span class="st">"my_model_with_a_custom_metric_v2.h5"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-160" class="cell" data-execution_count="131">
<div class="sourceCode cell-code" id="cb220"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb220-1"><a href="#cb220-1" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> keras.models.load_model(<span class="st">"my_model_with_a_custom_metric_v2.h5"</span>,</span>
<span id="cb220-2"><a href="#cb220-2" aria-hidden="true" tabindex="-1"></a>                                custom_objects<span class="op">=</span>{<span class="st">"HuberMetric"</span>: HuberMetric})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-161" class="cell" data-execution_count="132">
<div class="sourceCode cell-code" id="cb221"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb221-1"><a href="#cb221-1" aria-hidden="true" tabindex="-1"></a>model.fit(X_train_scaled.astype(np.float32), y_train.astype(np.float32), epochs<span class="op">=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch 1/2
363/363 [==============================] - 0s 578us/step - loss: 0.2377 - HuberMetric: 0.2377
Epoch 2/2
363/363 [==============================] - 0s 559us/step - loss: 0.2279 - HuberMetric: 0.2279</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="132">
<pre><code>&lt;tensorflow.python.keras.callbacks.History at 0x7fbfb052b150&gt;</code></pre>
</div>
</div>
<div id="cell-162" class="cell" data-scrolled="true" data-execution_count="133">
<div class="sourceCode cell-code" id="cb224"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb224-1"><a href="#cb224-1" aria-hidden="true" tabindex="-1"></a>model.metrics[<span class="op">-</span><span class="dv">1</span>].threshold</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="133">
<pre><code>2.0</code></pre>
</div>
</div>
</section>
</section>
<section id="custom-layers" class="level2">
<h2 class="anchored" data-anchor-id="custom-layers">Custom Layers</h2>
<div id="cell-164" class="cell" data-execution_count="134">
<div class="sourceCode cell-code" id="cb226"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb226-1"><a href="#cb226-1" aria-hidden="true" tabindex="-1"></a>exponential_layer <span class="op">=</span> keras.layers.Lambda(<span class="kw">lambda</span> x: tf.exp(x))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-165" class="cell" data-execution_count="135">
<div class="sourceCode cell-code" id="cb227"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb227-1"><a href="#cb227-1" aria-hidden="true" tabindex="-1"></a>exponential_layer([<span class="op">-</span><span class="fl">1.</span>, <span class="fl">0.</span>, <span class="fl">1.</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="135">
<pre><code>&lt;tf.Tensor: shape=(3,), dtype=float32, numpy=array([0.36787945, 1.        , 2.7182817 ], dtype=float32)&gt;</code></pre>
</div>
</div>
<p>Adding an exponential layer at the output of a regression model can be useful if the values to predict are positive and with very different scales (e.g., 0.001, 10., 10000):</p>
<div id="cell-167" class="cell" data-execution_count="136">
<div class="sourceCode cell-code" id="cb229"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb229-1"><a href="#cb229-1" aria-hidden="true" tabindex="-1"></a>keras.backend.clear_session()</span>
<span id="cb229-2"><a href="#cb229-2" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">42</span>)</span>
<span id="cb229-3"><a href="#cb229-3" aria-hidden="true" tabindex="-1"></a>tf.random.set_seed(<span class="dv">42</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-168" class="cell" data-execution_count="137">
<div class="sourceCode cell-code" id="cb230"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb230-1"><a href="#cb230-1" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> keras.models.Sequential([</span>
<span id="cb230-2"><a href="#cb230-2" aria-hidden="true" tabindex="-1"></a>    keras.layers.Dense(<span class="dv">30</span>, activation<span class="op">=</span><span class="st">"relu"</span>, input_shape<span class="op">=</span>input_shape),</span>
<span id="cb230-3"><a href="#cb230-3" aria-hidden="true" tabindex="-1"></a>    keras.layers.Dense(<span class="dv">1</span>),</span>
<span id="cb230-4"><a href="#cb230-4" aria-hidden="true" tabindex="-1"></a>    exponential_layer</span>
<span id="cb230-5"><a href="#cb230-5" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb230-6"><a href="#cb230-6" aria-hidden="true" tabindex="-1"></a>model.<span class="bu">compile</span>(loss<span class="op">=</span><span class="st">"mse"</span>, optimizer<span class="op">=</span><span class="st">"sgd"</span>)</span>
<span id="cb230-7"><a href="#cb230-7" aria-hidden="true" tabindex="-1"></a>model.fit(X_train_scaled, y_train, epochs<span class="op">=</span><span class="dv">5</span>,</span>
<span id="cb230-8"><a href="#cb230-8" aria-hidden="true" tabindex="-1"></a>          validation_data<span class="op">=</span>(X_valid_scaled, y_valid))</span>
<span id="cb230-9"><a href="#cb230-9" aria-hidden="true" tabindex="-1"></a>model.evaluate(X_test_scaled, y_test)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch 1/5
363/363 [==============================] - 0s 828us/step - loss: 2.1275 - val_loss: 0.4457
Epoch 2/5
363/363 [==============================] - 0s 645us/step - loss: 0.4750 - val_loss: 0.3798
Epoch 3/5
363/363 [==============================] - 0s 656us/step - loss: 0.4230 - val_loss: 0.3548
Epoch 4/5
363/363 [==============================] - 0s 657us/step - loss: 0.3905 - val_loss: 0.3464
Epoch 5/5
363/363 [==============================] - 0s 664us/step - loss: 0.3784 - val_loss: 0.3449
162/162 [==============================] - 0s 420us/step - loss: 0.3586</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="137">
<pre><code>0.3586340546607971</code></pre>
</div>
</div>
<div id="cell-169" class="cell" data-execution_count="138">
<div class="sourceCode cell-code" id="cb233"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb233-1"><a href="#cb233-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MyDense(keras.layers.Layer):</span>
<span id="cb233-2"><a href="#cb233-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, units, activation<span class="op">=</span><span class="va">None</span>, <span class="op">**</span>kwargs):</span>
<span id="cb233-3"><a href="#cb233-3" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>(<span class="op">**</span>kwargs)</span>
<span id="cb233-4"><a href="#cb233-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.units <span class="op">=</span> units</span>
<span id="cb233-5"><a href="#cb233-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.activation <span class="op">=</span> keras.activations.get(activation)</span>
<span id="cb233-6"><a href="#cb233-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb233-7"><a href="#cb233-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> build(<span class="va">self</span>, batch_input_shape):</span>
<span id="cb233-8"><a href="#cb233-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.kernel <span class="op">=</span> <span class="va">self</span>.add_weight(</span>
<span id="cb233-9"><a href="#cb233-9" aria-hidden="true" tabindex="-1"></a>            name<span class="op">=</span><span class="st">"kernel"</span>, shape<span class="op">=</span>[batch_input_shape[<span class="op">-</span><span class="dv">1</span>], <span class="va">self</span>.units],</span>
<span id="cb233-10"><a href="#cb233-10" aria-hidden="true" tabindex="-1"></a>            initializer<span class="op">=</span><span class="st">"glorot_normal"</span>)</span>
<span id="cb233-11"><a href="#cb233-11" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.bias <span class="op">=</span> <span class="va">self</span>.add_weight(</span>
<span id="cb233-12"><a href="#cb233-12" aria-hidden="true" tabindex="-1"></a>            name<span class="op">=</span><span class="st">"bias"</span>, shape<span class="op">=</span>[<span class="va">self</span>.units], initializer<span class="op">=</span><span class="st">"zeros"</span>)</span>
<span id="cb233-13"><a href="#cb233-13" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().build(batch_input_shape) <span class="co"># must be at the end</span></span>
<span id="cb233-14"><a href="#cb233-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb233-15"><a href="#cb233-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> call(<span class="va">self</span>, X):</span>
<span id="cb233-16"><a href="#cb233-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.activation(X <span class="op">@</span> <span class="va">self</span>.kernel <span class="op">+</span> <span class="va">self</span>.bias)</span>
<span id="cb233-17"><a href="#cb233-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb233-18"><a href="#cb233-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> compute_output_shape(<span class="va">self</span>, batch_input_shape):</span>
<span id="cb233-19"><a href="#cb233-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> tf.TensorShape(batch_input_shape.as_list()[:<span class="op">-</span><span class="dv">1</span>] <span class="op">+</span> [<span class="va">self</span>.units])</span>
<span id="cb233-20"><a href="#cb233-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb233-21"><a href="#cb233-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get_config(<span class="va">self</span>):</span>
<span id="cb233-22"><a href="#cb233-22" aria-hidden="true" tabindex="-1"></a>        base_config <span class="op">=</span> <span class="bu">super</span>().get_config()</span>
<span id="cb233-23"><a href="#cb233-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {<span class="op">**</span>base_config, <span class="st">"units"</span>: <span class="va">self</span>.units,</span>
<span id="cb233-24"><a href="#cb233-24" aria-hidden="true" tabindex="-1"></a>                <span class="st">"activation"</span>: keras.activations.serialize(<span class="va">self</span>.activation)}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-170" class="cell" data-execution_count="139">
<div class="sourceCode cell-code" id="cb234"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb234-1"><a href="#cb234-1" aria-hidden="true" tabindex="-1"></a>keras.backend.clear_session()</span>
<span id="cb234-2"><a href="#cb234-2" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">42</span>)</span>
<span id="cb234-3"><a href="#cb234-3" aria-hidden="true" tabindex="-1"></a>tf.random.set_seed(<span class="dv">42</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-171" class="cell" data-execution_count="140">
<div class="sourceCode cell-code" id="cb235"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb235-1"><a href="#cb235-1" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> keras.models.Sequential([</span>
<span id="cb235-2"><a href="#cb235-2" aria-hidden="true" tabindex="-1"></a>    MyDense(<span class="dv">30</span>, activation<span class="op">=</span><span class="st">"relu"</span>, input_shape<span class="op">=</span>input_shape),</span>
<span id="cb235-3"><a href="#cb235-3" aria-hidden="true" tabindex="-1"></a>    MyDense(<span class="dv">1</span>)</span>
<span id="cb235-4"><a href="#cb235-4" aria-hidden="true" tabindex="-1"></a>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-172" class="cell" data-execution_count="141">
<div class="sourceCode cell-code" id="cb236"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb236-1"><a href="#cb236-1" aria-hidden="true" tabindex="-1"></a>model.<span class="bu">compile</span>(loss<span class="op">=</span><span class="st">"mse"</span>, optimizer<span class="op">=</span><span class="st">"nadam"</span>)</span>
<span id="cb236-2"><a href="#cb236-2" aria-hidden="true" tabindex="-1"></a>model.fit(X_train_scaled, y_train, epochs<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb236-3"><a href="#cb236-3" aria-hidden="true" tabindex="-1"></a>          validation_data<span class="op">=</span>(X_valid_scaled, y_valid))</span>
<span id="cb236-4"><a href="#cb236-4" aria-hidden="true" tabindex="-1"></a>model.evaluate(X_test_scaled, y_test)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch 1/2
363/363 [==============================] - 1s 898us/step - loss: 4.1268 - val_loss: 0.9472
Epoch 2/2
363/363 [==============================] - 0s 707us/step - loss: 0.7086 - val_loss: 0.6219
162/162 [==============================] - 0s 419us/step - loss: 0.5474</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="141">
<pre><code>0.5473727583885193</code></pre>
</div>
</div>
<div id="cell-173" class="cell" data-execution_count="142">
<div class="sourceCode cell-code" id="cb239"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb239-1"><a href="#cb239-1" aria-hidden="true" tabindex="-1"></a>model.save(<span class="st">"my_model_with_a_custom_layer.h5"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-174" class="cell" data-execution_count="143">
<div class="sourceCode cell-code" id="cb240"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb240-1"><a href="#cb240-1" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> keras.models.load_model(<span class="st">"my_model_with_a_custom_layer.h5"</span>,</span>
<span id="cb240-2"><a href="#cb240-2" aria-hidden="true" tabindex="-1"></a>                                custom_objects<span class="op">=</span>{<span class="st">"MyDense"</span>: MyDense})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-175" class="cell" data-execution_count="144">
<div class="sourceCode cell-code" id="cb241"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb241-1"><a href="#cb241-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MyMultiLayer(keras.layers.Layer):</span>
<span id="cb241-2"><a href="#cb241-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> call(<span class="va">self</span>, X):</span>
<span id="cb241-3"><a href="#cb241-3" aria-hidden="true" tabindex="-1"></a>        X1, X2 <span class="op">=</span> X</span>
<span id="cb241-4"><a href="#cb241-4" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"X1.shape: "</span>, X1.shape ,<span class="st">" X2.shape: "</span>, X2.shape) <span class="co"># Debugging of custom layer</span></span>
<span id="cb241-5"><a href="#cb241-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> X1 <span class="op">+</span> X2, X1 <span class="op">*</span> X2</span>
<span id="cb241-6"><a href="#cb241-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb241-7"><a href="#cb241-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> compute_output_shape(<span class="va">self</span>, batch_input_shape):</span>
<span id="cb241-8"><a href="#cb241-8" aria-hidden="true" tabindex="-1"></a>        batch_input_shape1, batch_input_shape2 <span class="op">=</span> batch_input_shape</span>
<span id="cb241-9"><a href="#cb241-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> [batch_input_shape1, batch_input_shape2]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Our custom layer can be called using the functional API like this:</p>
<div id="cell-177" class="cell" data-execution_count="145">
<div class="sourceCode cell-code" id="cb242"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb242-1"><a href="#cb242-1" aria-hidden="true" tabindex="-1"></a>inputs1 <span class="op">=</span> keras.layers.Input(shape<span class="op">=</span>[<span class="dv">2</span>])</span>
<span id="cb242-2"><a href="#cb242-2" aria-hidden="true" tabindex="-1"></a>inputs2 <span class="op">=</span> keras.layers.Input(shape<span class="op">=</span>[<span class="dv">2</span>])</span>
<span id="cb242-3"><a href="#cb242-3" aria-hidden="true" tabindex="-1"></a>outputs1, outputs2 <span class="op">=</span> MyMultiLayer()((inputs1, inputs2))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>X1.shape:  (None, 2)  X2.shape:  (None, 2)</code></pre>
</div>
</div>
<p>Note that the <code>call()</code> method receives symbolic inputs, whose shape is only partially specified (at this stage, we don’t know the batch size, which is why the first dimension is <code>None</code>):</p>
<p>We can also pass actual data to the custom layer. To test this, let’s split each dataset’s inputs into two parts, with four features each:</p>
<div id="cell-179" class="cell" data-execution_count="146">
<div class="sourceCode cell-code" id="cb244"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb244-1"><a href="#cb244-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> split_data(data):</span>
<span id="cb244-2"><a href="#cb244-2" aria-hidden="true" tabindex="-1"></a>    columns_count <span class="op">=</span> data.shape[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb244-3"><a href="#cb244-3" aria-hidden="true" tabindex="-1"></a>    half <span class="op">=</span> columns_count <span class="op">//</span> <span class="dv">2</span></span>
<span id="cb244-4"><a href="#cb244-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> data[:, :half], data[:, half:]</span>
<span id="cb244-5"><a href="#cb244-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb244-6"><a href="#cb244-6" aria-hidden="true" tabindex="-1"></a>X_train_scaled_A, X_train_scaled_B <span class="op">=</span> split_data(X_train_scaled)</span>
<span id="cb244-7"><a href="#cb244-7" aria-hidden="true" tabindex="-1"></a>X_valid_scaled_A, X_valid_scaled_B <span class="op">=</span> split_data(X_valid_scaled)</span>
<span id="cb244-8"><a href="#cb244-8" aria-hidden="true" tabindex="-1"></a>X_test_scaled_A, X_test_scaled_B <span class="op">=</span> split_data(X_test_scaled)</span>
<span id="cb244-9"><a href="#cb244-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb244-10"><a href="#cb244-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Printing the splitted data shapes</span></span>
<span id="cb244-11"><a href="#cb244-11" aria-hidden="true" tabindex="-1"></a>X_train_scaled_A.shape, X_train_scaled_B.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="146">
<pre><code>((11610, 4), (11610, 4))</code></pre>
</div>
</div>
<p>Now notice that the shapes are fully specified:</p>
<div id="cell-181" class="cell" data-execution_count="147">
<div class="sourceCode cell-code" id="cb246"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb246-1"><a href="#cb246-1" aria-hidden="true" tabindex="-1"></a>outputs1, outputs2 <span class="op">=</span> MyMultiLayer()((X_train_scaled_A, X_train_scaled_B))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>X1.shape:  (11610, 4)  X2.shape:  (11610, 4)</code></pre>
</div>
</div>
<p>Let’s build a more complete model using the functional API (this is just a toy example, don’t expect awesome performance):</p>
<div id="cell-183" class="cell" data-execution_count="148">
<div class="sourceCode cell-code" id="cb248"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb248-1"><a href="#cb248-1" aria-hidden="true" tabindex="-1"></a>keras.backend.clear_session()</span>
<span id="cb248-2"><a href="#cb248-2" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">42</span>)</span>
<span id="cb248-3"><a href="#cb248-3" aria-hidden="true" tabindex="-1"></a>tf.random.set_seed(<span class="dv">42</span>)</span>
<span id="cb248-4"><a href="#cb248-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb248-5"><a href="#cb248-5" aria-hidden="true" tabindex="-1"></a>input_A <span class="op">=</span> keras.layers.Input(shape<span class="op">=</span>X_train_scaled_A.shape[<span class="op">-</span><span class="dv">1</span>])</span>
<span id="cb248-6"><a href="#cb248-6" aria-hidden="true" tabindex="-1"></a>input_B <span class="op">=</span> keras.layers.Input(shape<span class="op">=</span>X_train_scaled_B.shape[<span class="op">-</span><span class="dv">1</span>])</span>
<span id="cb248-7"><a href="#cb248-7" aria-hidden="true" tabindex="-1"></a>hidden_A, hidden_B <span class="op">=</span> MyMultiLayer()((input_A, input_B))</span>
<span id="cb248-8"><a href="#cb248-8" aria-hidden="true" tabindex="-1"></a>hidden_A <span class="op">=</span> keras.layers.Dense(<span class="dv">30</span>, activation<span class="op">=</span><span class="st">'selu'</span>)(hidden_A)</span>
<span id="cb248-9"><a href="#cb248-9" aria-hidden="true" tabindex="-1"></a>hidden_B <span class="op">=</span> keras.layers.Dense(<span class="dv">30</span>, activation<span class="op">=</span><span class="st">'selu'</span>)(hidden_B)</span>
<span id="cb248-10"><a href="#cb248-10" aria-hidden="true" tabindex="-1"></a>concat <span class="op">=</span> keras.layers.Concatenate()((hidden_A, hidden_B))</span>
<span id="cb248-11"><a href="#cb248-11" aria-hidden="true" tabindex="-1"></a>output <span class="op">=</span> keras.layers.Dense(<span class="dv">1</span>)(concat)</span>
<span id="cb248-12"><a href="#cb248-12" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> keras.models.Model(inputs<span class="op">=</span>[input_A, input_B], outputs<span class="op">=</span>[output])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>X1.shape:  (None, 4)  X2.shape:  (None, 4)</code></pre>
</div>
</div>
<div id="cell-184" class="cell" data-execution_count="149">
<div class="sourceCode cell-code" id="cb250"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb250-1"><a href="#cb250-1" aria-hidden="true" tabindex="-1"></a>model.<span class="bu">compile</span>(loss<span class="op">=</span><span class="st">'mse'</span>, optimizer<span class="op">=</span><span class="st">'nadam'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-185" class="cell" data-execution_count="150">
<div class="sourceCode cell-code" id="cb251"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb251-1"><a href="#cb251-1" aria-hidden="true" tabindex="-1"></a>model.fit((X_train_scaled_A, X_train_scaled_B), y_train, epochs<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb251-2"><a href="#cb251-2" aria-hidden="true" tabindex="-1"></a>          validation_data<span class="op">=</span>((X_valid_scaled_A, X_valid_scaled_B), y_valid))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch 1/2
X1.shape:  (None, 4)  X2.shape:  (None, 4)
X1.shape:  (None, 4)  X2.shape:  (None, 4)
356/363 [============================&gt;.] - ETA: 0s - loss: 3.6305X1.shape:  (None, 4)  X2.shape:  (None, 4)
363/363 [==============================] - 1s 1ms/step - loss: 3.5973 - val_loss: 1.3630
Epoch 2/2
363/363 [==============================] - 0s 1ms/step - loss: 1.0132 - val_loss: 0.9773</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="150">
<pre><code>&lt;tensorflow.python.keras.callbacks.History at 0x7fddd0cb4bd0&gt;</code></pre>
</div>
</div>
<p>Now let’s create a layer with a different behavior during training and testing:</p>
<div id="cell-187" class="cell" data-execution_count="151">
<div class="sourceCode cell-code" id="cb254"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb254-1"><a href="#cb254-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> AddGaussianNoise(keras.layers.Layer):</span>
<span id="cb254-2"><a href="#cb254-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, stddev, <span class="op">**</span>kwargs):</span>
<span id="cb254-3"><a href="#cb254-3" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>(<span class="op">**</span>kwargs)</span>
<span id="cb254-4"><a href="#cb254-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.stddev <span class="op">=</span> stddev</span>
<span id="cb254-5"><a href="#cb254-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb254-6"><a href="#cb254-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> call(<span class="va">self</span>, X, training<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb254-7"><a href="#cb254-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> training:</span>
<span id="cb254-8"><a href="#cb254-8" aria-hidden="true" tabindex="-1"></a>            noise <span class="op">=</span> tf.random.normal(tf.shape(X), stddev<span class="op">=</span><span class="va">self</span>.stddev)</span>
<span id="cb254-9"><a href="#cb254-9" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> X <span class="op">+</span> noise</span>
<span id="cb254-10"><a href="#cb254-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb254-11"><a href="#cb254-11" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> X</span>
<span id="cb254-12"><a href="#cb254-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb254-13"><a href="#cb254-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> compute_output_shape(<span class="va">self</span>, batch_input_shape):</span>
<span id="cb254-14"><a href="#cb254-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> batch_input_shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here’s a simple model that uses this custom layer:</p>
<div id="cell-189" class="cell" data-execution_count="152">
<div class="sourceCode cell-code" id="cb255"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb255-1"><a href="#cb255-1" aria-hidden="true" tabindex="-1"></a>keras.backend.clear_session()</span>
<span id="cb255-2"><a href="#cb255-2" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">42</span>)</span>
<span id="cb255-3"><a href="#cb255-3" aria-hidden="true" tabindex="-1"></a>tf.random.set_seed(<span class="dv">42</span>)</span>
<span id="cb255-4"><a href="#cb255-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb255-5"><a href="#cb255-5" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> keras.models.Sequential([</span>
<span id="cb255-6"><a href="#cb255-6" aria-hidden="true" tabindex="-1"></a>    AddGaussianNoise(stddev<span class="op">=</span><span class="fl">1.0</span>),</span>
<span id="cb255-7"><a href="#cb255-7" aria-hidden="true" tabindex="-1"></a>    keras.layers.Dense(<span class="dv">30</span>, activation<span class="op">=</span><span class="st">"selu"</span>),</span>
<span id="cb255-8"><a href="#cb255-8" aria-hidden="true" tabindex="-1"></a>    keras.layers.Dense(<span class="dv">1</span>)</span>
<span id="cb255-9"><a href="#cb255-9" aria-hidden="true" tabindex="-1"></a>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-190" class="cell" data-execution_count="153">
<div class="sourceCode cell-code" id="cb256"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb256-1"><a href="#cb256-1" aria-hidden="true" tabindex="-1"></a>model.<span class="bu">compile</span>(loss<span class="op">=</span><span class="st">"mse"</span>, optimizer<span class="op">=</span><span class="st">"nadam"</span>)</span>
<span id="cb256-2"><a href="#cb256-2" aria-hidden="true" tabindex="-1"></a>model.fit(X_train_scaled, y_train, epochs<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb256-3"><a href="#cb256-3" aria-hidden="true" tabindex="-1"></a>          validation_data<span class="op">=</span>(X_valid_scaled, y_valid))</span>
<span id="cb256-4"><a href="#cb256-4" aria-hidden="true" tabindex="-1"></a>model.evaluate(X_test_scaled, y_test)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch 1/2
363/363 [==============================] - 1s 892us/step - loss: 3.7869 - val_loss: 7.6082
Epoch 2/2
363/363 [==============================] - 0s 685us/step - loss: 1.2375 - val_loss: 4.4597
162/162 [==============================] - 0s 416us/step - loss: 0.7560</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="153">
<pre><code>0.7559615969657898</code></pre>
</div>
</div>
</section>
<section id="custom-models" class="level2">
<h2 class="anchored" data-anchor-id="custom-models">Custom Models</h2>
<div id="cell-192" class="cell" data-execution_count="154">
<div class="sourceCode cell-code" id="cb259"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb259-1"><a href="#cb259-1" aria-hidden="true" tabindex="-1"></a>X_new_scaled <span class="op">=</span> X_test_scaled</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-193" class="cell" data-execution_count="155">
<div class="sourceCode cell-code" id="cb260"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb260-1"><a href="#cb260-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ResidualBlock(keras.layers.Layer):</span>
<span id="cb260-2"><a href="#cb260-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, n_layers, n_neurons, <span class="op">**</span>kwargs):</span>
<span id="cb260-3"><a href="#cb260-3" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>(<span class="op">**</span>kwargs)</span>
<span id="cb260-4"><a href="#cb260-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.hidden <span class="op">=</span> [keras.layers.Dense(n_neurons, activation<span class="op">=</span><span class="st">"elu"</span>,</span>
<span id="cb260-5"><a href="#cb260-5" aria-hidden="true" tabindex="-1"></a>                                          kernel_initializer<span class="op">=</span><span class="st">"he_normal"</span>)</span>
<span id="cb260-6"><a href="#cb260-6" aria-hidden="true" tabindex="-1"></a>                       <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(n_layers)]</span>
<span id="cb260-7"><a href="#cb260-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb260-8"><a href="#cb260-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> call(<span class="va">self</span>, inputs):</span>
<span id="cb260-9"><a href="#cb260-9" aria-hidden="true" tabindex="-1"></a>        Z <span class="op">=</span> inputs</span>
<span id="cb260-10"><a href="#cb260-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> layer <span class="kw">in</span> <span class="va">self</span>.hidden:</span>
<span id="cb260-11"><a href="#cb260-11" aria-hidden="true" tabindex="-1"></a>            Z <span class="op">=</span> layer(Z)</span>
<span id="cb260-12"><a href="#cb260-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> inputs <span class="op">+</span> Z</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-194" class="cell" data-execution_count="156">
<div class="sourceCode cell-code" id="cb261"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb261-1"><a href="#cb261-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ResidualRegressor(keras.models.Model):</span>
<span id="cb261-2"><a href="#cb261-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, output_dim, <span class="op">**</span>kwargs):</span>
<span id="cb261-3"><a href="#cb261-3" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>(<span class="op">**</span>kwargs)</span>
<span id="cb261-4"><a href="#cb261-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.hidden1 <span class="op">=</span> keras.layers.Dense(<span class="dv">30</span>, activation<span class="op">=</span><span class="st">"elu"</span>,</span>
<span id="cb261-5"><a href="#cb261-5" aria-hidden="true" tabindex="-1"></a>                                          kernel_initializer<span class="op">=</span><span class="st">"he_normal"</span>)</span>
<span id="cb261-6"><a href="#cb261-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.block1 <span class="op">=</span> ResidualBlock(<span class="dv">2</span>, <span class="dv">30</span>)</span>
<span id="cb261-7"><a href="#cb261-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.block2 <span class="op">=</span> ResidualBlock(<span class="dv">2</span>, <span class="dv">30</span>)</span>
<span id="cb261-8"><a href="#cb261-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.out <span class="op">=</span> keras.layers.Dense(output_dim)</span>
<span id="cb261-9"><a href="#cb261-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb261-10"><a href="#cb261-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> call(<span class="va">self</span>, inputs):</span>
<span id="cb261-11"><a href="#cb261-11" aria-hidden="true" tabindex="-1"></a>        Z <span class="op">=</span> <span class="va">self</span>.hidden1(inputs)</span>
<span id="cb261-12"><a href="#cb261-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span> <span class="op">+</span> <span class="dv">3</span>):</span>
<span id="cb261-13"><a href="#cb261-13" aria-hidden="true" tabindex="-1"></a>            Z <span class="op">=</span> <span class="va">self</span>.block1(Z)</span>
<span id="cb261-14"><a href="#cb261-14" aria-hidden="true" tabindex="-1"></a>        Z <span class="op">=</span> <span class="va">self</span>.block2(Z)</span>
<span id="cb261-15"><a href="#cb261-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.out(Z)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-195" class="cell" data-execution_count="157">
<div class="sourceCode cell-code" id="cb262"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb262-1"><a href="#cb262-1" aria-hidden="true" tabindex="-1"></a>keras.backend.clear_session()</span>
<span id="cb262-2"><a href="#cb262-2" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">42</span>)</span>
<span id="cb262-3"><a href="#cb262-3" aria-hidden="true" tabindex="-1"></a>tf.random.set_seed(<span class="dv">42</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-196" class="cell" data-execution_count="158">
<div class="sourceCode cell-code" id="cb263"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb263-1"><a href="#cb263-1" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> ResidualRegressor(<span class="dv">1</span>)</span>
<span id="cb263-2"><a href="#cb263-2" aria-hidden="true" tabindex="-1"></a>model.<span class="bu">compile</span>(loss<span class="op">=</span><span class="st">"mse"</span>, optimizer<span class="op">=</span><span class="st">"nadam"</span>)</span>
<span id="cb263-3"><a href="#cb263-3" aria-hidden="true" tabindex="-1"></a>history <span class="op">=</span> model.fit(X_train_scaled, y_train, epochs<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb263-4"><a href="#cb263-4" aria-hidden="true" tabindex="-1"></a>score <span class="op">=</span> model.evaluate(X_test_scaled, y_test)</span>
<span id="cb263-5"><a href="#cb263-5" aria-hidden="true" tabindex="-1"></a>y_pred <span class="op">=</span> model.predict(X_new_scaled)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch 1/5
363/363 [==============================] - 1s 837us/step - loss: 22.7478
Epoch 2/5
363/363 [==============================] - 0s 739us/step - loss: 1.2735
Epoch 3/5
363/363 [==============================] - 0s 737us/step - loss: 0.9792
Epoch 4/5
363/363 [==============================] - 0s 740us/step - loss: 0.5905
Epoch 5/5
363/363 [==============================] - 0s 739us/step - loss: 0.5544
162/162 [==============================] - 0s 526us/step - loss: 0.6513</code></pre>
</div>
</div>
<div id="cell-197" class="cell" data-execution_count="159">
<div class="sourceCode cell-code" id="cb265"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb265-1"><a href="#cb265-1" aria-hidden="true" tabindex="-1"></a>model.save(<span class="st">"my_custom_model.ckpt"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>INFO:tensorflow:Assets written to: my_custom_model.ckpt/assets</code></pre>
</div>
</div>
<div id="cell-198" class="cell" data-execution_count="160">
<div class="sourceCode cell-code" id="cb267"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb267-1"><a href="#cb267-1" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> keras.models.load_model(<span class="st">"my_custom_model.ckpt"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-199" class="cell" data-execution_count="161">
<div class="sourceCode cell-code" id="cb268"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb268-1"><a href="#cb268-1" aria-hidden="true" tabindex="-1"></a>history <span class="op">=</span> model.fit(X_train_scaled, y_train, epochs<span class="op">=</span><span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch 1/5
363/363 [==============================] - 1s 851us/step - loss: 0.9476
Epoch 2/5
363/363 [==============================] - 0s 736us/step - loss: 0.6998
Epoch 3/5
363/363 [==============================] - 0s 737us/step - loss: 0.4668
Epoch 4/5
363/363 [==============================] - 0s 758us/step - loss: 0.4818
Epoch 5/5
363/363 [==============================] - 0s 756us/step - loss: 0.4591</code></pre>
</div>
</div>
<p>We could have defined the model using the sequential API instead:</p>
<div id="cell-201" class="cell" data-execution_count="162">
<div class="sourceCode cell-code" id="cb270"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb270-1"><a href="#cb270-1" aria-hidden="true" tabindex="-1"></a>keras.backend.clear_session()</span>
<span id="cb270-2"><a href="#cb270-2" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">42</span>)</span>
<span id="cb270-3"><a href="#cb270-3" aria-hidden="true" tabindex="-1"></a>tf.random.set_seed(<span class="dv">42</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-202" class="cell" data-execution_count="163">
<div class="sourceCode cell-code" id="cb271"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb271-1"><a href="#cb271-1" aria-hidden="true" tabindex="-1"></a>block1 <span class="op">=</span> ResidualBlock(<span class="dv">2</span>, <span class="dv">30</span>)</span>
<span id="cb271-2"><a href="#cb271-2" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> keras.models.Sequential([</span>
<span id="cb271-3"><a href="#cb271-3" aria-hidden="true" tabindex="-1"></a>    keras.layers.Dense(<span class="dv">30</span>, activation<span class="op">=</span><span class="st">"elu"</span>, kernel_initializer<span class="op">=</span><span class="st">"he_normal"</span>),</span>
<span id="cb271-4"><a href="#cb271-4" aria-hidden="true" tabindex="-1"></a>    block1, block1, block1, block1,</span>
<span id="cb271-5"><a href="#cb271-5" aria-hidden="true" tabindex="-1"></a>    ResidualBlock(<span class="dv">2</span>, <span class="dv">30</span>),</span>
<span id="cb271-6"><a href="#cb271-6" aria-hidden="true" tabindex="-1"></a>    keras.layers.Dense(<span class="dv">1</span>)</span>
<span id="cb271-7"><a href="#cb271-7" aria-hidden="true" tabindex="-1"></a>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-203" class="cell" data-execution_count="164">
<div class="sourceCode cell-code" id="cb272"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb272-1"><a href="#cb272-1" aria-hidden="true" tabindex="-1"></a>model.<span class="bu">compile</span>(loss<span class="op">=</span><span class="st">"mse"</span>, optimizer<span class="op">=</span><span class="st">"nadam"</span>)</span>
<span id="cb272-2"><a href="#cb272-2" aria-hidden="true" tabindex="-1"></a>history <span class="op">=</span> model.fit(X_train_scaled, y_train, epochs<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb272-3"><a href="#cb272-3" aria-hidden="true" tabindex="-1"></a>score <span class="op">=</span> model.evaluate(X_test_scaled, y_test)</span>
<span id="cb272-4"><a href="#cb272-4" aria-hidden="true" tabindex="-1"></a>y_pred <span class="op">=</span> model.predict(X_new_scaled)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch 1/5
363/363 [==============================] - 1s 709us/step - loss: 1.5508
Epoch 2/5
363/363 [==============================] - 0s 645us/step - loss: 0.5562
Epoch 3/5
363/363 [==============================] - 0s 625us/step - loss: 0.6406
Epoch 4/5
363/363 [==============================] - 0s 636us/step - loss: 0.3759
Epoch 5/5
363/363 [==============================] - 0s 623us/step - loss: 0.3875
162/162 [==============================] - 0s 463us/step - loss: 0.4852</code></pre>
</div>
</div>
</section>
<section id="losses-and-metrics-based-on-model-internals" class="level2">
<h2 class="anchored" data-anchor-id="losses-and-metrics-based-on-model-internals">Losses and Metrics Based on Model Internals</h2>
<p><strong>Note</strong>: the following code has two differences with the code in the book: 1. It creates a <code>keras.metrics.Mean()</code> metric in the constructor and uses it in the <code>call()</code> method to track the mean reconstruction loss. Since we only want to do this during training, we add a <code>training</code> argument to the <code>call()</code> method, and if <code>training</code> is <code>True</code>, then we update <code>reconstruction_mean</code> and we call <code>self.add_metric()</code> to ensure it’s displayed properly. 2. Due to an issue introduced in TF 2.2 (<a href="https://github.com/tensorflow/tensorflow/issues/46858">#46858</a>), we must not call <code>super().build()</code> inside the <code>build()</code> method.</p>
<div id="cell-206" class="cell" data-execution_count="165">
<div class="sourceCode cell-code" id="cb274"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb274-1"><a href="#cb274-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ReconstructingRegressor(keras.Model):</span>
<span id="cb274-2"><a href="#cb274-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, output_dim, <span class="op">**</span>kwargs):</span>
<span id="cb274-3"><a href="#cb274-3" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>(<span class="op">**</span>kwargs)</span>
<span id="cb274-4"><a href="#cb274-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.hidden <span class="op">=</span> [keras.layers.Dense(<span class="dv">30</span>, activation<span class="op">=</span><span class="st">"selu"</span>,</span>
<span id="cb274-5"><a href="#cb274-5" aria-hidden="true" tabindex="-1"></a>                                          kernel_initializer<span class="op">=</span><span class="st">"lecun_normal"</span>)</span>
<span id="cb274-6"><a href="#cb274-6" aria-hidden="true" tabindex="-1"></a>                       <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">5</span>)]</span>
<span id="cb274-7"><a href="#cb274-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.out <span class="op">=</span> keras.layers.Dense(output_dim)</span>
<span id="cb274-8"><a href="#cb274-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.reconstruction_mean <span class="op">=</span> keras.metrics.Mean(name<span class="op">=</span><span class="st">"reconstruction_error"</span>)</span>
<span id="cb274-9"><a href="#cb274-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb274-10"><a href="#cb274-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> build(<span class="va">self</span>, batch_input_shape):</span>
<span id="cb274-11"><a href="#cb274-11" aria-hidden="true" tabindex="-1"></a>        n_inputs <span class="op">=</span> batch_input_shape[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb274-12"><a href="#cb274-12" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.reconstruct <span class="op">=</span> keras.layers.Dense(n_inputs)</span>
<span id="cb274-13"><a href="#cb274-13" aria-hidden="true" tabindex="-1"></a>        <span class="co">#super().build(batch_input_shape)</span></span>
<span id="cb274-14"><a href="#cb274-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb274-15"><a href="#cb274-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> call(<span class="va">self</span>, inputs, training<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb274-16"><a href="#cb274-16" aria-hidden="true" tabindex="-1"></a>        Z <span class="op">=</span> inputs</span>
<span id="cb274-17"><a href="#cb274-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> layer <span class="kw">in</span> <span class="va">self</span>.hidden:</span>
<span id="cb274-18"><a href="#cb274-18" aria-hidden="true" tabindex="-1"></a>            Z <span class="op">=</span> layer(Z)</span>
<span id="cb274-19"><a href="#cb274-19" aria-hidden="true" tabindex="-1"></a>        reconstruction <span class="op">=</span> <span class="va">self</span>.reconstruct(Z)</span>
<span id="cb274-20"><a href="#cb274-20" aria-hidden="true" tabindex="-1"></a>        recon_loss <span class="op">=</span> tf.reduce_mean(tf.square(reconstruction <span class="op">-</span> inputs))</span>
<span id="cb274-21"><a href="#cb274-21" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.add_loss(<span class="fl">0.05</span> <span class="op">*</span> recon_loss)</span>
<span id="cb274-22"><a href="#cb274-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> training:</span>
<span id="cb274-23"><a href="#cb274-23" aria-hidden="true" tabindex="-1"></a>            result <span class="op">=</span> <span class="va">self</span>.reconstruction_mean(recon_loss)</span>
<span id="cb274-24"><a href="#cb274-24" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.add_metric(result)</span>
<span id="cb274-25"><a href="#cb274-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.out(Z)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-207" class="cell" data-execution_count="166">
<div class="sourceCode cell-code" id="cb275"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb275-1"><a href="#cb275-1" aria-hidden="true" tabindex="-1"></a>keras.backend.clear_session()</span>
<span id="cb275-2"><a href="#cb275-2" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">42</span>)</span>
<span id="cb275-3"><a href="#cb275-3" aria-hidden="true" tabindex="-1"></a>tf.random.set_seed(<span class="dv">42</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-208" class="cell" data-execution_count="167">
<div class="sourceCode cell-code" id="cb276"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb276-1"><a href="#cb276-1" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> ReconstructingRegressor(<span class="dv">1</span>)</span>
<span id="cb276-2"><a href="#cb276-2" aria-hidden="true" tabindex="-1"></a>model.<span class="bu">compile</span>(loss<span class="op">=</span><span class="st">"mse"</span>, optimizer<span class="op">=</span><span class="st">"nadam"</span>)</span>
<span id="cb276-3"><a href="#cb276-3" aria-hidden="true" tabindex="-1"></a>history <span class="op">=</span> model.fit(X_train_scaled, y_train, epochs<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb276-4"><a href="#cb276-4" aria-hidden="true" tabindex="-1"></a>y_pred <span class="op">=</span> model.predict(X_test_scaled)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch 1/2
363/363 [==============================] - 1s 810us/step - loss: 1.6313 - reconstruction_error: 1.0474
Epoch 2/2
363/363 [==============================] - 0s 683us/step - loss: 0.4536 - reconstruction_error: 0.4022</code></pre>
</div>
</div>
</section>
<section id="computing-gradients-with-autodiff" class="level2">
<h2 class="anchored" data-anchor-id="computing-gradients-with-autodiff">Computing Gradients with Autodiff</h2>
<div id="cell-210" class="cell" data-execution_count="168">
<div class="sourceCode cell-code" id="cb278"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb278-1"><a href="#cb278-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> f(w1, w2):</span>
<span id="cb278-2"><a href="#cb278-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">3</span> <span class="op">*</span> w1 <span class="op">**</span> <span class="dv">2</span> <span class="op">+</span> <span class="dv">2</span> <span class="op">*</span> w1 <span class="op">*</span> w2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-211" class="cell" data-execution_count="169">
<div class="sourceCode cell-code" id="cb279"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb279-1"><a href="#cb279-1" aria-hidden="true" tabindex="-1"></a>w1, w2 <span class="op">=</span> <span class="dv">5</span>, <span class="dv">3</span></span>
<span id="cb279-2"><a href="#cb279-2" aria-hidden="true" tabindex="-1"></a>eps <span class="op">=</span> <span class="fl">1e-6</span></span>
<span id="cb279-3"><a href="#cb279-3" aria-hidden="true" tabindex="-1"></a>(f(w1 <span class="op">+</span> eps, w2) <span class="op">-</span> f(w1, w2)) <span class="op">/</span> eps</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="169">
<pre><code>36.000003007075065</code></pre>
</div>
</div>
<div id="cell-212" class="cell" data-execution_count="170">
<div class="sourceCode cell-code" id="cb281"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb281-1"><a href="#cb281-1" aria-hidden="true" tabindex="-1"></a>(f(w1, w2 <span class="op">+</span> eps) <span class="op">-</span> f(w1, w2)) <span class="op">/</span> eps</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="170">
<pre><code>10.000000003174137</code></pre>
</div>
</div>
<div id="cell-213" class="cell" data-execution_count="171">
<div class="sourceCode cell-code" id="cb283"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb283-1"><a href="#cb283-1" aria-hidden="true" tabindex="-1"></a>w1, w2 <span class="op">=</span> tf.Variable(<span class="fl">5.</span>), tf.Variable(<span class="fl">3.</span>)</span>
<span id="cb283-2"><a href="#cb283-2" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> tf.GradientTape() <span class="im">as</span> tape:</span>
<span id="cb283-3"><a href="#cb283-3" aria-hidden="true" tabindex="-1"></a>    z <span class="op">=</span> f(w1, w2)</span>
<span id="cb283-4"><a href="#cb283-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb283-5"><a href="#cb283-5" aria-hidden="true" tabindex="-1"></a>gradients <span class="op">=</span> tape.gradient(z, [w1, w2])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-214" class="cell" data-execution_count="172">
<div class="sourceCode cell-code" id="cb284"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb284-1"><a href="#cb284-1" aria-hidden="true" tabindex="-1"></a>gradients</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="172">
<pre><code>[&lt;tf.Tensor: shape=(), dtype=float32, numpy=36.0&gt;,
 &lt;tf.Tensor: shape=(), dtype=float32, numpy=10.0&gt;]</code></pre>
</div>
</div>
<div id="cell-215" class="cell" data-execution_count="173">
<div class="sourceCode cell-code" id="cb286"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb286-1"><a href="#cb286-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> tf.GradientTape() <span class="im">as</span> tape:</span>
<span id="cb286-2"><a href="#cb286-2" aria-hidden="true" tabindex="-1"></a>    z <span class="op">=</span> f(w1, w2)</span>
<span id="cb286-3"><a href="#cb286-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb286-4"><a href="#cb286-4" aria-hidden="true" tabindex="-1"></a>dz_dw1 <span class="op">=</span> tape.gradient(z, w1)</span>
<span id="cb286-5"><a href="#cb286-5" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb286-6"><a href="#cb286-6" aria-hidden="true" tabindex="-1"></a>    dz_dw2 <span class="op">=</span> tape.gradient(z, w2)</span>
<span id="cb286-7"><a href="#cb286-7" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">RuntimeError</span> <span class="im">as</span> ex:</span>
<span id="cb286-8"><a href="#cb286-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(ex)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>A non-persistent GradientTape can only be used to compute one set of gradients (or jacobians)</code></pre>
</div>
</div>
<div id="cell-216" class="cell" data-execution_count="174">
<div class="sourceCode cell-code" id="cb288"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb288-1"><a href="#cb288-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> tf.GradientTape(persistent<span class="op">=</span><span class="va">True</span>) <span class="im">as</span> tape:</span>
<span id="cb288-2"><a href="#cb288-2" aria-hidden="true" tabindex="-1"></a>    z <span class="op">=</span> f(w1, w2)</span>
<span id="cb288-3"><a href="#cb288-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb288-4"><a href="#cb288-4" aria-hidden="true" tabindex="-1"></a>dz_dw1 <span class="op">=</span> tape.gradient(z, w1)</span>
<span id="cb288-5"><a href="#cb288-5" aria-hidden="true" tabindex="-1"></a>dz_dw2 <span class="op">=</span> tape.gradient(z, w2) <span class="co"># works now!</span></span>
<span id="cb288-6"><a href="#cb288-6" aria-hidden="true" tabindex="-1"></a><span class="kw">del</span> tape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-217" class="cell" data-execution_count="175">
<div class="sourceCode cell-code" id="cb289"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb289-1"><a href="#cb289-1" aria-hidden="true" tabindex="-1"></a>dz_dw1, dz_dw2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="175">
<pre><code>(&lt;tf.Tensor: shape=(), dtype=float32, numpy=36.0&gt;,
 &lt;tf.Tensor: shape=(), dtype=float32, numpy=10.0&gt;)</code></pre>
</div>
</div>
<div id="cell-218" class="cell" data-execution_count="176">
<div class="sourceCode cell-code" id="cb291"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb291-1"><a href="#cb291-1" aria-hidden="true" tabindex="-1"></a>c1, c2 <span class="op">=</span> tf.constant(<span class="fl">5.</span>), tf.constant(<span class="fl">3.</span>)</span>
<span id="cb291-2"><a href="#cb291-2" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> tf.GradientTape() <span class="im">as</span> tape:</span>
<span id="cb291-3"><a href="#cb291-3" aria-hidden="true" tabindex="-1"></a>    z <span class="op">=</span> f(c1, c2)</span>
<span id="cb291-4"><a href="#cb291-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb291-5"><a href="#cb291-5" aria-hidden="true" tabindex="-1"></a>gradients <span class="op">=</span> tape.gradient(z, [c1, c2])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-219" class="cell" data-execution_count="177">
<div class="sourceCode cell-code" id="cb292"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb292-1"><a href="#cb292-1" aria-hidden="true" tabindex="-1"></a>gradients</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="177">
<pre><code>[None, None]</code></pre>
</div>
</div>
<div id="cell-220" class="cell" data-execution_count="178">
<div class="sourceCode cell-code" id="cb294"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb294-1"><a href="#cb294-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> tf.GradientTape() <span class="im">as</span> tape:</span>
<span id="cb294-2"><a href="#cb294-2" aria-hidden="true" tabindex="-1"></a>    tape.watch(c1)</span>
<span id="cb294-3"><a href="#cb294-3" aria-hidden="true" tabindex="-1"></a>    tape.watch(c2)</span>
<span id="cb294-4"><a href="#cb294-4" aria-hidden="true" tabindex="-1"></a>    z <span class="op">=</span> f(c1, c2)</span>
<span id="cb294-5"><a href="#cb294-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb294-6"><a href="#cb294-6" aria-hidden="true" tabindex="-1"></a>gradients <span class="op">=</span> tape.gradient(z, [c1, c2])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-221" class="cell" data-execution_count="179">
<div class="sourceCode cell-code" id="cb295"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb295-1"><a href="#cb295-1" aria-hidden="true" tabindex="-1"></a>gradients</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="179">
<pre><code>[&lt;tf.Tensor: shape=(), dtype=float32, numpy=36.0&gt;,
 &lt;tf.Tensor: shape=(), dtype=float32, numpy=10.0&gt;]</code></pre>
</div>
</div>
<div id="cell-222" class="cell" data-execution_count="180">
<div class="sourceCode cell-code" id="cb297"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb297-1"><a href="#cb297-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> tf.GradientTape() <span class="im">as</span> tape:</span>
<span id="cb297-2"><a href="#cb297-2" aria-hidden="true" tabindex="-1"></a>    z1 <span class="op">=</span> f(w1, w2 <span class="op">+</span> <span class="fl">2.</span>)</span>
<span id="cb297-3"><a href="#cb297-3" aria-hidden="true" tabindex="-1"></a>    z2 <span class="op">=</span> f(w1, w2 <span class="op">+</span> <span class="fl">5.</span>)</span>
<span id="cb297-4"><a href="#cb297-4" aria-hidden="true" tabindex="-1"></a>    z3 <span class="op">=</span> f(w1, w2 <span class="op">+</span> <span class="fl">7.</span>)</span>
<span id="cb297-5"><a href="#cb297-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb297-6"><a href="#cb297-6" aria-hidden="true" tabindex="-1"></a>tape.gradient([z1, z2, z3], [w1, w2])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="180">
<pre><code>[&lt;tf.Tensor: shape=(), dtype=float32, numpy=136.0&gt;,
 &lt;tf.Tensor: shape=(), dtype=float32, numpy=30.0&gt;]</code></pre>
</div>
</div>
<div id="cell-223" class="cell" data-execution_count="181">
<div class="sourceCode cell-code" id="cb299"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb299-1"><a href="#cb299-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> tf.GradientTape(persistent<span class="op">=</span><span class="va">True</span>) <span class="im">as</span> tape:</span>
<span id="cb299-2"><a href="#cb299-2" aria-hidden="true" tabindex="-1"></a>    z1 <span class="op">=</span> f(w1, w2 <span class="op">+</span> <span class="fl">2.</span>)</span>
<span id="cb299-3"><a href="#cb299-3" aria-hidden="true" tabindex="-1"></a>    z2 <span class="op">=</span> f(w1, w2 <span class="op">+</span> <span class="fl">5.</span>)</span>
<span id="cb299-4"><a href="#cb299-4" aria-hidden="true" tabindex="-1"></a>    z3 <span class="op">=</span> f(w1, w2 <span class="op">+</span> <span class="fl">7.</span>)</span>
<span id="cb299-5"><a href="#cb299-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb299-6"><a href="#cb299-6" aria-hidden="true" tabindex="-1"></a>tf.reduce_sum(tf.stack([tape.gradient(z, [w1, w2]) <span class="cf">for</span> z <span class="kw">in</span> (z1, z2, z3)]), axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb299-7"><a href="#cb299-7" aria-hidden="true" tabindex="-1"></a><span class="kw">del</span> tape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-224" class="cell" data-execution_count="182">
<div class="sourceCode cell-code" id="cb300"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb300-1"><a href="#cb300-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> tf.GradientTape(persistent<span class="op">=</span><span class="va">True</span>) <span class="im">as</span> hessian_tape:</span>
<span id="cb300-2"><a href="#cb300-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> tf.GradientTape() <span class="im">as</span> jacobian_tape:</span>
<span id="cb300-3"><a href="#cb300-3" aria-hidden="true" tabindex="-1"></a>        z <span class="op">=</span> f(w1, w2)</span>
<span id="cb300-4"><a href="#cb300-4" aria-hidden="true" tabindex="-1"></a>    jacobians <span class="op">=</span> jacobian_tape.gradient(z, [w1, w2])</span>
<span id="cb300-5"><a href="#cb300-5" aria-hidden="true" tabindex="-1"></a>hessians <span class="op">=</span> [hessian_tape.gradient(jacobian, [w1, w2])</span>
<span id="cb300-6"><a href="#cb300-6" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> jacobian <span class="kw">in</span> jacobians]</span>
<span id="cb300-7"><a href="#cb300-7" aria-hidden="true" tabindex="-1"></a><span class="kw">del</span> hessian_tape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-225" class="cell" data-execution_count="183">
<div class="sourceCode cell-code" id="cb301"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb301-1"><a href="#cb301-1" aria-hidden="true" tabindex="-1"></a>jacobians</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="183">
<pre><code>[&lt;tf.Tensor: shape=(), dtype=float32, numpy=36.0&gt;,
 &lt;tf.Tensor: shape=(), dtype=float32, numpy=10.0&gt;]</code></pre>
</div>
</div>
<div id="cell-226" class="cell" data-execution_count="184">
<div class="sourceCode cell-code" id="cb303"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb303-1"><a href="#cb303-1" aria-hidden="true" tabindex="-1"></a>hessians</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="184">
<pre><code>[[&lt;tf.Tensor: shape=(), dtype=float32, numpy=6.0&gt;,
  &lt;tf.Tensor: shape=(), dtype=float32, numpy=2.0&gt;],
 [&lt;tf.Tensor: shape=(), dtype=float32, numpy=2.0&gt;, None]]</code></pre>
</div>
</div>
<div id="cell-227" class="cell" data-execution_count="185">
<div class="sourceCode cell-code" id="cb305"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb305-1"><a href="#cb305-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> f(w1, w2):</span>
<span id="cb305-2"><a href="#cb305-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">3</span> <span class="op">*</span> w1 <span class="op">**</span> <span class="dv">2</span> <span class="op">+</span> tf.stop_gradient(<span class="dv">2</span> <span class="op">*</span> w1 <span class="op">*</span> w2)</span>
<span id="cb305-3"><a href="#cb305-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb305-4"><a href="#cb305-4" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> tf.GradientTape() <span class="im">as</span> tape:</span>
<span id="cb305-5"><a href="#cb305-5" aria-hidden="true" tabindex="-1"></a>    z <span class="op">=</span> f(w1, w2)</span>
<span id="cb305-6"><a href="#cb305-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb305-7"><a href="#cb305-7" aria-hidden="true" tabindex="-1"></a>tape.gradient(z, [w1, w2])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="185">
<pre><code>[&lt;tf.Tensor: shape=(), dtype=float32, numpy=30.0&gt;, None]</code></pre>
</div>
</div>
<div id="cell-228" class="cell" data-execution_count="186">
<div class="sourceCode cell-code" id="cb307"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb307-1"><a href="#cb307-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> tf.Variable(<span class="fl">100.</span>)</span>
<span id="cb307-2"><a href="#cb307-2" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> tf.GradientTape() <span class="im">as</span> tape:</span>
<span id="cb307-3"><a href="#cb307-3" aria-hidden="true" tabindex="-1"></a>    z <span class="op">=</span> my_softplus(x)</span>
<span id="cb307-4"><a href="#cb307-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb307-5"><a href="#cb307-5" aria-hidden="true" tabindex="-1"></a>tape.gradient(z, [x])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="186">
<pre><code>[&lt;tf.Tensor: shape=(), dtype=float32, numpy=nan&gt;]</code></pre>
</div>
</div>
<div id="cell-229" class="cell" data-execution_count="187">
<div class="sourceCode cell-code" id="cb309"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb309-1"><a href="#cb309-1" aria-hidden="true" tabindex="-1"></a>tf.math.log(tf.exp(tf.constant(<span class="fl">30.</span>, dtype<span class="op">=</span>tf.float32)) <span class="op">+</span> <span class="fl">1.</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="187">
<pre><code>&lt;tf.Tensor: shape=(), dtype=float32, numpy=30.0&gt;</code></pre>
</div>
</div>
<div id="cell-230" class="cell" data-execution_count="188">
<div class="sourceCode cell-code" id="cb311"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb311-1"><a href="#cb311-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> tf.Variable([<span class="fl">100.</span>])</span>
<span id="cb311-2"><a href="#cb311-2" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> tf.GradientTape() <span class="im">as</span> tape:</span>
<span id="cb311-3"><a href="#cb311-3" aria-hidden="true" tabindex="-1"></a>    z <span class="op">=</span> my_softplus(x)</span>
<span id="cb311-4"><a href="#cb311-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb311-5"><a href="#cb311-5" aria-hidden="true" tabindex="-1"></a>tape.gradient(z, [x])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="188">
<pre><code>[&lt;tf.Tensor: shape=(1,), dtype=float32, numpy=array([nan], dtype=float32)&gt;]</code></pre>
</div>
</div>
<div id="cell-231" class="cell" data-execution_count="189">
<div class="sourceCode cell-code" id="cb313"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb313-1"><a href="#cb313-1" aria-hidden="true" tabindex="-1"></a><span class="at">@tf.custom_gradient</span></span>
<span id="cb313-2"><a href="#cb313-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> my_better_softplus(z):</span>
<span id="cb313-3"><a href="#cb313-3" aria-hidden="true" tabindex="-1"></a>    exp <span class="op">=</span> tf.exp(z)</span>
<span id="cb313-4"><a href="#cb313-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> my_softplus_gradients(grad):</span>
<span id="cb313-5"><a href="#cb313-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> grad <span class="op">/</span> (<span class="dv">1</span> <span class="op">+</span> <span class="dv">1</span> <span class="op">/</span> exp)</span>
<span id="cb313-6"><a href="#cb313-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> tf.math.log(exp <span class="op">+</span> <span class="dv">1</span>), my_softplus_gradients</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-232" class="cell" data-execution_count="190">
<div class="sourceCode cell-code" id="cb314"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb314-1"><a href="#cb314-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> my_better_softplus(z):</span>
<span id="cb314-2"><a href="#cb314-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> tf.where(z <span class="op">&gt;</span> <span class="fl">30.</span>, z, tf.math.log(tf.exp(z) <span class="op">+</span> <span class="fl">1.</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-233" class="cell" data-execution_count="191">
<div class="sourceCode cell-code" id="cb315"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb315-1"><a href="#cb315-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> tf.Variable([<span class="fl">1000.</span>])</span>
<span id="cb315-2"><a href="#cb315-2" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> tf.GradientTape() <span class="im">as</span> tape:</span>
<span id="cb315-3"><a href="#cb315-3" aria-hidden="true" tabindex="-1"></a>    z <span class="op">=</span> my_better_softplus(x)</span>
<span id="cb315-4"><a href="#cb315-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb315-5"><a href="#cb315-5" aria-hidden="true" tabindex="-1"></a>z, tape.gradient(z, [x])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="191">
<pre><code>(&lt;tf.Tensor: shape=(1,), dtype=float32, numpy=array([1000.], dtype=float32)&gt;,
 [&lt;tf.Tensor: shape=(1,), dtype=float32, numpy=array([nan], dtype=float32)&gt;])</code></pre>
</div>
</div>
</section>
</section>
<section id="custom-training-loops" class="level1">
<h1>Custom Training Loops</h1>
<div id="cell-235" class="cell" data-execution_count="192">
<div class="sourceCode cell-code" id="cb317"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb317-1"><a href="#cb317-1" aria-hidden="true" tabindex="-1"></a>keras.backend.clear_session()</span>
<span id="cb317-2"><a href="#cb317-2" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">42</span>)</span>
<span id="cb317-3"><a href="#cb317-3" aria-hidden="true" tabindex="-1"></a>tf.random.set_seed(<span class="dv">42</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-236" class="cell" data-execution_count="193">
<div class="sourceCode cell-code" id="cb318"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb318-1"><a href="#cb318-1" aria-hidden="true" tabindex="-1"></a>l2_reg <span class="op">=</span> keras.regularizers.l2(<span class="fl">0.05</span>)</span>
<span id="cb318-2"><a href="#cb318-2" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> keras.models.Sequential([</span>
<span id="cb318-3"><a href="#cb318-3" aria-hidden="true" tabindex="-1"></a>    keras.layers.Dense(<span class="dv">30</span>, activation<span class="op">=</span><span class="st">"elu"</span>, kernel_initializer<span class="op">=</span><span class="st">"he_normal"</span>,</span>
<span id="cb318-4"><a href="#cb318-4" aria-hidden="true" tabindex="-1"></a>                       kernel_regularizer<span class="op">=</span>l2_reg),</span>
<span id="cb318-5"><a href="#cb318-5" aria-hidden="true" tabindex="-1"></a>    keras.layers.Dense(<span class="dv">1</span>, kernel_regularizer<span class="op">=</span>l2_reg)</span>
<span id="cb318-6"><a href="#cb318-6" aria-hidden="true" tabindex="-1"></a>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-237" class="cell" data-execution_count="194">
<div class="sourceCode cell-code" id="cb319"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb319-1"><a href="#cb319-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> random_batch(X, y, batch_size<span class="op">=</span><span class="dv">32</span>):</span>
<span id="cb319-2"><a href="#cb319-2" aria-hidden="true" tabindex="-1"></a>    idx <span class="op">=</span> np.random.randint(<span class="bu">len</span>(X), size<span class="op">=</span>batch_size)</span>
<span id="cb319-3"><a href="#cb319-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> X[idx], y[idx]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-238" class="cell" data-execution_count="195">
<div class="sourceCode cell-code" id="cb320"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb320-1"><a href="#cb320-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> print_status_bar(iteration, total, loss, metrics<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb320-2"><a href="#cb320-2" aria-hidden="true" tabindex="-1"></a>    metrics <span class="op">=</span> <span class="st">" - "</span>.join([<span class="st">"</span><span class="sc">{}</span><span class="st">: </span><span class="sc">{:.4f}</span><span class="st">"</span>.<span class="bu">format</span>(m.name, m.result())</span>
<span id="cb320-3"><a href="#cb320-3" aria-hidden="true" tabindex="-1"></a>                         <span class="cf">for</span> m <span class="kw">in</span> [loss] <span class="op">+</span> (metrics <span class="kw">or</span> [])])</span>
<span id="cb320-4"><a href="#cb320-4" aria-hidden="true" tabindex="-1"></a>    end <span class="op">=</span> <span class="st">""</span> <span class="cf">if</span> iteration <span class="op">&lt;</span> total <span class="cf">else</span> <span class="st">"</span><span class="ch">\n</span><span class="st">"</span></span>
<span id="cb320-5"><a href="#cb320-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\r</span><span class="sc">{}</span><span class="st">/</span><span class="sc">{}</span><span class="st"> - "</span>.<span class="bu">format</span>(iteration, total) <span class="op">+</span> metrics,</span>
<span id="cb320-6"><a href="#cb320-6" aria-hidden="true" tabindex="-1"></a>          end<span class="op">=</span>end)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-239" class="cell" data-execution_count="196">
<div class="sourceCode cell-code" id="cb321"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb321-1"><a href="#cb321-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb321-2"><a href="#cb321-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb321-3"><a href="#cb321-3" aria-hidden="true" tabindex="-1"></a>mean_loss <span class="op">=</span> keras.metrics.Mean(name<span class="op">=</span><span class="st">"loss"</span>)</span>
<span id="cb321-4"><a href="#cb321-4" aria-hidden="true" tabindex="-1"></a>mean_square <span class="op">=</span> keras.metrics.Mean(name<span class="op">=</span><span class="st">"mean_square"</span>)</span>
<span id="cb321-5"><a href="#cb321-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">50</span> <span class="op">+</span> <span class="dv">1</span>):</span>
<span id="cb321-6"><a href="#cb321-6" aria-hidden="true" tabindex="-1"></a>    loss <span class="op">=</span> <span class="dv">1</span> <span class="op">/</span> i</span>
<span id="cb321-7"><a href="#cb321-7" aria-hidden="true" tabindex="-1"></a>    mean_loss(loss)</span>
<span id="cb321-8"><a href="#cb321-8" aria-hidden="true" tabindex="-1"></a>    mean_square(i <span class="op">**</span> <span class="dv">2</span>)</span>
<span id="cb321-9"><a href="#cb321-9" aria-hidden="true" tabindex="-1"></a>    print_status_bar(i, <span class="dv">50</span>, mean_loss, [mean_square])</span>
<span id="cb321-10"><a href="#cb321-10" aria-hidden="true" tabindex="-1"></a>    time.sleep(<span class="fl">0.05</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>50/50 - loss: 0.0900 - mean_square: 858.5000</code></pre>
</div>
</div>
<p>A fancier version with a progress bar:</p>
<div id="cell-241" class="cell" data-execution_count="197">
<div class="sourceCode cell-code" id="cb323"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb323-1"><a href="#cb323-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> progress_bar(iteration, total, size<span class="op">=</span><span class="dv">30</span>):</span>
<span id="cb323-2"><a href="#cb323-2" aria-hidden="true" tabindex="-1"></a>    running <span class="op">=</span> iteration <span class="op">&lt;</span> total</span>
<span id="cb323-3"><a href="#cb323-3" aria-hidden="true" tabindex="-1"></a>    c <span class="op">=</span> <span class="st">"&gt;"</span> <span class="cf">if</span> running <span class="cf">else</span> <span class="st">"="</span></span>
<span id="cb323-4"><a href="#cb323-4" aria-hidden="true" tabindex="-1"></a>    p <span class="op">=</span> (size <span class="op">-</span> <span class="dv">1</span>) <span class="op">*</span> iteration <span class="op">//</span> total</span>
<span id="cb323-5"><a href="#cb323-5" aria-hidden="true" tabindex="-1"></a>    fmt <span class="op">=</span> <span class="st">"</span><span class="sc">{{</span><span class="st">:-</span><span class="sc">{}</span><span class="st">d</span><span class="sc">}}</span><span class="st">/</span><span class="sc">{{}}</span><span class="st"> [</span><span class="sc">{{}}</span><span class="st">]"</span>.<span class="bu">format</span>(<span class="bu">len</span>(<span class="bu">str</span>(total)))</span>
<span id="cb323-6"><a href="#cb323-6" aria-hidden="true" tabindex="-1"></a>    params <span class="op">=</span> [iteration, total, <span class="st">"="</span> <span class="op">*</span> p <span class="op">+</span> c <span class="op">+</span> <span class="st">"."</span> <span class="op">*</span> (size <span class="op">-</span> p <span class="op">-</span> <span class="dv">1</span>)]</span>
<span id="cb323-7"><a href="#cb323-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> fmt.<span class="bu">format</span>(<span class="op">*</span>params)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-242" class="cell" data-execution_count="198">
<div class="sourceCode cell-code" id="cb324"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb324-1"><a href="#cb324-1" aria-hidden="true" tabindex="-1"></a>progress_bar(<span class="dv">3500</span>, <span class="dv">10000</span>, size<span class="op">=</span><span class="dv">6</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="198">
<pre><code>' 3500/10000 [=&gt;....]'</code></pre>
</div>
</div>
<div id="cell-243" class="cell" data-execution_count="199">
<div class="sourceCode cell-code" id="cb326"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb326-1"><a href="#cb326-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> print_status_bar(iteration, total, loss, metrics<span class="op">=</span><span class="va">None</span>, size<span class="op">=</span><span class="dv">30</span>):</span>
<span id="cb326-2"><a href="#cb326-2" aria-hidden="true" tabindex="-1"></a>    metrics <span class="op">=</span> <span class="st">" - "</span>.join([<span class="st">"</span><span class="sc">{}</span><span class="st">: </span><span class="sc">{:.4f}</span><span class="st">"</span>.<span class="bu">format</span>(m.name, m.result())</span>
<span id="cb326-3"><a href="#cb326-3" aria-hidden="true" tabindex="-1"></a>                         <span class="cf">for</span> m <span class="kw">in</span> [loss] <span class="op">+</span> (metrics <span class="kw">or</span> [])])</span>
<span id="cb326-4"><a href="#cb326-4" aria-hidden="true" tabindex="-1"></a>    end <span class="op">=</span> <span class="st">""</span> <span class="cf">if</span> iteration <span class="op">&lt;</span> total <span class="cf">else</span> <span class="st">"</span><span class="ch">\n</span><span class="st">"</span></span>
<span id="cb326-5"><a href="#cb326-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\r</span><span class="sc">{}</span><span class="st"> - </span><span class="sc">{}</span><span class="st">"</span>.<span class="bu">format</span>(progress_bar(iteration, total), metrics), end<span class="op">=</span>end)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-244" class="cell" data-execution_count="200">
<div class="sourceCode cell-code" id="cb327"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb327-1"><a href="#cb327-1" aria-hidden="true" tabindex="-1"></a>mean_loss <span class="op">=</span> keras.metrics.Mean(name<span class="op">=</span><span class="st">"loss"</span>)</span>
<span id="cb327-2"><a href="#cb327-2" aria-hidden="true" tabindex="-1"></a>mean_square <span class="op">=</span> keras.metrics.Mean(name<span class="op">=</span><span class="st">"mean_square"</span>)</span>
<span id="cb327-3"><a href="#cb327-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">50</span> <span class="op">+</span> <span class="dv">1</span>):</span>
<span id="cb327-4"><a href="#cb327-4" aria-hidden="true" tabindex="-1"></a>    loss <span class="op">=</span> <span class="dv">1</span> <span class="op">/</span> i</span>
<span id="cb327-5"><a href="#cb327-5" aria-hidden="true" tabindex="-1"></a>    mean_loss(loss)</span>
<span id="cb327-6"><a href="#cb327-6" aria-hidden="true" tabindex="-1"></a>    mean_square(i <span class="op">**</span> <span class="dv">2</span>)</span>
<span id="cb327-7"><a href="#cb327-7" aria-hidden="true" tabindex="-1"></a>    print_status_bar(i, <span class="dv">50</span>, mean_loss, [mean_square])</span>
<span id="cb327-8"><a href="#cb327-8" aria-hidden="true" tabindex="-1"></a>    time.sleep(<span class="fl">0.05</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>50/50 [==============================] - loss: 0.0900 - mean_square: 858.5000</code></pre>
</div>
</div>
<div id="cell-245" class="cell" data-execution_count="201">
<div class="sourceCode cell-code" id="cb329"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb329-1"><a href="#cb329-1" aria-hidden="true" tabindex="-1"></a>keras.backend.clear_session()</span>
<span id="cb329-2"><a href="#cb329-2" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">42</span>)</span>
<span id="cb329-3"><a href="#cb329-3" aria-hidden="true" tabindex="-1"></a>tf.random.set_seed(<span class="dv">42</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-246" class="cell" data-execution_count="202">
<div class="sourceCode cell-code" id="cb330"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb330-1"><a href="#cb330-1" aria-hidden="true" tabindex="-1"></a>n_epochs <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb330-2"><a href="#cb330-2" aria-hidden="true" tabindex="-1"></a>batch_size <span class="op">=</span> <span class="dv">32</span></span>
<span id="cb330-3"><a href="#cb330-3" aria-hidden="true" tabindex="-1"></a>n_steps <span class="op">=</span> <span class="bu">len</span>(X_train) <span class="op">//</span> batch_size</span>
<span id="cb330-4"><a href="#cb330-4" aria-hidden="true" tabindex="-1"></a>optimizer <span class="op">=</span> keras.optimizers.Nadam(learning_rate<span class="op">=</span><span class="fl">0.01</span>)</span>
<span id="cb330-5"><a href="#cb330-5" aria-hidden="true" tabindex="-1"></a>loss_fn <span class="op">=</span> keras.losses.mean_squared_error</span>
<span id="cb330-6"><a href="#cb330-6" aria-hidden="true" tabindex="-1"></a>mean_loss <span class="op">=</span> keras.metrics.Mean()</span>
<span id="cb330-7"><a href="#cb330-7" aria-hidden="true" tabindex="-1"></a>metrics <span class="op">=</span> [keras.metrics.MeanAbsoluteError()]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-247" class="cell" data-execution_count="203">
<div class="sourceCode cell-code" id="cb331"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb331-1"><a href="#cb331-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> epoch <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, n_epochs <span class="op">+</span> <span class="dv">1</span>):</span>
<span id="cb331-2"><a href="#cb331-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Epoch </span><span class="sc">{}</span><span class="st">/</span><span class="sc">{}</span><span class="st">"</span>.<span class="bu">format</span>(epoch, n_epochs))</span>
<span id="cb331-3"><a href="#cb331-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> step <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, n_steps <span class="op">+</span> <span class="dv">1</span>):</span>
<span id="cb331-4"><a href="#cb331-4" aria-hidden="true" tabindex="-1"></a>        X_batch, y_batch <span class="op">=</span> random_batch(X_train_scaled, y_train)</span>
<span id="cb331-5"><a href="#cb331-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> tf.GradientTape() <span class="im">as</span> tape:</span>
<span id="cb331-6"><a href="#cb331-6" aria-hidden="true" tabindex="-1"></a>            y_pred <span class="op">=</span> model(X_batch)</span>
<span id="cb331-7"><a href="#cb331-7" aria-hidden="true" tabindex="-1"></a>            main_loss <span class="op">=</span> tf.reduce_mean(loss_fn(y_batch, y_pred))</span>
<span id="cb331-8"><a href="#cb331-8" aria-hidden="true" tabindex="-1"></a>            loss <span class="op">=</span> tf.add_n([main_loss] <span class="op">+</span> model.losses)</span>
<span id="cb331-9"><a href="#cb331-9" aria-hidden="true" tabindex="-1"></a>        gradients <span class="op">=</span> tape.gradient(loss, model.trainable_variables)</span>
<span id="cb331-10"><a href="#cb331-10" aria-hidden="true" tabindex="-1"></a>        optimizer.apply_gradients(<span class="bu">zip</span>(gradients, model.trainable_variables))</span>
<span id="cb331-11"><a href="#cb331-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> variable <span class="kw">in</span> model.variables:</span>
<span id="cb331-12"><a href="#cb331-12" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> variable.constraint <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb331-13"><a href="#cb331-13" aria-hidden="true" tabindex="-1"></a>                variable.assign(variable.constraint(variable))</span>
<span id="cb331-14"><a href="#cb331-14" aria-hidden="true" tabindex="-1"></a>        mean_loss(loss)</span>
<span id="cb331-15"><a href="#cb331-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> metric <span class="kw">in</span> metrics:</span>
<span id="cb331-16"><a href="#cb331-16" aria-hidden="true" tabindex="-1"></a>            metric(y_batch, y_pred)</span>
<span id="cb331-17"><a href="#cb331-17" aria-hidden="true" tabindex="-1"></a>        print_status_bar(step <span class="op">*</span> batch_size, <span class="bu">len</span>(y_train), mean_loss, metrics)</span>
<span id="cb331-18"><a href="#cb331-18" aria-hidden="true" tabindex="-1"></a>    print_status_bar(<span class="bu">len</span>(y_train), <span class="bu">len</span>(y_train), mean_loss, metrics)</span>
<span id="cb331-19"><a href="#cb331-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> metric <span class="kw">in</span> [mean_loss] <span class="op">+</span> metrics:</span>
<span id="cb331-20"><a href="#cb331-20" aria-hidden="true" tabindex="-1"></a>        metric.reset_states()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch 1/5
11610/11610 [==============================] - mean: 1.3955 - mean_absolute_error: 0.5722
Epoch 2/5
11610/11610 [==============================] - mean: 0.6774 - mean_absolute_error: 0.5280
Epoch 3/5
11610/11610 [==============================] - mean: 0.6351 - mean_absolute_error: 0.5177
Epoch 4/5
11610/11610 [==============================] - mean: 0.6384 - mean_absolute_error: 0.5181
Epoch 5/5
11610/11610 [==============================] - mean: 0.6440 - mean_absolute_error: 0.5222</code></pre>
</div>
</div>
<div id="cell-248" class="cell" data-execution_count="204">
<div class="sourceCode cell-code" id="cb333"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb333-1"><a href="#cb333-1" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb333-2"><a href="#cb333-2" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> tqdm.notebook <span class="im">import</span> trange</span>
<span id="cb333-3"><a href="#cb333-3" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> collections <span class="im">import</span> OrderedDict</span>
<span id="cb333-4"><a href="#cb333-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> trange(<span class="dv">1</span>, n_epochs <span class="op">+</span> <span class="dv">1</span>, desc<span class="op">=</span><span class="st">"All epochs"</span>) <span class="im">as</span> epochs:</span>
<span id="cb333-5"><a href="#cb333-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> epoch <span class="kw">in</span> epochs:</span>
<span id="cb333-6"><a href="#cb333-6" aria-hidden="true" tabindex="-1"></a>            <span class="cf">with</span> trange(<span class="dv">1</span>, n_steps <span class="op">+</span> <span class="dv">1</span>, desc<span class="op">=</span><span class="st">"Epoch </span><span class="sc">{}</span><span class="st">/</span><span class="sc">{}</span><span class="st">"</span>.<span class="bu">format</span>(epoch, n_epochs)) <span class="im">as</span> steps:</span>
<span id="cb333-7"><a href="#cb333-7" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> step <span class="kw">in</span> steps:</span>
<span id="cb333-8"><a href="#cb333-8" aria-hidden="true" tabindex="-1"></a>                    X_batch, y_batch <span class="op">=</span> random_batch(X_train_scaled, y_train)</span>
<span id="cb333-9"><a href="#cb333-9" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">with</span> tf.GradientTape() <span class="im">as</span> tape:</span>
<span id="cb333-10"><a href="#cb333-10" aria-hidden="true" tabindex="-1"></a>                        y_pred <span class="op">=</span> model(X_batch)</span>
<span id="cb333-11"><a href="#cb333-11" aria-hidden="true" tabindex="-1"></a>                        main_loss <span class="op">=</span> tf.reduce_mean(loss_fn(y_batch, y_pred))</span>
<span id="cb333-12"><a href="#cb333-12" aria-hidden="true" tabindex="-1"></a>                        loss <span class="op">=</span> tf.add_n([main_loss] <span class="op">+</span> model.losses)</span>
<span id="cb333-13"><a href="#cb333-13" aria-hidden="true" tabindex="-1"></a>                    gradients <span class="op">=</span> tape.gradient(loss, model.trainable_variables)</span>
<span id="cb333-14"><a href="#cb333-14" aria-hidden="true" tabindex="-1"></a>                    optimizer.apply_gradients(<span class="bu">zip</span>(gradients, model.trainable_variables))</span>
<span id="cb333-15"><a href="#cb333-15" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">for</span> variable <span class="kw">in</span> model.variables:</span>
<span id="cb333-16"><a href="#cb333-16" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> variable.constraint <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb333-17"><a href="#cb333-17" aria-hidden="true" tabindex="-1"></a>                            variable.assign(variable.constraint(variable))                    </span>
<span id="cb333-18"><a href="#cb333-18" aria-hidden="true" tabindex="-1"></a>                    status <span class="op">=</span> OrderedDict()</span>
<span id="cb333-19"><a href="#cb333-19" aria-hidden="true" tabindex="-1"></a>                    mean_loss(loss)</span>
<span id="cb333-20"><a href="#cb333-20" aria-hidden="true" tabindex="-1"></a>                    status[<span class="st">"loss"</span>] <span class="op">=</span> mean_loss.result().numpy()</span>
<span id="cb333-21"><a href="#cb333-21" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">for</span> metric <span class="kw">in</span> metrics:</span>
<span id="cb333-22"><a href="#cb333-22" aria-hidden="true" tabindex="-1"></a>                        metric(y_batch, y_pred)</span>
<span id="cb333-23"><a href="#cb333-23" aria-hidden="true" tabindex="-1"></a>                        status[metric.name] <span class="op">=</span> metric.result().numpy()</span>
<span id="cb333-24"><a href="#cb333-24" aria-hidden="true" tabindex="-1"></a>                    steps.set_postfix(status)</span>
<span id="cb333-25"><a href="#cb333-25" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> metric <span class="kw">in</span> [mean_loss] <span class="op">+</span> metrics:</span>
<span id="cb333-26"><a href="#cb333-26" aria-hidden="true" tabindex="-1"></a>                metric.reset_states()</span>
<span id="cb333-27"><a href="#cb333-27" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">ImportError</span> <span class="im">as</span> ex:</span>
<span id="cb333-28"><a href="#cb333-28" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"To run this cell, please install tqdm, ipywidgets and restart Jupyter"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"911ccc0821324e99b156302727dbf9c4","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"21c8135ff59540c085b55653e6d69243","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"06190b83afc348e999aeb3a3c523aae8","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"44eb6b7d11b74a4aa9af17892e2a8ce9","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"6c62578a1aa24b7d96201cc285025e83","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"46a0328d0c5b4112995297e67bc290b6","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
</div>
<section id="tensorflow-functions" class="level2">
<h2 class="anchored" data-anchor-id="tensorflow-functions">TensorFlow Functions</h2>
<div id="cell-250" class="cell" data-execution_count="205">
<div class="sourceCode cell-code" id="cb334"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb334-1"><a href="#cb334-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> cube(x):</span>
<span id="cb334-2"><a href="#cb334-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x <span class="op">**</span> <span class="dv">3</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-251" class="cell" data-execution_count="206">
<div class="sourceCode cell-code" id="cb335"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb335-1"><a href="#cb335-1" aria-hidden="true" tabindex="-1"></a>cube(<span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="206">
<pre><code>8</code></pre>
</div>
</div>
<div id="cell-252" class="cell" data-execution_count="207">
<div class="sourceCode cell-code" id="cb337"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb337-1"><a href="#cb337-1" aria-hidden="true" tabindex="-1"></a>cube(tf.constant(<span class="fl">2.0</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="207">
<pre><code>&lt;tf.Tensor: shape=(), dtype=float32, numpy=8.0&gt;</code></pre>
</div>
</div>
<div id="cell-253" class="cell" data-execution_count="208">
<div class="sourceCode cell-code" id="cb339"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb339-1"><a href="#cb339-1" aria-hidden="true" tabindex="-1"></a>tf_cube <span class="op">=</span> tf.function(cube)</span>
<span id="cb339-2"><a href="#cb339-2" aria-hidden="true" tabindex="-1"></a>tf_cube</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="208">
<pre><code>&lt;tensorflow.python.eager.def_function.Function at 0x7fbfe0c54d50&gt;</code></pre>
</div>
</div>
<div id="cell-254" class="cell" data-execution_count="209">
<div class="sourceCode cell-code" id="cb341"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb341-1"><a href="#cb341-1" aria-hidden="true" tabindex="-1"></a>tf_cube(<span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="209">
<pre><code>&lt;tf.Tensor: shape=(), dtype=int32, numpy=8&gt;</code></pre>
</div>
</div>
<div id="cell-255" class="cell" data-execution_count="210">
<div class="sourceCode cell-code" id="cb343"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb343-1"><a href="#cb343-1" aria-hidden="true" tabindex="-1"></a>tf_cube(tf.constant(<span class="fl">2.0</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="210">
<pre><code>&lt;tf.Tensor: shape=(), dtype=float32, numpy=8.0&gt;</code></pre>
</div>
</div>
<section id="tf-functions-and-concrete-functions" class="level3">
<h3 class="anchored" data-anchor-id="tf-functions-and-concrete-functions">TF Functions and Concrete Functions</h3>
<div id="cell-257" class="cell" data-execution_count="211">
<div class="sourceCode cell-code" id="cb345"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb345-1"><a href="#cb345-1" aria-hidden="true" tabindex="-1"></a>concrete_function <span class="op">=</span> tf_cube.get_concrete_function(tf.constant(<span class="fl">2.0</span>))</span>
<span id="cb345-2"><a href="#cb345-2" aria-hidden="true" tabindex="-1"></a>concrete_function.graph</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="211">
<pre><code>&lt;tensorflow.python.framework.func_graph.FuncGraph at 0x7fbfd9444310&gt;</code></pre>
</div>
</div>
<div id="cell-258" class="cell" data-execution_count="212">
<div class="sourceCode cell-code" id="cb347"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb347-1"><a href="#cb347-1" aria-hidden="true" tabindex="-1"></a>concrete_function(tf.constant(<span class="fl">2.0</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="212">
<pre><code>&lt;tf.Tensor: shape=(), dtype=float32, numpy=8.0&gt;</code></pre>
</div>
</div>
<div id="cell-259" class="cell" data-execution_count="213">
<div class="sourceCode cell-code" id="cb349"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb349-1"><a href="#cb349-1" aria-hidden="true" tabindex="-1"></a>concrete_function <span class="kw">is</span> tf_cube.get_concrete_function(tf.constant(<span class="fl">2.0</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="213">
<pre><code>True</code></pre>
</div>
</div>
</section>
<section id="exploring-function-definitions-and-graphs" class="level3">
<h3 class="anchored" data-anchor-id="exploring-function-definitions-and-graphs">Exploring Function Definitions and Graphs</h3>
<div id="cell-261" class="cell" data-execution_count="214">
<div class="sourceCode cell-code" id="cb351"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb351-1"><a href="#cb351-1" aria-hidden="true" tabindex="-1"></a>concrete_function.graph</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="214">
<pre><code>&lt;tensorflow.python.framework.func_graph.FuncGraph at 0x7fbfd9444310&gt;</code></pre>
</div>
</div>
<div id="cell-262" class="cell" data-execution_count="215">
<div class="sourceCode cell-code" id="cb353"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb353-1"><a href="#cb353-1" aria-hidden="true" tabindex="-1"></a>ops <span class="op">=</span> concrete_function.graph.get_operations()</span>
<span id="cb353-2"><a href="#cb353-2" aria-hidden="true" tabindex="-1"></a>ops</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="215">
<pre><code>[&lt;tf.Operation 'x' type=Placeholder&gt;,
 &lt;tf.Operation 'pow/y' type=Const&gt;,
 &lt;tf.Operation 'pow' type=Pow&gt;,
 &lt;tf.Operation 'Identity' type=Identity&gt;]</code></pre>
</div>
</div>
<div id="cell-263" class="cell" data-execution_count="216">
<div class="sourceCode cell-code" id="cb355"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb355-1"><a href="#cb355-1" aria-hidden="true" tabindex="-1"></a>pow_op <span class="op">=</span> ops[<span class="dv">2</span>]</span>
<span id="cb355-2"><a href="#cb355-2" aria-hidden="true" tabindex="-1"></a><span class="bu">list</span>(pow_op.inputs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="216">
<pre><code>[&lt;tf.Tensor 'x:0' shape=() dtype=float32&gt;,
 &lt;tf.Tensor 'pow/y:0' shape=() dtype=float32&gt;]</code></pre>
</div>
</div>
<div id="cell-264" class="cell" data-execution_count="217">
<div class="sourceCode cell-code" id="cb357"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb357-1"><a href="#cb357-1" aria-hidden="true" tabindex="-1"></a>pow_op.outputs</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="217">
<pre><code>[&lt;tf.Tensor 'pow:0' shape=() dtype=float32&gt;]</code></pre>
</div>
</div>
<div id="cell-265" class="cell" data-execution_count="218">
<div class="sourceCode cell-code" id="cb359"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb359-1"><a href="#cb359-1" aria-hidden="true" tabindex="-1"></a>concrete_function.graph.get_operation_by_name(<span class="st">'x'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="218">
<pre><code>&lt;tf.Operation 'x' type=Placeholder&gt;</code></pre>
</div>
</div>
<div id="cell-266" class="cell" data-execution_count="219">
<div class="sourceCode cell-code" id="cb361"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb361-1"><a href="#cb361-1" aria-hidden="true" tabindex="-1"></a>concrete_function.graph.get_tensor_by_name(<span class="st">'Identity:0'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="219">
<pre><code>&lt;tf.Tensor 'Identity:0' shape=() dtype=float32&gt;</code></pre>
</div>
</div>
<div id="cell-267" class="cell" data-execution_count="220">
<div class="sourceCode cell-code" id="cb363"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb363-1"><a href="#cb363-1" aria-hidden="true" tabindex="-1"></a>concrete_function.function_def.signature</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="220">
<pre><code>name: "__inference_cube_1073862"
input_arg {
  name: "x"
  type: DT_FLOAT
}
output_arg {
  name: "identity"
  type: DT_FLOAT
}</code></pre>
</div>
</div>
</section>
<section id="how-tf-functions-trace-python-functions-to-extract-their-computation-graphs" class="level3">
<h3 class="anchored" data-anchor-id="how-tf-functions-trace-python-functions-to-extract-their-computation-graphs">How TF Functions Trace Python Functions to Extract Their Computation Graphs</h3>
<div id="cell-269" class="cell" data-execution_count="221">
<div class="sourceCode cell-code" id="cb365"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb365-1"><a href="#cb365-1" aria-hidden="true" tabindex="-1"></a><span class="at">@tf.function</span></span>
<span id="cb365-2"><a href="#cb365-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> tf_cube(x):</span>
<span id="cb365-3"><a href="#cb365-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"print:"</span>, x)</span>
<span id="cb365-4"><a href="#cb365-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x <span class="op">**</span> <span class="dv">3</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-270" class="cell" data-execution_count="222">
<div class="sourceCode cell-code" id="cb366"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb366-1"><a href="#cb366-1" aria-hidden="true" tabindex="-1"></a>result <span class="op">=</span> tf_cube(tf.constant(<span class="fl">2.0</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>print: Tensor("x:0", shape=(), dtype=float32)</code></pre>
</div>
</div>
<div id="cell-271" class="cell" data-execution_count="223">
<div class="sourceCode cell-code" id="cb368"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb368-1"><a href="#cb368-1" aria-hidden="true" tabindex="-1"></a>result</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="223">
<pre><code>&lt;tf.Tensor: shape=(), dtype=float32, numpy=8.0&gt;</code></pre>
</div>
</div>
<div id="cell-272" class="cell" data-execution_count="224">
<div class="sourceCode cell-code" id="cb370"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb370-1"><a href="#cb370-1" aria-hidden="true" tabindex="-1"></a>result <span class="op">=</span> tf_cube(<span class="dv">2</span>)</span>
<span id="cb370-2"><a href="#cb370-2" aria-hidden="true" tabindex="-1"></a>result <span class="op">=</span> tf_cube(<span class="dv">3</span>)</span>
<span id="cb370-3"><a href="#cb370-3" aria-hidden="true" tabindex="-1"></a>result <span class="op">=</span> tf_cube(tf.constant([[<span class="fl">1.</span>, <span class="fl">2.</span>]])) <span class="co"># New shape: trace!</span></span>
<span id="cb370-4"><a href="#cb370-4" aria-hidden="true" tabindex="-1"></a>result <span class="op">=</span> tf_cube(tf.constant([[<span class="fl">3.</span>, <span class="fl">4.</span>], [<span class="fl">5.</span>, <span class="fl">6.</span>]])) <span class="co"># New shape: trace!</span></span>
<span id="cb370-5"><a href="#cb370-5" aria-hidden="true" tabindex="-1"></a>result <span class="op">=</span> tf_cube(tf.constant([[<span class="fl">7.</span>, <span class="fl">8.</span>], [<span class="fl">9.</span>, <span class="fl">10.</span>], [<span class="fl">11.</span>, <span class="fl">12.</span>]])) <span class="co"># New shape: trace!</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>print: 2
print: 3
print: Tensor("x:0", shape=(1, 2), dtype=float32)
print: Tensor("x:0", shape=(2, 2), dtype=float32)
WARNING:tensorflow:5 out of the last 5 calls to &lt;function tf_cube at 0x7fbfc0363440&gt; triggered tf.function retracing. Tracing is expensive and the excessive number of tracings could be due to (1) creating @tf.function repeatedly in a loop, (2) passing tensors with different shapes, (3) passing Python objects instead of tensors. For (1), please define your @tf.function outside of the loop. For (2), @tf.function has experimental_relax_shapes=True option that relaxes argument shapes that can avoid unnecessary retracing. For (3), please refer to https://www.tensorflow.org/guide/function#controlling_retracing and https://www.tensorflow.org/api_docs/python/tf/function for  more details.
print: Tensor("x:0", shape=(3, 2), dtype=float32)
WARNING:tensorflow:6 out of the last 6 calls to &lt;function tf_cube at 0x7fbfc0363440&gt; triggered tf.function retracing. Tracing is expensive and the excessive number of tracings could be due to (1) creating @tf.function repeatedly in a loop, (2) passing tensors with different shapes, (3) passing Python objects instead of tensors. For (1), please define your @tf.function outside of the loop. For (2), @tf.function has experimental_relax_shapes=True option that relaxes argument shapes that can avoid unnecessary retracing. For (3), please refer to https://www.tensorflow.org/guide/function#controlling_retracing and https://www.tensorflow.org/api_docs/python/tf/function for  more details.</code></pre>
</div>
</div>
<p>It is also possible to specify a particular input signature:</p>
<div id="cell-274" class="cell" data-execution_count="225">
<div class="sourceCode cell-code" id="cb372"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb372-1"><a href="#cb372-1" aria-hidden="true" tabindex="-1"></a><span class="at">@tf.function</span>(input_signature<span class="op">=</span>[tf.TensorSpec([<span class="va">None</span>, <span class="dv">28</span>, <span class="dv">28</span>], tf.float32)])</span>
<span id="cb372-2"><a href="#cb372-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> shrink(images):</span>
<span id="cb372-3"><a href="#cb372-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Tracing"</span>, images)</span>
<span id="cb372-4"><a href="#cb372-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> images[:, ::<span class="dv">2</span>, ::<span class="dv">2</span>] <span class="co"># drop half the rows and columns</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-275" class="cell" data-execution_count="226">
<div class="sourceCode cell-code" id="cb373"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb373-1"><a href="#cb373-1" aria-hidden="true" tabindex="-1"></a>keras.backend.clear_session()</span>
<span id="cb373-2"><a href="#cb373-2" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">42</span>)</span>
<span id="cb373-3"><a href="#cb373-3" aria-hidden="true" tabindex="-1"></a>tf.random.set_seed(<span class="dv">42</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-276" class="cell" data-execution_count="227">
<div class="sourceCode cell-code" id="cb374"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb374-1"><a href="#cb374-1" aria-hidden="true" tabindex="-1"></a>img_batch_1 <span class="op">=</span> tf.random.uniform(shape<span class="op">=</span>[<span class="dv">100</span>, <span class="dv">28</span>, <span class="dv">28</span>])</span>
<span id="cb374-2"><a href="#cb374-2" aria-hidden="true" tabindex="-1"></a>img_batch_2 <span class="op">=</span> tf.random.uniform(shape<span class="op">=</span>[<span class="dv">50</span>, <span class="dv">28</span>, <span class="dv">28</span>])</span>
<span id="cb374-3"><a href="#cb374-3" aria-hidden="true" tabindex="-1"></a>preprocessed_images <span class="op">=</span> shrink(img_batch_1) <span class="co"># Traces the function.</span></span>
<span id="cb374-4"><a href="#cb374-4" aria-hidden="true" tabindex="-1"></a>preprocessed_images <span class="op">=</span> shrink(img_batch_2) <span class="co"># Reuses the same concrete function.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Tracing Tensor("images:0", shape=(None, 28, 28), dtype=float32)</code></pre>
</div>
</div>
<div id="cell-277" class="cell" data-execution_count="228">
<div class="sourceCode cell-code" id="cb376"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb376-1"><a href="#cb376-1" aria-hidden="true" tabindex="-1"></a>img_batch_3 <span class="op">=</span> tf.random.uniform(shape<span class="op">=</span>[<span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">2</span>])</span>
<span id="cb376-2"><a href="#cb376-2" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb376-3"><a href="#cb376-3" aria-hidden="true" tabindex="-1"></a>    preprocessed_images <span class="op">=</span> shrink(img_batch_3)  <span class="co"># rejects unexpected types or shapes</span></span>
<span id="cb376-4"><a href="#cb376-4" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">ValueError</span> <span class="im">as</span> ex:</span>
<span id="cb376-5"><a href="#cb376-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(ex)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Python inputs incompatible with input_signature:
  inputs: (
    tf.Tensor(
[[[0.7413678  0.62854624]
  [0.01738465 0.3431449 ]]

 [[0.51063764 0.3777541 ]
  [0.07321596 0.02137029]]], shape=(2, 2, 2), dtype=float32))
  input_signature: (
    TensorSpec(shape=(None, 28, 28), dtype=tf.float32, name=None))</code></pre>
</div>
</div>
</section>
<section id="using-autograph-to-capture-control-flow" class="level3">
<h3 class="anchored" data-anchor-id="using-autograph-to-capture-control-flow">Using Autograph To Capture Control Flow</h3>
<p>A “static” <code>for</code> loop using <code>range()</code>:</p>
<div id="cell-280" class="cell" data-execution_count="229">
<div class="sourceCode cell-code" id="cb378"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb378-1"><a href="#cb378-1" aria-hidden="true" tabindex="-1"></a><span class="at">@tf.function</span></span>
<span id="cb378-2"><a href="#cb378-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> add_10(x):</span>
<span id="cb378-3"><a href="#cb378-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">10</span>):</span>
<span id="cb378-4"><a href="#cb378-4" aria-hidden="true" tabindex="-1"></a>        x <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb378-5"><a href="#cb378-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-281" class="cell" data-execution_count="230">
<div class="sourceCode cell-code" id="cb379"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb379-1"><a href="#cb379-1" aria-hidden="true" tabindex="-1"></a>add_10(tf.constant(<span class="dv">5</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="230">
<pre><code>&lt;tf.Tensor: shape=(), dtype=int32, numpy=15&gt;</code></pre>
</div>
</div>
<div id="cell-282" class="cell" data-execution_count="231">
<div class="sourceCode cell-code" id="cb381"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb381-1"><a href="#cb381-1" aria-hidden="true" tabindex="-1"></a>add_10.get_concrete_function(tf.constant(<span class="dv">5</span>)).graph.get_operations()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="231">
<pre><code>[&lt;tf.Operation 'x' type=Placeholder&gt;,
 &lt;tf.Operation 'add/y' type=Const&gt;,
 &lt;tf.Operation 'add' type=AddV2&gt;,
 &lt;tf.Operation 'add_1/y' type=Const&gt;,
 &lt;tf.Operation 'add_1' type=AddV2&gt;,
 &lt;tf.Operation 'add_2/y' type=Const&gt;,
 &lt;tf.Operation 'add_2' type=AddV2&gt;,
 &lt;tf.Operation 'add_3/y' type=Const&gt;,
 &lt;tf.Operation 'add_3' type=AddV2&gt;,
 &lt;tf.Operation 'add_4/y' type=Const&gt;,
 &lt;tf.Operation 'add_4' type=AddV2&gt;,
 &lt;tf.Operation 'add_5/y' type=Const&gt;,
 &lt;tf.Operation 'add_5' type=AddV2&gt;,
 &lt;tf.Operation 'add_6/y' type=Const&gt;,
 &lt;tf.Operation 'add_6' type=AddV2&gt;,
 &lt;tf.Operation 'add_7/y' type=Const&gt;,
 &lt;tf.Operation 'add_7' type=AddV2&gt;,
 &lt;tf.Operation 'add_8/y' type=Const&gt;,
 &lt;tf.Operation 'add_8' type=AddV2&gt;,
 &lt;tf.Operation 'add_9/y' type=Const&gt;,
 &lt;tf.Operation 'add_9' type=AddV2&gt;,
 &lt;tf.Operation 'Identity' type=Identity&gt;]</code></pre>
</div>
</div>
<p>A “dynamic” loop using <code>tf.while_loop()</code>:</p>
<div id="cell-284" class="cell" data-execution_count="232">
<div class="sourceCode cell-code" id="cb383"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb383-1"><a href="#cb383-1" aria-hidden="true" tabindex="-1"></a><span class="at">@tf.function</span></span>
<span id="cb383-2"><a href="#cb383-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> add_10(x):</span>
<span id="cb383-3"><a href="#cb383-3" aria-hidden="true" tabindex="-1"></a>    condition <span class="op">=</span> <span class="kw">lambda</span> i, x: tf.less(i, <span class="dv">10</span>)</span>
<span id="cb383-4"><a href="#cb383-4" aria-hidden="true" tabindex="-1"></a>    body <span class="op">=</span> <span class="kw">lambda</span> i, x: (tf.add(i, <span class="dv">1</span>), tf.add(x, <span class="dv">1</span>))</span>
<span id="cb383-5"><a href="#cb383-5" aria-hidden="true" tabindex="-1"></a>    final_i, final_x <span class="op">=</span> tf.while_loop(condition, body, [tf.constant(<span class="dv">0</span>), x])</span>
<span id="cb383-6"><a href="#cb383-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> final_x</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-285" class="cell" data-execution_count="233">
<div class="sourceCode cell-code" id="cb384"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb384-1"><a href="#cb384-1" aria-hidden="true" tabindex="-1"></a>add_10(tf.constant(<span class="dv">5</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="233">
<pre><code>&lt;tf.Tensor: shape=(), dtype=int32, numpy=15&gt;</code></pre>
</div>
</div>
<div id="cell-286" class="cell" data-execution_count="234">
<div class="sourceCode cell-code" id="cb386"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb386-1"><a href="#cb386-1" aria-hidden="true" tabindex="-1"></a>add_10.get_concrete_function(tf.constant(<span class="dv">5</span>)).graph.get_operations()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="234">
<pre><code>[&lt;tf.Operation 'x' type=Placeholder&gt;,
 &lt;tf.Operation 'Const' type=Const&gt;,
 &lt;tf.Operation 'while/maximum_iterations' type=Const&gt;,
 &lt;tf.Operation 'while/loop_counter' type=Const&gt;,
 &lt;tf.Operation 'while' type=StatelessWhile&gt;,
 &lt;tf.Operation 'Identity' type=Identity&gt;]</code></pre>
</div>
</div>
<p>A “dynamic” <code>for</code> loop using <code>tf.range()</code> (captured by autograph):</p>
<div id="cell-288" class="cell" data-execution_count="235">
<div class="sourceCode cell-code" id="cb388"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb388-1"><a href="#cb388-1" aria-hidden="true" tabindex="-1"></a><span class="at">@tf.function</span></span>
<span id="cb388-2"><a href="#cb388-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> add_10(x):</span>
<span id="cb388-3"><a href="#cb388-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> tf.<span class="bu">range</span>(<span class="dv">10</span>):</span>
<span id="cb388-4"><a href="#cb388-4" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> x <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb388-5"><a href="#cb388-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-289" class="cell" data-execution_count="236">
<div class="sourceCode cell-code" id="cb389"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb389-1"><a href="#cb389-1" aria-hidden="true" tabindex="-1"></a>add_10.get_concrete_function(tf.constant(<span class="dv">0</span>)).graph.get_operations()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="236">
<pre><code>[&lt;tf.Operation 'x' type=Placeholder&gt;,
 &lt;tf.Operation 'range/start' type=Const&gt;,
 &lt;tf.Operation 'range/limit' type=Const&gt;,
 &lt;tf.Operation 'range/delta' type=Const&gt;,
 &lt;tf.Operation 'range' type=Range&gt;,
 &lt;tf.Operation 'sub' type=Sub&gt;,
 &lt;tf.Operation 'floordiv' type=FloorDiv&gt;,
 &lt;tf.Operation 'mod' type=FloorMod&gt;,
 &lt;tf.Operation 'zeros_like' type=Const&gt;,
 &lt;tf.Operation 'NotEqual' type=NotEqual&gt;,
 &lt;tf.Operation 'Cast' type=Cast&gt;,
 &lt;tf.Operation 'add' type=AddV2&gt;,
 &lt;tf.Operation 'zeros_like_1' type=Const&gt;,
 &lt;tf.Operation 'Maximum' type=Maximum&gt;,
 &lt;tf.Operation 'while/maximum_iterations' type=Const&gt;,
 &lt;tf.Operation 'while/loop_counter' type=Const&gt;,
 &lt;tf.Operation 'while' type=StatelessWhile&gt;,
 &lt;tf.Operation 'Identity' type=Identity&gt;]</code></pre>
</div>
</div>
</section>
<section id="handling-variables-and-other-resources-in-tf-functions" class="level3">
<h3 class="anchored" data-anchor-id="handling-variables-and-other-resources-in-tf-functions">Handling Variables and Other Resources in TF Functions</h3>
<div id="cell-291" class="cell" data-execution_count="237">
<div class="sourceCode cell-code" id="cb391"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb391-1"><a href="#cb391-1" aria-hidden="true" tabindex="-1"></a>counter <span class="op">=</span> tf.Variable(<span class="dv">0</span>)</span>
<span id="cb391-2"><a href="#cb391-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb391-3"><a href="#cb391-3" aria-hidden="true" tabindex="-1"></a><span class="at">@tf.function</span></span>
<span id="cb391-4"><a href="#cb391-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> increment(counter, c<span class="op">=</span><span class="dv">1</span>):</span>
<span id="cb391-5"><a href="#cb391-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> counter.assign_add(c)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-292" class="cell" data-execution_count="238">
<div class="sourceCode cell-code" id="cb392"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb392-1"><a href="#cb392-1" aria-hidden="true" tabindex="-1"></a>increment(counter)</span>
<span id="cb392-2"><a href="#cb392-2" aria-hidden="true" tabindex="-1"></a>increment(counter)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="238">
<pre><code>&lt;tf.Tensor: shape=(), dtype=int32, numpy=2&gt;</code></pre>
</div>
</div>
<div id="cell-293" class="cell" data-execution_count="239">
<div class="sourceCode cell-code" id="cb394"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb394-1"><a href="#cb394-1" aria-hidden="true" tabindex="-1"></a>function_def <span class="op">=</span> increment.get_concrete_function(counter).function_def</span>
<span id="cb394-2"><a href="#cb394-2" aria-hidden="true" tabindex="-1"></a>function_def.signature.input_arg[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="239">
<pre><code>name: "counter"
type: DT_RESOURCE</code></pre>
</div>
</div>
<div id="cell-294" class="cell" data-execution_count="240">
<div class="sourceCode cell-code" id="cb396"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb396-1"><a href="#cb396-1" aria-hidden="true" tabindex="-1"></a>counter <span class="op">=</span> tf.Variable(<span class="dv">0</span>)</span>
<span id="cb396-2"><a href="#cb396-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb396-3"><a href="#cb396-3" aria-hidden="true" tabindex="-1"></a><span class="at">@tf.function</span></span>
<span id="cb396-4"><a href="#cb396-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> increment(c<span class="op">=</span><span class="dv">1</span>):</span>
<span id="cb396-5"><a href="#cb396-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> counter.assign_add(c)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-295" class="cell" data-execution_count="241">
<div class="sourceCode cell-code" id="cb397"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb397-1"><a href="#cb397-1" aria-hidden="true" tabindex="-1"></a>increment()</span>
<span id="cb397-2"><a href="#cb397-2" aria-hidden="true" tabindex="-1"></a>increment()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="241">
<pre><code>&lt;tf.Tensor: shape=(), dtype=int32, numpy=2&gt;</code></pre>
</div>
</div>
<div id="cell-296" class="cell" data-execution_count="242">
<div class="sourceCode cell-code" id="cb399"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb399-1"><a href="#cb399-1" aria-hidden="true" tabindex="-1"></a>function_def <span class="op">=</span> increment.get_concrete_function().function_def</span>
<span id="cb399-2"><a href="#cb399-2" aria-hidden="true" tabindex="-1"></a>function_def.signature.input_arg[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="242">
<pre><code>name: "assignaddvariableop_resource"
type: DT_RESOURCE</code></pre>
</div>
</div>
<div id="cell-297" class="cell" data-execution_count="243">
<div class="sourceCode cell-code" id="cb401"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb401-1"><a href="#cb401-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Counter:</span>
<span id="cb401-2"><a href="#cb401-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="cb401-3"><a href="#cb401-3" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.counter <span class="op">=</span> tf.Variable(<span class="dv">0</span>)</span>
<span id="cb401-4"><a href="#cb401-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb401-5"><a href="#cb401-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">@tf.function</span></span>
<span id="cb401-6"><a href="#cb401-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> increment(<span class="va">self</span>, c<span class="op">=</span><span class="dv">1</span>):</span>
<span id="cb401-7"><a href="#cb401-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.counter.assign_add(c)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-298" class="cell" data-execution_count="244">
<div class="sourceCode cell-code" id="cb402"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb402-1"><a href="#cb402-1" aria-hidden="true" tabindex="-1"></a>c <span class="op">=</span> Counter()</span>
<span id="cb402-2"><a href="#cb402-2" aria-hidden="true" tabindex="-1"></a>c.increment()</span>
<span id="cb402-3"><a href="#cb402-3" aria-hidden="true" tabindex="-1"></a>c.increment()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="244">
<pre><code>&lt;tf.Tensor: shape=(), dtype=int32, numpy=2&gt;</code></pre>
</div>
</div>
<div id="cell-299" class="cell" data-scrolled="true" data-execution_count="245">
<div class="sourceCode cell-code" id="cb404"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb404-1"><a href="#cb404-1" aria-hidden="true" tabindex="-1"></a><span class="at">@tf.function</span></span>
<span id="cb404-2"><a href="#cb404-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> add_10(x):</span>
<span id="cb404-3"><a href="#cb404-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> tf.<span class="bu">range</span>(<span class="dv">10</span>):</span>
<span id="cb404-4"><a href="#cb404-4" aria-hidden="true" tabindex="-1"></a>        x <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb404-5"><a href="#cb404-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x</span>
<span id="cb404-6"><a href="#cb404-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb404-7"><a href="#cb404-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(tf.autograph.to_code(add_10.python_function))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>def tf__add(x):
    with ag__.FunctionScope('add_10', 'fscope', ag__.ConversionOptions(recursive=True, user_requested=True, optional_features=(), internal_convert_user_code=True)) as fscope:
        do_return = False
        retval_ = ag__.UndefinedReturnValue()

        def get_state():
            return (x,)

        def set_state(vars_):
            nonlocal x
            (x,) = vars_

        def loop_body(itr):
            nonlocal x
            i = itr
            x = ag__.ld(x)
            x += 1
        i = ag__.Undefined('i')
        ag__.for_stmt(ag__.converted_call(ag__.ld(tf).range, (10,), None, fscope), None, loop_body, get_state, set_state, ('x',), {'iterate_names': 'i'})
        try:
            do_return = True
            retval_ = ag__.ld(x)
        except:
            do_return = False
            raise
        return fscope.ret(retval_, do_return)
</code></pre>
</div>
</div>
<div id="cell-300" class="cell" data-execution_count="246">
<div class="sourceCode cell-code" id="cb406"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb406-1"><a href="#cb406-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> display_tf_code(func):</span>
<span id="cb406-2"><a href="#cb406-2" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> IPython.display <span class="im">import</span> display, Markdown</span>
<span id="cb406-3"><a href="#cb406-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">hasattr</span>(func, <span class="st">"python_function"</span>):</span>
<span id="cb406-4"><a href="#cb406-4" aria-hidden="true" tabindex="-1"></a>        func <span class="op">=</span> func.python_function</span>
<span id="cb406-5"><a href="#cb406-5" aria-hidden="true" tabindex="-1"></a>    code <span class="op">=</span> tf.autograph.to_code(func)</span>
<span id="cb406-6"><a href="#cb406-6" aria-hidden="true" tabindex="-1"></a>    display(Markdown(<span class="st">'```python</span><span class="ch">\n</span><span class="sc">{}</span><span class="ch">\n</span><span class="st">```'</span>.<span class="bu">format</span>(code)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-301" class="cell" data-execution_count="247">
<div class="sourceCode cell-code" id="cb407"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb407-1"><a href="#cb407-1" aria-hidden="true" tabindex="-1"></a>display_tf_code(add_10)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display cell-output-markdown">
<div class="sourceCode" id="cb408"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb408-1"><a href="#cb408-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> tf__add(x):</span>
<span id="cb408-2"><a href="#cb408-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> ag__.FunctionScope(<span class="st">'add_10'</span>, <span class="st">'fscope'</span>, ag__.ConversionOptions(recursive<span class="op">=</span><span class="va">True</span>, user_requested<span class="op">=</span><span class="va">True</span>, optional_features<span class="op">=</span>(), internal_convert_user_code<span class="op">=</span><span class="va">True</span>)) <span class="im">as</span> fscope:</span>
<span id="cb408-3"><a href="#cb408-3" aria-hidden="true" tabindex="-1"></a>        do_return <span class="op">=</span> <span class="va">False</span></span>
<span id="cb408-4"><a href="#cb408-4" aria-hidden="true" tabindex="-1"></a>        retval_ <span class="op">=</span> ag__.UndefinedReturnValue()</span>
<span id="cb408-5"><a href="#cb408-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb408-6"><a href="#cb408-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> get_state():</span>
<span id="cb408-7"><a href="#cb408-7" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> (x,)</span>
<span id="cb408-8"><a href="#cb408-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb408-9"><a href="#cb408-9" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> set_state(vars_):</span>
<span id="cb408-10"><a href="#cb408-10" aria-hidden="true" tabindex="-1"></a>            <span class="kw">nonlocal</span> x</span>
<span id="cb408-11"><a href="#cb408-11" aria-hidden="true" tabindex="-1"></a>            (x,) <span class="op">=</span> vars_</span>
<span id="cb408-12"><a href="#cb408-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb408-13"><a href="#cb408-13" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> loop_body(itr):</span>
<span id="cb408-14"><a href="#cb408-14" aria-hidden="true" tabindex="-1"></a>            <span class="kw">nonlocal</span> x</span>
<span id="cb408-15"><a href="#cb408-15" aria-hidden="true" tabindex="-1"></a>            i <span class="op">=</span> itr</span>
<span id="cb408-16"><a href="#cb408-16" aria-hidden="true" tabindex="-1"></a>            x <span class="op">=</span> ag__.ld(x)</span>
<span id="cb408-17"><a href="#cb408-17" aria-hidden="true" tabindex="-1"></a>            x <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb408-18"><a href="#cb408-18" aria-hidden="true" tabindex="-1"></a>        i <span class="op">=</span> ag__.Undefined(<span class="st">'i'</span>)</span>
<span id="cb408-19"><a href="#cb408-19" aria-hidden="true" tabindex="-1"></a>        ag__.for_stmt(ag__.converted_call(ag__.ld(tf).<span class="bu">range</span>, (<span class="dv">10</span>,), <span class="va">None</span>, fscope), <span class="va">None</span>, loop_body, get_state, set_state, (<span class="st">'x'</span>,), {<span class="st">'iterate_names'</span>: <span class="st">'i'</span>})</span>
<span id="cb408-20"><a href="#cb408-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb408-21"><a href="#cb408-21" aria-hidden="true" tabindex="-1"></a>            do_return <span class="op">=</span> <span class="va">True</span></span>
<span id="cb408-22"><a href="#cb408-22" aria-hidden="true" tabindex="-1"></a>            retval_ <span class="op">=</span> ag__.ld(x)</span>
<span id="cb408-23"><a href="#cb408-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span>:</span>
<span id="cb408-24"><a href="#cb408-24" aria-hidden="true" tabindex="-1"></a>            do_return <span class="op">=</span> <span class="va">False</span></span>
<span id="cb408-25"><a href="#cb408-25" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span></span>
<span id="cb408-26"><a href="#cb408-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> fscope.ret(retval_, do_return)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</section>
</section>
<section id="using-tf-functions-with-tf.keras-or-not" class="level2">
<h2 class="anchored" data-anchor-id="using-tf-functions-with-tf.keras-or-not">Using TF Functions with tf.keras (or Not)</h2>
<p>By default, tf.keras will automatically convert your custom code into TF Functions, no need to use <code>tf.function()</code>:</p>
<div id="cell-304" class="cell" data-execution_count="248">
<div class="sourceCode cell-code" id="cb409"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb409-1"><a href="#cb409-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Custom loss function</span></span>
<span id="cb409-2"><a href="#cb409-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> my_mse(y_true, y_pred):</span>
<span id="cb409-3"><a href="#cb409-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Tracing loss my_mse()"</span>)</span>
<span id="cb409-4"><a href="#cb409-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> tf.reduce_mean(tf.square(y_pred <span class="op">-</span> y_true))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-305" class="cell" data-execution_count="249">
<div class="sourceCode cell-code" id="cb410"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb410-1"><a href="#cb410-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Custom metric function</span></span>
<span id="cb410-2"><a href="#cb410-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> my_mae(y_true, y_pred):</span>
<span id="cb410-3"><a href="#cb410-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Tracing metric my_mae()"</span>)</span>
<span id="cb410-4"><a href="#cb410-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> tf.reduce_mean(tf.<span class="bu">abs</span>(y_pred <span class="op">-</span> y_true))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-306" class="cell" data-execution_count="250">
<div class="sourceCode cell-code" id="cb411"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb411-1"><a href="#cb411-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Custom layer</span></span>
<span id="cb411-2"><a href="#cb411-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MyDense(keras.layers.Layer):</span>
<span id="cb411-3"><a href="#cb411-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, units, activation<span class="op">=</span><span class="va">None</span>, <span class="op">**</span>kwargs):</span>
<span id="cb411-4"><a href="#cb411-4" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>(<span class="op">**</span>kwargs)</span>
<span id="cb411-5"><a href="#cb411-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.units <span class="op">=</span> units</span>
<span id="cb411-6"><a href="#cb411-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.activation <span class="op">=</span> keras.activations.get(activation)</span>
<span id="cb411-7"><a href="#cb411-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb411-8"><a href="#cb411-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> build(<span class="va">self</span>, input_shape):</span>
<span id="cb411-9"><a href="#cb411-9" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.kernel <span class="op">=</span> <span class="va">self</span>.add_weight(name<span class="op">=</span><span class="st">'kernel'</span>, </span>
<span id="cb411-10"><a href="#cb411-10" aria-hidden="true" tabindex="-1"></a>                                      shape<span class="op">=</span>(input_shape[<span class="dv">1</span>], <span class="va">self</span>.units),</span>
<span id="cb411-11"><a href="#cb411-11" aria-hidden="true" tabindex="-1"></a>                                      initializer<span class="op">=</span><span class="st">'uniform'</span>,</span>
<span id="cb411-12"><a href="#cb411-12" aria-hidden="true" tabindex="-1"></a>                                      trainable<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb411-13"><a href="#cb411-13" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.biases <span class="op">=</span> <span class="va">self</span>.add_weight(name<span class="op">=</span><span class="st">'bias'</span>, </span>
<span id="cb411-14"><a href="#cb411-14" aria-hidden="true" tabindex="-1"></a>                                      shape<span class="op">=</span>(<span class="va">self</span>.units,),</span>
<span id="cb411-15"><a href="#cb411-15" aria-hidden="true" tabindex="-1"></a>                                      initializer<span class="op">=</span><span class="st">'zeros'</span>,</span>
<span id="cb411-16"><a href="#cb411-16" aria-hidden="true" tabindex="-1"></a>                                      trainable<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb411-17"><a href="#cb411-17" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().build(input_shape)</span>
<span id="cb411-18"><a href="#cb411-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb411-19"><a href="#cb411-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> call(<span class="va">self</span>, X):</span>
<span id="cb411-20"><a href="#cb411-20" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Tracing MyDense.call()"</span>)</span>
<span id="cb411-21"><a href="#cb411-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.activation(X <span class="op">@</span> <span class="va">self</span>.kernel <span class="op">+</span> <span class="va">self</span>.biases)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-307" class="cell" data-execution_count="251">
<div class="sourceCode cell-code" id="cb412"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb412-1"><a href="#cb412-1" aria-hidden="true" tabindex="-1"></a>keras.backend.clear_session()</span>
<span id="cb412-2"><a href="#cb412-2" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">42</span>)</span>
<span id="cb412-3"><a href="#cb412-3" aria-hidden="true" tabindex="-1"></a>tf.random.set_seed(<span class="dv">42</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-308" class="cell" data-execution_count="252">
<div class="sourceCode cell-code" id="cb413"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb413-1"><a href="#cb413-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Custom model</span></span>
<span id="cb413-2"><a href="#cb413-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MyModel(keras.models.Model):</span>
<span id="cb413-3"><a href="#cb413-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, <span class="op">**</span>kwargs):</span>
<span id="cb413-4"><a href="#cb413-4" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>(<span class="op">**</span>kwargs)</span>
<span id="cb413-5"><a href="#cb413-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.hidden1 <span class="op">=</span> MyDense(<span class="dv">30</span>, activation<span class="op">=</span><span class="st">"relu"</span>)</span>
<span id="cb413-6"><a href="#cb413-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.hidden2 <span class="op">=</span> MyDense(<span class="dv">30</span>, activation<span class="op">=</span><span class="st">"relu"</span>)</span>
<span id="cb413-7"><a href="#cb413-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.output_ <span class="op">=</span> MyDense(<span class="dv">1</span>)</span>
<span id="cb413-8"><a href="#cb413-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb413-9"><a href="#cb413-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> call(<span class="va">self</span>, <span class="bu">input</span>):</span>
<span id="cb413-10"><a href="#cb413-10" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Tracing MyModel.call()"</span>)</span>
<span id="cb413-11"><a href="#cb413-11" aria-hidden="true" tabindex="-1"></a>        hidden1 <span class="op">=</span> <span class="va">self</span>.hidden1(<span class="bu">input</span>)</span>
<span id="cb413-12"><a href="#cb413-12" aria-hidden="true" tabindex="-1"></a>        hidden2 <span class="op">=</span> <span class="va">self</span>.hidden2(hidden1)</span>
<span id="cb413-13"><a href="#cb413-13" aria-hidden="true" tabindex="-1"></a>        concat <span class="op">=</span> keras.layers.concatenate([<span class="bu">input</span>, hidden2])</span>
<span id="cb413-14"><a href="#cb413-14" aria-hidden="true" tabindex="-1"></a>        output <span class="op">=</span> <span class="va">self</span>.output_(concat)</span>
<span id="cb413-15"><a href="#cb413-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> output</span>
<span id="cb413-16"><a href="#cb413-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb413-17"><a href="#cb413-17" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> MyModel()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-309" class="cell" data-execution_count="253">
<div class="sourceCode cell-code" id="cb414"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb414-1"><a href="#cb414-1" aria-hidden="true" tabindex="-1"></a>model.<span class="bu">compile</span>(loss<span class="op">=</span>my_mse, optimizer<span class="op">=</span><span class="st">"nadam"</span>, metrics<span class="op">=</span>[my_mae])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-310" class="cell" data-execution_count="254">
<div class="sourceCode cell-code" id="cb415"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb415-1"><a href="#cb415-1" aria-hidden="true" tabindex="-1"></a>model.fit(X_train_scaled, y_train, epochs<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb415-2"><a href="#cb415-2" aria-hidden="true" tabindex="-1"></a>          validation_data<span class="op">=</span>(X_valid_scaled, y_valid))</span>
<span id="cb415-3"><a href="#cb415-3" aria-hidden="true" tabindex="-1"></a>model.evaluate(X_test_scaled, y_test)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch 1/2
Tracing MyModel.call()
Tracing MyDense.call()
Tracing MyDense.call()
Tracing MyDense.call()
Tracing loss my_mse()
Tracing metric my_mae()
Tracing MyModel.call()
Tracing MyDense.call()
Tracing MyDense.call()
Tracing MyDense.call()
Tracing loss my_mse()
Tracing metric my_mae()
340/363 [===========================&gt;..] - ETA: 0s - loss: 2.8762 - my_mae: 1.2771Tracing MyModel.call()
Tracing MyDense.call()
Tracing MyDense.call()
Tracing MyDense.call()
Tracing loss my_mse()
Tracing metric my_mae()
363/363 [==============================] - 1s 1ms/step - loss: 2.7755 - my_mae: 1.2455 - val_loss: 0.5569 - val_my_mae: 0.4819
Epoch 2/2
363/363 [==============================] - 0s 802us/step - loss: 0.4697 - my_mae: 0.4911 - val_loss: 0.4664 - val_my_mae: 0.4576
162/162 [==============================] - 0s 469us/step - loss: 0.4164 - my_mae: 0.4639</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="254">
<pre><code>[0.4163525104522705, 0.4639028012752533]</code></pre>
</div>
</div>
<p>You can turn this off by creating the model with <code>dynamic=True</code> (or calling <code>super().__init__(dynamic=True, **kwargs)</code> in the model’s constructor):</p>
<div id="cell-312" class="cell" data-execution_count="255">
<div class="sourceCode cell-code" id="cb418"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb418-1"><a href="#cb418-1" aria-hidden="true" tabindex="-1"></a>keras.backend.clear_session()</span>
<span id="cb418-2"><a href="#cb418-2" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">42</span>)</span>
<span id="cb418-3"><a href="#cb418-3" aria-hidden="true" tabindex="-1"></a>tf.random.set_seed(<span class="dv">42</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-313" class="cell" data-execution_count="256">
<div class="sourceCode cell-code" id="cb419"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb419-1"><a href="#cb419-1" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> MyModel(dynamic<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-314" class="cell" data-execution_count="257">
<div class="sourceCode cell-code" id="cb420"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb420-1"><a href="#cb420-1" aria-hidden="true" tabindex="-1"></a>model.<span class="bu">compile</span>(loss<span class="op">=</span>my_mse, optimizer<span class="op">=</span><span class="st">"nadam"</span>, metrics<span class="op">=</span>[my_mae])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Not the custom code will be called at each iteration. Let’s fit, validate and evaluate with tiny datasets to avoid getting too much output:</p>
<div id="cell-316" class="cell" data-execution_count="258">
<div class="sourceCode cell-code" id="cb421"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb421-1"><a href="#cb421-1" aria-hidden="true" tabindex="-1"></a>model.fit(X_train_scaled[:<span class="dv">64</span>], y_train[:<span class="dv">64</span>], epochs<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb421-2"><a href="#cb421-2" aria-hidden="true" tabindex="-1"></a>          validation_data<span class="op">=</span>(X_valid_scaled[:<span class="dv">64</span>], y_valid[:<span class="dv">64</span>]), verbose<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb421-3"><a href="#cb421-3" aria-hidden="true" tabindex="-1"></a>model.evaluate(X_test_scaled[:<span class="dv">64</span>], y_test[:<span class="dv">64</span>], verbose<span class="op">=</span><span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Tracing MyModel.call()
Tracing MyDense.call()
Tracing MyDense.call()
Tracing MyDense.call()
Tracing loss my_mse()
Tracing metric my_mae()
Tracing MyModel.call()
Tracing MyDense.call()
Tracing MyDense.call()
Tracing MyDense.call()
Tracing loss my_mse()
Tracing metric my_mae()
Tracing MyModel.call()
Tracing MyDense.call()
Tracing MyDense.call()
Tracing MyDense.call()
Tracing loss my_mse()
Tracing metric my_mae()
Tracing MyModel.call()
Tracing MyDense.call()
Tracing MyDense.call()
Tracing MyDense.call()
Tracing loss my_mse()
Tracing metric my_mae()
Tracing MyModel.call()
Tracing MyDense.call()
Tracing MyDense.call()
Tracing MyDense.call()
Tracing loss my_mse()
Tracing metric my_mae()
Tracing MyModel.call()
Tracing MyDense.call()
Tracing MyDense.call()
Tracing MyDense.call()
Tracing loss my_mse()
Tracing metric my_mae()</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="258">
<pre><code>[5.507260322570801, 2.0566811561584473]</code></pre>
</div>
</div>
<p>Alternatively, you can compile a model with <code>run_eagerly=True</code>:</p>
<div id="cell-318" class="cell" data-execution_count="259">
<div class="sourceCode cell-code" id="cb424"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb424-1"><a href="#cb424-1" aria-hidden="true" tabindex="-1"></a>keras.backend.clear_session()</span>
<span id="cb424-2"><a href="#cb424-2" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">42</span>)</span>
<span id="cb424-3"><a href="#cb424-3" aria-hidden="true" tabindex="-1"></a>tf.random.set_seed(<span class="dv">42</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-319" class="cell" data-execution_count="260">
<div class="sourceCode cell-code" id="cb425"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb425-1"><a href="#cb425-1" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> MyModel()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-320" class="cell" data-execution_count="261">
<div class="sourceCode cell-code" id="cb426"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb426-1"><a href="#cb426-1" aria-hidden="true" tabindex="-1"></a>model.<span class="bu">compile</span>(loss<span class="op">=</span>my_mse, optimizer<span class="op">=</span><span class="st">"nadam"</span>, metrics<span class="op">=</span>[my_mae], run_eagerly<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-321" class="cell" data-execution_count="262">
<div class="sourceCode cell-code" id="cb427"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb427-1"><a href="#cb427-1" aria-hidden="true" tabindex="-1"></a>model.fit(X_train_scaled[:<span class="dv">64</span>], y_train[:<span class="dv">64</span>], epochs<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb427-2"><a href="#cb427-2" aria-hidden="true" tabindex="-1"></a>          validation_data<span class="op">=</span>(X_valid_scaled[:<span class="dv">64</span>], y_valid[:<span class="dv">64</span>]), verbose<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb427-3"><a href="#cb427-3" aria-hidden="true" tabindex="-1"></a>model.evaluate(X_test_scaled[:<span class="dv">64</span>], y_test[:<span class="dv">64</span>], verbose<span class="op">=</span><span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Tracing MyModel.call()
Tracing MyDense.call()
Tracing MyDense.call()
Tracing MyDense.call()
Tracing loss my_mse()
Tracing metric my_mae()
Tracing MyModel.call()
Tracing MyDense.call()
Tracing MyDense.call()
Tracing MyDense.call()
Tracing loss my_mse()
Tracing metric my_mae()
Tracing MyModel.call()
Tracing MyDense.call()
Tracing MyDense.call()
Tracing MyDense.call()
Tracing loss my_mse()
Tracing metric my_mae()
Tracing MyModel.call()
Tracing MyDense.call()
Tracing MyDense.call()
Tracing MyDense.call()
Tracing loss my_mse()
Tracing metric my_mae()
Tracing MyModel.call()
Tracing MyDense.call()
Tracing MyDense.call()
Tracing MyDense.call()
Tracing loss my_mse()
Tracing metric my_mae()
Tracing MyModel.call()
Tracing MyDense.call()
Tracing MyDense.call()
Tracing MyDense.call()
Tracing loss my_mse()
Tracing metric my_mae()</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="262">
<pre><code>[5.507260322570801, 2.0566811561584473]</code></pre>
</div>
</div>
</section>
<section id="custom-optimizers" class="level2">
<h2 class="anchored" data-anchor-id="custom-optimizers">Custom Optimizers</h2>
<p>Defining custom optimizers is not very common, but in case you are one of the happy few who gets to write one, here is an example:</p>
<div id="cell-324" class="cell" data-execution_count="263">
<div class="sourceCode cell-code" id="cb430"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb430-1"><a href="#cb430-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MyMomentumOptimizer(keras.optimizers.Optimizer):</span>
<span id="cb430-2"><a href="#cb430-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, learning_rate<span class="op">=</span><span class="fl">0.001</span>, momentum<span class="op">=</span><span class="fl">0.9</span>, name<span class="op">=</span><span class="st">"MyMomentumOptimizer"</span>, <span class="op">**</span>kwargs):</span>
<span id="cb430-3"><a href="#cb430-3" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Call super().__init__() and use _set_hyper() to store hyperparameters"""</span></span>
<span id="cb430-4"><a href="#cb430-4" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>(name, <span class="op">**</span>kwargs)</span>
<span id="cb430-5"><a href="#cb430-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._set_hyper(<span class="st">"learning_rate"</span>, kwargs.get(<span class="st">"lr"</span>, learning_rate)) <span class="co"># handle lr=learning_rate</span></span>
<span id="cb430-6"><a href="#cb430-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._set_hyper(<span class="st">"decay"</span>, <span class="va">self</span>._initial_decay) <span class="co"># </span></span>
<span id="cb430-7"><a href="#cb430-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._set_hyper(<span class="st">"momentum"</span>, momentum)</span>
<span id="cb430-8"><a href="#cb430-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb430-9"><a href="#cb430-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _create_slots(<span class="va">self</span>, var_list):</span>
<span id="cb430-10"><a href="#cb430-10" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""For each model variable, create the optimizer variable associated with it.</span></span>
<span id="cb430-11"><a href="#cb430-11" aria-hidden="true" tabindex="-1"></a><span class="co">        TensorFlow calls these optimizer variables "slots".</span></span>
<span id="cb430-12"><a href="#cb430-12" aria-hidden="true" tabindex="-1"></a><span class="co">        For momentum optimization, we need one momentum slot per model variable.</span></span>
<span id="cb430-13"><a href="#cb430-13" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb430-14"><a href="#cb430-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> var <span class="kw">in</span> var_list:</span>
<span id="cb430-15"><a href="#cb430-15" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.add_slot(var, <span class="st">"momentum"</span>)</span>
<span id="cb430-16"><a href="#cb430-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb430-17"><a href="#cb430-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">@tf.function</span></span>
<span id="cb430-18"><a href="#cb430-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _resource_apply_dense(<span class="va">self</span>, grad, var):</span>
<span id="cb430-19"><a href="#cb430-19" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Update the slots and perform one optimization step for one model variable</span></span>
<span id="cb430-20"><a href="#cb430-20" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb430-21"><a href="#cb430-21" aria-hidden="true" tabindex="-1"></a>        var_dtype <span class="op">=</span> var.dtype.base_dtype</span>
<span id="cb430-22"><a href="#cb430-22" aria-hidden="true" tabindex="-1"></a>        lr_t <span class="op">=</span> <span class="va">self</span>._decayed_lr(var_dtype) <span class="co"># handle learning rate decay</span></span>
<span id="cb430-23"><a href="#cb430-23" aria-hidden="true" tabindex="-1"></a>        momentum_var <span class="op">=</span> <span class="va">self</span>.get_slot(var, <span class="st">"momentum"</span>)</span>
<span id="cb430-24"><a href="#cb430-24" aria-hidden="true" tabindex="-1"></a>        momentum_hyper <span class="op">=</span> <span class="va">self</span>._get_hyper(<span class="st">"momentum"</span>, var_dtype)</span>
<span id="cb430-25"><a href="#cb430-25" aria-hidden="true" tabindex="-1"></a>        momentum_var.assign(momentum_var <span class="op">*</span> momentum_hyper <span class="op">-</span> (<span class="fl">1.</span> <span class="op">-</span> momentum_hyper)<span class="op">*</span> grad)</span>
<span id="cb430-26"><a href="#cb430-26" aria-hidden="true" tabindex="-1"></a>        var.assign_add(momentum_var <span class="op">*</span> lr_t)</span>
<span id="cb430-27"><a href="#cb430-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb430-28"><a href="#cb430-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _resource_apply_sparse(<span class="va">self</span>, grad, var):</span>
<span id="cb430-29"><a href="#cb430-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">NotImplementedError</span></span>
<span id="cb430-30"><a href="#cb430-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb430-31"><a href="#cb430-31" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get_config(<span class="va">self</span>):</span>
<span id="cb430-32"><a href="#cb430-32" aria-hidden="true" tabindex="-1"></a>        base_config <span class="op">=</span> <span class="bu">super</span>().get_config()</span>
<span id="cb430-33"><a href="#cb430-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {</span>
<span id="cb430-34"><a href="#cb430-34" aria-hidden="true" tabindex="-1"></a>            <span class="op">**</span>base_config,</span>
<span id="cb430-35"><a href="#cb430-35" aria-hidden="true" tabindex="-1"></a>            <span class="st">"learning_rate"</span>: <span class="va">self</span>._serialize_hyperparameter(<span class="st">"learning_rate"</span>),</span>
<span id="cb430-36"><a href="#cb430-36" aria-hidden="true" tabindex="-1"></a>            <span class="st">"decay"</span>: <span class="va">self</span>._serialize_hyperparameter(<span class="st">"decay"</span>),</span>
<span id="cb430-37"><a href="#cb430-37" aria-hidden="true" tabindex="-1"></a>            <span class="st">"momentum"</span>: <span class="va">self</span>._serialize_hyperparameter(<span class="st">"momentum"</span>),</span>
<span id="cb430-38"><a href="#cb430-38" aria-hidden="true" tabindex="-1"></a>        }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-325" class="cell" data-execution_count="264">
<div class="sourceCode cell-code" id="cb431"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb431-1"><a href="#cb431-1" aria-hidden="true" tabindex="-1"></a>keras.backend.clear_session()</span>
<span id="cb431-2"><a href="#cb431-2" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">42</span>)</span>
<span id="cb431-3"><a href="#cb431-3" aria-hidden="true" tabindex="-1"></a>tf.random.set_seed(<span class="dv">42</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-326" class="cell" data-execution_count="265">
<div class="sourceCode cell-code" id="cb432"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb432-1"><a href="#cb432-1" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> keras.models.Sequential([keras.layers.Dense(<span class="dv">1</span>, input_shape<span class="op">=</span>[<span class="dv">8</span>])])</span>
<span id="cb432-2"><a href="#cb432-2" aria-hidden="true" tabindex="-1"></a>model.<span class="bu">compile</span>(loss<span class="op">=</span><span class="st">"mse"</span>, optimizer<span class="op">=</span>MyMomentumOptimizer())</span>
<span id="cb432-3"><a href="#cb432-3" aria-hidden="true" tabindex="-1"></a>model.fit(X_train_scaled, y_train, epochs<span class="op">=</span><span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch 1/5
363/363 [==============================] - 0s 444us/step - loss: 4.9648
Epoch 2/5
363/363 [==============================] - 0s 444us/step - loss: 1.7888
Epoch 3/5
363/363 [==============================] - 0s 437us/step - loss: 1.0021
Epoch 4/5
363/363 [==============================] - 0s 451us/step - loss: 0.7869
Epoch 5/5
363/363 [==============================] - 0s 446us/step - loss: 0.7122</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="265">
<pre><code>&lt;tensorflow.python.keras.callbacks.History at 0x7fbfe0a94d50&gt;</code></pre>
</div>
</div>
</section>
</section>
<section id="exercises" class="level1">
<h1>Exercises</h1>
<section id="to-11." class="level2">
<h2 class="anchored" data-anchor-id="to-11.">1. to 11.</h2>
<p>See Appendix A.</p>
</section>
<section id="implement-a-custom-layer-that-performs-layer-normalization" class="level2">
<h2 class="anchored" data-anchor-id="implement-a-custom-layer-that-performs-layer-normalization">12. Implement a custom layer that performs <em>Layer Normalization</em></h2>
<p><em>We will use this type of layer in Chapter 15 when using Recurrent Neural Networks.</em></p>
<section id="a." class="level3">
<h3 class="anchored" data-anchor-id="a.">a.</h3>
<p><em>Exercise: The <code>build()</code> method should define two trainable weights <em>α</em> and <em>β</em>, both of shape <code>input_shape[-1:]</code> and data type <code>tf.float32</code>. <em>α</em> should be initialized with 1s, and <em>β</em> with 0s.</em></p>
<p>Solution: see below.</p>
</section>
<section id="b." class="level3">
<h3 class="anchored" data-anchor-id="b.">b.</h3>
<p><em>Exercise: The <code>call()</code> method should compute the mean</em> μ <em>and standard deviation</em> σ <em>of each instance’s features. For this, you can use <code>tf.nn.moments(inputs, axes=-1, keepdims=True)</code>, which returns the mean μ and the variance σ<sup>2</sup> of all instances (compute the square root of the variance to get the standard deviation). Then the function should compute and return <em>α</em>⊗(<em>X</em> - μ)/(σ + ε) + <em>β</em>, where ⊗ represents itemwise multiplication (<code>*</code>) and ε is a smoothing term (small constant to avoid division by zero, e.g., 0.001).</em></p>
<div id="cell-333" class="cell" data-execution_count="266">
<div class="sourceCode cell-code" id="cb435"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb435-1"><a href="#cb435-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> LayerNormalization(keras.layers.Layer):</span>
<span id="cb435-2"><a href="#cb435-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, eps<span class="op">=</span><span class="fl">0.001</span>, <span class="op">**</span>kwargs):</span>
<span id="cb435-3"><a href="#cb435-3" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>(<span class="op">**</span>kwargs)</span>
<span id="cb435-4"><a href="#cb435-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.eps <span class="op">=</span> eps</span>
<span id="cb435-5"><a href="#cb435-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb435-6"><a href="#cb435-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> build(<span class="va">self</span>, batch_input_shape):</span>
<span id="cb435-7"><a href="#cb435-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.alpha <span class="op">=</span> <span class="va">self</span>.add_weight(</span>
<span id="cb435-8"><a href="#cb435-8" aria-hidden="true" tabindex="-1"></a>            name<span class="op">=</span><span class="st">"alpha"</span>, shape<span class="op">=</span>batch_input_shape[<span class="op">-</span><span class="dv">1</span>:],</span>
<span id="cb435-9"><a href="#cb435-9" aria-hidden="true" tabindex="-1"></a>            initializer<span class="op">=</span><span class="st">"ones"</span>)</span>
<span id="cb435-10"><a href="#cb435-10" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.beta <span class="op">=</span> <span class="va">self</span>.add_weight(</span>
<span id="cb435-11"><a href="#cb435-11" aria-hidden="true" tabindex="-1"></a>            name<span class="op">=</span><span class="st">"beta"</span>, shape<span class="op">=</span>batch_input_shape[<span class="op">-</span><span class="dv">1</span>:],</span>
<span id="cb435-12"><a href="#cb435-12" aria-hidden="true" tabindex="-1"></a>            initializer<span class="op">=</span><span class="st">"zeros"</span>)</span>
<span id="cb435-13"><a href="#cb435-13" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().build(batch_input_shape) <span class="co"># must be at the end</span></span>
<span id="cb435-14"><a href="#cb435-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb435-15"><a href="#cb435-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> call(<span class="va">self</span>, X):</span>
<span id="cb435-16"><a href="#cb435-16" aria-hidden="true" tabindex="-1"></a>        mean, variance <span class="op">=</span> tf.nn.moments(X, axes<span class="op">=-</span><span class="dv">1</span>, keepdims<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb435-17"><a href="#cb435-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.alpha <span class="op">*</span> (X <span class="op">-</span> mean) <span class="op">/</span> (tf.sqrt(variance <span class="op">+</span> <span class="va">self</span>.eps)) <span class="op">+</span> <span class="va">self</span>.beta</span>
<span id="cb435-18"><a href="#cb435-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb435-19"><a href="#cb435-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> compute_output_shape(<span class="va">self</span>, batch_input_shape):</span>
<span id="cb435-20"><a href="#cb435-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> batch_input_shape</span>
<span id="cb435-21"><a href="#cb435-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb435-22"><a href="#cb435-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get_config(<span class="va">self</span>):</span>
<span id="cb435-23"><a href="#cb435-23" aria-hidden="true" tabindex="-1"></a>        base_config <span class="op">=</span> <span class="bu">super</span>().get_config()</span>
<span id="cb435-24"><a href="#cb435-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {<span class="op">**</span>base_config, <span class="st">"eps"</span>: <span class="va">self</span>.eps}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note that making <em>ε</em> a hyperparameter (<code>eps</code>) was not compulsory. Also note that it’s preferable to compute <code>tf.sqrt(variance + self.eps)</code> rather than <code>tf.sqrt(variance) + self.eps</code>. Indeed, the derivative of sqrt(z) is undefined when z=0, so training will bomb whenever the variance vector has at least one component equal to 0. Adding <em>ε</em> within the square root guarantees that this will never happen.</p>
</section>
<section id="c." class="level3">
<h3 class="anchored" data-anchor-id="c.">c.</h3>
<p><em>Exercise: Ensure that your custom layer produces the same (or very nearly the same) output as the <code>keras.layers.LayerNormalization</code> layer.</em></p>
<p>Let’s create one instance of each class, apply them to some data (e.g., the training set), and ensure that the difference is negligeable.</p>
<div id="cell-337" class="cell" data-execution_count="267">
<div class="sourceCode cell-code" id="cb436"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb436-1"><a href="#cb436-1" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> X_train.astype(np.float32)</span>
<span id="cb436-2"><a href="#cb436-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb436-3"><a href="#cb436-3" aria-hidden="true" tabindex="-1"></a>custom_layer_norm <span class="op">=</span> LayerNormalization()</span>
<span id="cb436-4"><a href="#cb436-4" aria-hidden="true" tabindex="-1"></a>keras_layer_norm <span class="op">=</span> keras.layers.LayerNormalization()</span>
<span id="cb436-5"><a href="#cb436-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb436-6"><a href="#cb436-6" aria-hidden="true" tabindex="-1"></a>tf.reduce_mean(keras.losses.mean_absolute_error(</span>
<span id="cb436-7"><a href="#cb436-7" aria-hidden="true" tabindex="-1"></a>    keras_layer_norm(X), custom_layer_norm(X)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="267">
<pre><code>&lt;tf.Tensor: shape=(), dtype=float32, numpy=5.6045884e-08&gt;</code></pre>
</div>
</div>
<p>Yep, that’s close enough. To be extra sure, let’s make alpha and beta completely random and compare again:</p>
<div id="cell-339" class="cell" data-execution_count="268">
<div class="sourceCode cell-code" id="cb438"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb438-1"><a href="#cb438-1" aria-hidden="true" tabindex="-1"></a>random_alpha <span class="op">=</span> np.random.rand(X.shape[<span class="op">-</span><span class="dv">1</span>])</span>
<span id="cb438-2"><a href="#cb438-2" aria-hidden="true" tabindex="-1"></a>random_beta <span class="op">=</span> np.random.rand(X.shape[<span class="op">-</span><span class="dv">1</span>])</span>
<span id="cb438-3"><a href="#cb438-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb438-4"><a href="#cb438-4" aria-hidden="true" tabindex="-1"></a>custom_layer_norm.set_weights([random_alpha, random_beta])</span>
<span id="cb438-5"><a href="#cb438-5" aria-hidden="true" tabindex="-1"></a>keras_layer_norm.set_weights([random_alpha, random_beta])</span>
<span id="cb438-6"><a href="#cb438-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb438-7"><a href="#cb438-7" aria-hidden="true" tabindex="-1"></a>tf.reduce_mean(keras.losses.mean_absolute_error(</span>
<span id="cb438-8"><a href="#cb438-8" aria-hidden="true" tabindex="-1"></a>    keras_layer_norm(X), custom_layer_norm(X)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="268">
<pre><code>&lt;tf.Tensor: shape=(), dtype=float32, numpy=2.2921004e-08&gt;</code></pre>
</div>
</div>
<p>Still a negligeable difference! Our custom layer works fine.</p>
</section>
</section>
<section id="train-a-model-using-a-custom-training-loop-to-tackle-the-fashion-mnist-dataset" class="level2">
<h2 class="anchored" data-anchor-id="train-a-model-using-a-custom-training-loop-to-tackle-the-fashion-mnist-dataset">13. Train a model using a custom training loop to tackle the Fashion MNIST dataset</h2>
<p><em>The Fashion MNIST dataset was introduced in Chapter 10.</em></p>
<section id="a.-1" class="level3">
<h3 class="anchored" data-anchor-id="a.-1">a.</h3>
<p><em>Exercise: Display the epoch, iteration, mean training loss, and mean accuracy over each epoch (updated at each iteration), as well as the validation loss and accuracy at the end of each epoch.</em></p>
<div id="cell-343" class="cell" data-execution_count="269">
<div class="sourceCode cell-code" id="cb440"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb440-1"><a href="#cb440-1" aria-hidden="true" tabindex="-1"></a>(X_train_full, y_train_full), (X_test, y_test) <span class="op">=</span> keras.datasets.fashion_mnist.load_data()</span>
<span id="cb440-2"><a href="#cb440-2" aria-hidden="true" tabindex="-1"></a>X_train_full <span class="op">=</span> X_train_full.astype(np.float32) <span class="op">/</span> <span class="fl">255.</span></span>
<span id="cb440-3"><a href="#cb440-3" aria-hidden="true" tabindex="-1"></a>X_valid, X_train <span class="op">=</span> X_train_full[:<span class="dv">5000</span>], X_train_full[<span class="dv">5000</span>:]</span>
<span id="cb440-4"><a href="#cb440-4" aria-hidden="true" tabindex="-1"></a>y_valid, y_train <span class="op">=</span> y_train_full[:<span class="dv">5000</span>], y_train_full[<span class="dv">5000</span>:]</span>
<span id="cb440-5"><a href="#cb440-5" aria-hidden="true" tabindex="-1"></a>X_test <span class="op">=</span> X_test.astype(np.float32) <span class="op">/</span> <span class="fl">255.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-344" class="cell" data-execution_count="270">
<div class="sourceCode cell-code" id="cb441"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb441-1"><a href="#cb441-1" aria-hidden="true" tabindex="-1"></a>keras.backend.clear_session()</span>
<span id="cb441-2"><a href="#cb441-2" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">42</span>)</span>
<span id="cb441-3"><a href="#cb441-3" aria-hidden="true" tabindex="-1"></a>tf.random.set_seed(<span class="dv">42</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-345" class="cell" data-execution_count="271">
<div class="sourceCode cell-code" id="cb442"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb442-1"><a href="#cb442-1" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> keras.models.Sequential([</span>
<span id="cb442-2"><a href="#cb442-2" aria-hidden="true" tabindex="-1"></a>    keras.layers.Flatten(input_shape<span class="op">=</span>[<span class="dv">28</span>, <span class="dv">28</span>]),</span>
<span id="cb442-3"><a href="#cb442-3" aria-hidden="true" tabindex="-1"></a>    keras.layers.Dense(<span class="dv">100</span>, activation<span class="op">=</span><span class="st">"relu"</span>),</span>
<span id="cb442-4"><a href="#cb442-4" aria-hidden="true" tabindex="-1"></a>    keras.layers.Dense(<span class="dv">10</span>, activation<span class="op">=</span><span class="st">"softmax"</span>),</span>
<span id="cb442-5"><a href="#cb442-5" aria-hidden="true" tabindex="-1"></a>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-346" class="cell" data-execution_count="272">
<div class="sourceCode cell-code" id="cb443"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb443-1"><a href="#cb443-1" aria-hidden="true" tabindex="-1"></a>n_epochs <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb443-2"><a href="#cb443-2" aria-hidden="true" tabindex="-1"></a>batch_size <span class="op">=</span> <span class="dv">32</span></span>
<span id="cb443-3"><a href="#cb443-3" aria-hidden="true" tabindex="-1"></a>n_steps <span class="op">=</span> <span class="bu">len</span>(X_train) <span class="op">//</span> batch_size</span>
<span id="cb443-4"><a href="#cb443-4" aria-hidden="true" tabindex="-1"></a>optimizer <span class="op">=</span> keras.optimizers.Nadam(learning_rate<span class="op">=</span><span class="fl">0.01</span>)</span>
<span id="cb443-5"><a href="#cb443-5" aria-hidden="true" tabindex="-1"></a>loss_fn <span class="op">=</span> keras.losses.sparse_categorical_crossentropy</span>
<span id="cb443-6"><a href="#cb443-6" aria-hidden="true" tabindex="-1"></a>mean_loss <span class="op">=</span> keras.metrics.Mean()</span>
<span id="cb443-7"><a href="#cb443-7" aria-hidden="true" tabindex="-1"></a>metrics <span class="op">=</span> [keras.metrics.SparseCategoricalAccuracy()]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-347" class="cell" data-execution_count="273">
<div class="sourceCode cell-code" id="cb444"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb444-1"><a href="#cb444-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> trange(<span class="dv">1</span>, n_epochs <span class="op">+</span> <span class="dv">1</span>, desc<span class="op">=</span><span class="st">"All epochs"</span>) <span class="im">as</span> epochs:</span>
<span id="cb444-2"><a href="#cb444-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> epoch <span class="kw">in</span> epochs:</span>
<span id="cb444-3"><a href="#cb444-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> trange(<span class="dv">1</span>, n_steps <span class="op">+</span> <span class="dv">1</span>, desc<span class="op">=</span><span class="st">"Epoch </span><span class="sc">{}</span><span class="st">/</span><span class="sc">{}</span><span class="st">"</span>.<span class="bu">format</span>(epoch, n_epochs)) <span class="im">as</span> steps:</span>
<span id="cb444-4"><a href="#cb444-4" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> step <span class="kw">in</span> steps:</span>
<span id="cb444-5"><a href="#cb444-5" aria-hidden="true" tabindex="-1"></a>                X_batch, y_batch <span class="op">=</span> random_batch(X_train, y_train)</span>
<span id="cb444-6"><a href="#cb444-6" aria-hidden="true" tabindex="-1"></a>                <span class="cf">with</span> tf.GradientTape() <span class="im">as</span> tape:</span>
<span id="cb444-7"><a href="#cb444-7" aria-hidden="true" tabindex="-1"></a>                    y_pred <span class="op">=</span> model(X_batch)</span>
<span id="cb444-8"><a href="#cb444-8" aria-hidden="true" tabindex="-1"></a>                    main_loss <span class="op">=</span> tf.reduce_mean(loss_fn(y_batch, y_pred))</span>
<span id="cb444-9"><a href="#cb444-9" aria-hidden="true" tabindex="-1"></a>                    loss <span class="op">=</span> tf.add_n([main_loss] <span class="op">+</span> model.losses)</span>
<span id="cb444-10"><a href="#cb444-10" aria-hidden="true" tabindex="-1"></a>                gradients <span class="op">=</span> tape.gradient(loss, model.trainable_variables)</span>
<span id="cb444-11"><a href="#cb444-11" aria-hidden="true" tabindex="-1"></a>                optimizer.apply_gradients(<span class="bu">zip</span>(gradients, model.trainable_variables))</span>
<span id="cb444-12"><a href="#cb444-12" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> variable <span class="kw">in</span> model.variables:</span>
<span id="cb444-13"><a href="#cb444-13" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> variable.constraint <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb444-14"><a href="#cb444-14" aria-hidden="true" tabindex="-1"></a>                        variable.assign(variable.constraint(variable))                    </span>
<span id="cb444-15"><a href="#cb444-15" aria-hidden="true" tabindex="-1"></a>                status <span class="op">=</span> OrderedDict()</span>
<span id="cb444-16"><a href="#cb444-16" aria-hidden="true" tabindex="-1"></a>                mean_loss(loss)</span>
<span id="cb444-17"><a href="#cb444-17" aria-hidden="true" tabindex="-1"></a>                status[<span class="st">"loss"</span>] <span class="op">=</span> mean_loss.result().numpy()</span>
<span id="cb444-18"><a href="#cb444-18" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> metric <span class="kw">in</span> metrics:</span>
<span id="cb444-19"><a href="#cb444-19" aria-hidden="true" tabindex="-1"></a>                    metric(y_batch, y_pred)</span>
<span id="cb444-20"><a href="#cb444-20" aria-hidden="true" tabindex="-1"></a>                    status[metric.name] <span class="op">=</span> metric.result().numpy()</span>
<span id="cb444-21"><a href="#cb444-21" aria-hidden="true" tabindex="-1"></a>                steps.set_postfix(status)</span>
<span id="cb444-22"><a href="#cb444-22" aria-hidden="true" tabindex="-1"></a>            y_pred <span class="op">=</span> model(X_valid)</span>
<span id="cb444-23"><a href="#cb444-23" aria-hidden="true" tabindex="-1"></a>            status[<span class="st">"val_loss"</span>] <span class="op">=</span> np.mean(loss_fn(y_valid, y_pred))</span>
<span id="cb444-24"><a href="#cb444-24" aria-hidden="true" tabindex="-1"></a>            status[<span class="st">"val_accuracy"</span>] <span class="op">=</span> np.mean(keras.metrics.sparse_categorical_accuracy(</span>
<span id="cb444-25"><a href="#cb444-25" aria-hidden="true" tabindex="-1"></a>                tf.constant(y_valid, dtype<span class="op">=</span>np.float32), y_pred))</span>
<span id="cb444-26"><a href="#cb444-26" aria-hidden="true" tabindex="-1"></a>            steps.set_postfix(status)</span>
<span id="cb444-27"><a href="#cb444-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> metric <span class="kw">in</span> [mean_loss] <span class="op">+</span> metrics:</span>
<span id="cb444-28"><a href="#cb444-28" aria-hidden="true" tabindex="-1"></a>            metric.reset_states()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"901e5649b50840538874aed5bab0d4ed","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"2f29690a5ade4bd8a6d164d106ba2d31","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"c2ea6579132c48c087c7f59e6309387a","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"94fa1527062c4cf7a277a548bbddc855","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"dbcfc9a0c4b64151a18cf27080872dd3","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"fc3831d9b98e488c837ba9644bf4b94a","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
</div>
</section>
<section id="b.-1" class="level3">
<h3 class="anchored" data-anchor-id="b.-1">b.</h3>
<p><em>Exercise: Try using a different optimizer with a different learning rate for the upper layers and the lower layers.</em></p>
<div id="cell-349" class="cell" data-execution_count="274">
<div class="sourceCode cell-code" id="cb445"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb445-1"><a href="#cb445-1" aria-hidden="true" tabindex="-1"></a>keras.backend.clear_session()</span>
<span id="cb445-2"><a href="#cb445-2" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">42</span>)</span>
<span id="cb445-3"><a href="#cb445-3" aria-hidden="true" tabindex="-1"></a>tf.random.set_seed(<span class="dv">42</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-350" class="cell" data-execution_count="275">
<div class="sourceCode cell-code" id="cb446"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb446-1"><a href="#cb446-1" aria-hidden="true" tabindex="-1"></a>lower_layers <span class="op">=</span> keras.models.Sequential([</span>
<span id="cb446-2"><a href="#cb446-2" aria-hidden="true" tabindex="-1"></a>    keras.layers.Flatten(input_shape<span class="op">=</span>[<span class="dv">28</span>, <span class="dv">28</span>]),</span>
<span id="cb446-3"><a href="#cb446-3" aria-hidden="true" tabindex="-1"></a>    keras.layers.Dense(<span class="dv">100</span>, activation<span class="op">=</span><span class="st">"relu"</span>),</span>
<span id="cb446-4"><a href="#cb446-4" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb446-5"><a href="#cb446-5" aria-hidden="true" tabindex="-1"></a>upper_layers <span class="op">=</span> keras.models.Sequential([</span>
<span id="cb446-6"><a href="#cb446-6" aria-hidden="true" tabindex="-1"></a>    keras.layers.Dense(<span class="dv">10</span>, activation<span class="op">=</span><span class="st">"softmax"</span>),</span>
<span id="cb446-7"><a href="#cb446-7" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb446-8"><a href="#cb446-8" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> keras.models.Sequential([</span>
<span id="cb446-9"><a href="#cb446-9" aria-hidden="true" tabindex="-1"></a>    lower_layers, upper_layers</span>
<span id="cb446-10"><a href="#cb446-10" aria-hidden="true" tabindex="-1"></a>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-351" class="cell" data-execution_count="276">
<div class="sourceCode cell-code" id="cb447"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb447-1"><a href="#cb447-1" aria-hidden="true" tabindex="-1"></a>lower_optimizer <span class="op">=</span> keras.optimizers.SGD(learning_rate<span class="op">=</span><span class="fl">1e-4</span>)</span>
<span id="cb447-2"><a href="#cb447-2" aria-hidden="true" tabindex="-1"></a>upper_optimizer <span class="op">=</span> keras.optimizers.Nadam(learning_rate<span class="op">=</span><span class="fl">1e-3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-352" class="cell" data-execution_count="277">
<div class="sourceCode cell-code" id="cb448"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb448-1"><a href="#cb448-1" aria-hidden="true" tabindex="-1"></a>n_epochs <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb448-2"><a href="#cb448-2" aria-hidden="true" tabindex="-1"></a>batch_size <span class="op">=</span> <span class="dv">32</span></span>
<span id="cb448-3"><a href="#cb448-3" aria-hidden="true" tabindex="-1"></a>n_steps <span class="op">=</span> <span class="bu">len</span>(X_train) <span class="op">//</span> batch_size</span>
<span id="cb448-4"><a href="#cb448-4" aria-hidden="true" tabindex="-1"></a>loss_fn <span class="op">=</span> keras.losses.sparse_categorical_crossentropy</span>
<span id="cb448-5"><a href="#cb448-5" aria-hidden="true" tabindex="-1"></a>mean_loss <span class="op">=</span> keras.metrics.Mean()</span>
<span id="cb448-6"><a href="#cb448-6" aria-hidden="true" tabindex="-1"></a>metrics <span class="op">=</span> [keras.metrics.SparseCategoricalAccuracy()]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-353" class="cell" data-execution_count="278">
<div class="sourceCode cell-code" id="cb449"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb449-1"><a href="#cb449-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> trange(<span class="dv">1</span>, n_epochs <span class="op">+</span> <span class="dv">1</span>, desc<span class="op">=</span><span class="st">"All epochs"</span>) <span class="im">as</span> epochs:</span>
<span id="cb449-2"><a href="#cb449-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> epoch <span class="kw">in</span> epochs:</span>
<span id="cb449-3"><a href="#cb449-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> trange(<span class="dv">1</span>, n_steps <span class="op">+</span> <span class="dv">1</span>, desc<span class="op">=</span><span class="st">"Epoch </span><span class="sc">{}</span><span class="st">/</span><span class="sc">{}</span><span class="st">"</span>.<span class="bu">format</span>(epoch, n_epochs)) <span class="im">as</span> steps:</span>
<span id="cb449-4"><a href="#cb449-4" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> step <span class="kw">in</span> steps:</span>
<span id="cb449-5"><a href="#cb449-5" aria-hidden="true" tabindex="-1"></a>                X_batch, y_batch <span class="op">=</span> random_batch(X_train, y_train)</span>
<span id="cb449-6"><a href="#cb449-6" aria-hidden="true" tabindex="-1"></a>                <span class="cf">with</span> tf.GradientTape(persistent<span class="op">=</span><span class="va">True</span>) <span class="im">as</span> tape:</span>
<span id="cb449-7"><a href="#cb449-7" aria-hidden="true" tabindex="-1"></a>                    y_pred <span class="op">=</span> model(X_batch)</span>
<span id="cb449-8"><a href="#cb449-8" aria-hidden="true" tabindex="-1"></a>                    main_loss <span class="op">=</span> tf.reduce_mean(loss_fn(y_batch, y_pred))</span>
<span id="cb449-9"><a href="#cb449-9" aria-hidden="true" tabindex="-1"></a>                    loss <span class="op">=</span> tf.add_n([main_loss] <span class="op">+</span> model.losses)</span>
<span id="cb449-10"><a href="#cb449-10" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> layers, optimizer <span class="kw">in</span> ((lower_layers, lower_optimizer),</span>
<span id="cb449-11"><a href="#cb449-11" aria-hidden="true" tabindex="-1"></a>                                          (upper_layers, upper_optimizer)):</span>
<span id="cb449-12"><a href="#cb449-12" aria-hidden="true" tabindex="-1"></a>                    gradients <span class="op">=</span> tape.gradient(loss, layers.trainable_variables)</span>
<span id="cb449-13"><a href="#cb449-13" aria-hidden="true" tabindex="-1"></a>                    optimizer.apply_gradients(<span class="bu">zip</span>(gradients, layers.trainable_variables))</span>
<span id="cb449-14"><a href="#cb449-14" aria-hidden="true" tabindex="-1"></a>                <span class="kw">del</span> tape</span>
<span id="cb449-15"><a href="#cb449-15" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> variable <span class="kw">in</span> model.variables:</span>
<span id="cb449-16"><a href="#cb449-16" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> variable.constraint <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb449-17"><a href="#cb449-17" aria-hidden="true" tabindex="-1"></a>                        variable.assign(variable.constraint(variable))                    </span>
<span id="cb449-18"><a href="#cb449-18" aria-hidden="true" tabindex="-1"></a>                status <span class="op">=</span> OrderedDict()</span>
<span id="cb449-19"><a href="#cb449-19" aria-hidden="true" tabindex="-1"></a>                mean_loss(loss)</span>
<span id="cb449-20"><a href="#cb449-20" aria-hidden="true" tabindex="-1"></a>                status[<span class="st">"loss"</span>] <span class="op">=</span> mean_loss.result().numpy()</span>
<span id="cb449-21"><a href="#cb449-21" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> metric <span class="kw">in</span> metrics:</span>
<span id="cb449-22"><a href="#cb449-22" aria-hidden="true" tabindex="-1"></a>                    metric(y_batch, y_pred)</span>
<span id="cb449-23"><a href="#cb449-23" aria-hidden="true" tabindex="-1"></a>                    status[metric.name] <span class="op">=</span> metric.result().numpy()</span>
<span id="cb449-24"><a href="#cb449-24" aria-hidden="true" tabindex="-1"></a>                steps.set_postfix(status)</span>
<span id="cb449-25"><a href="#cb449-25" aria-hidden="true" tabindex="-1"></a>            y_pred <span class="op">=</span> model(X_valid)</span>
<span id="cb449-26"><a href="#cb449-26" aria-hidden="true" tabindex="-1"></a>            status[<span class="st">"val_loss"</span>] <span class="op">=</span> np.mean(loss_fn(y_valid, y_pred))</span>
<span id="cb449-27"><a href="#cb449-27" aria-hidden="true" tabindex="-1"></a>            status[<span class="st">"val_accuracy"</span>] <span class="op">=</span> np.mean(keras.metrics.sparse_categorical_accuracy(</span>
<span id="cb449-28"><a href="#cb449-28" aria-hidden="true" tabindex="-1"></a>                tf.constant(y_valid, dtype<span class="op">=</span>np.float32), y_pred))</span>
<span id="cb449-29"><a href="#cb449-29" aria-hidden="true" tabindex="-1"></a>            steps.set_postfix(status)</span>
<span id="cb449-30"><a href="#cb449-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> metric <span class="kw">in</span> [mean_loss] <span class="op">+</span> metrics:</span>
<span id="cb449-31"><a href="#cb449-31" aria-hidden="true" tabindex="-1"></a>            metric.reset_states()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"7e81cf85cf7548748ec760afcbd71aa2","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"475109b927d044a7bba030f234c67838","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"af0a22afae4f47359f8fdfbac96e38bb","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"5519ec96e42f4281987a84a5434a0734","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"ed04f31b3a7d4b3b9a0cd63b644e2ed5","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"bfc4b1b4d40f4003ab8a3140a68ec883","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
</div>
</section>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      return note.innerHTML;
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>